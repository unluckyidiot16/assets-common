<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½°ë“œ ë§Œë“¤ê¸° (ê°€ì ¸ì˜¤ê¸° & í‚¤ì»¤)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .card {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            user-select: none;
        }
        .card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .card.face-down {
            background-color: #4b5563; /* gray-600 */
        }
        .player-hand .card {
            cursor: pointer;
        }
        .player-area.active {
            background-color: #fef9c3; /* yellow-100 */
            border-color: #facc15; /* yellow-400 */
        }
        .modal-backdrop {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; } to { opacity: 1; }
        }
        .open-quads .card {
            width: 3rem; height: 4rem; font-size: 1rem;
        }
        #discard-log-area {
            max-height: 128px; /* 8rem */
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-2 md:p-4">

<div id="game-container" class="w-full max-w-4xl bg-white rounded-2xl shadow-xl p-4 md:p-6 text-center">

    <!-- ê²Œì„ ì‹œì‘ í™”ë©´ -->
    <div id="start-screen">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">ì½°ë“œ ë§Œë“¤ê¸°</h1>
        <p class="text-gray-500 mb-8">ìš´ì„ ê¸°ìˆ ë¡œ ë°”ê¾¸ëŠ” ì¹´ë“œ ê²Œì„</p>
        <div class="max-w-sm mx-auto">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">ë‚œì´ë„ ì„ íƒ</h2>
            <div class="space-y-3">
                <button class="difficulty-btn w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition" data-difficulty="4">ì–´ë ¤ì›€ (36ì¥)</button>
                <button class="difficulty-btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition" data-difficulty="5">ë³´í†µ (45ì¥)</button>
                <button class="difficulty-btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition" data-difficulty="6">ì‰¬ì›€ (54ì¥)</button>
            </div>
        </div>
        <div class="mt-8 p-4 bg-gray-50 rounded-lg text-left text-sm text-gray-600 max-w-lg mx-auto">
            <h3 class="font-bold mb-2 text-center text-base">ê²Œì„ ê·œì¹™ ğŸ’¡</h3>
            <p><strong>ëª©í‘œ:</strong> ê°™ì€ ìˆ«ì 4ì¥(ì½°ë“œ) + ì•„ë¬´ ìˆ«ì 1ì¥(í‚¤ì»¤)ì„ ê°€ì¥ ë¨¼ì € ë§Œë“œì„¸ìš”.</p>
            <p><strong>í„´:</strong> ë±ì´ë‚˜ ë²„ë ¤ì§„ ì¹´ë“œ ë”ë¯¸ì—ì„œ 1ì¥ì„ ê°€ì ¸ì˜¨ í›„, ì†ì—ì„œ 1ì¥ì„ ë²„ë¦½ë‹ˆë‹¤.</p>
            <p><strong>ê°€ì ¸ì˜¤ê¸°(í˜¸ì¶œ):</strong> ë‹¤ë¥¸ ì‚¬ëŒì´ ë²„ë¦° ì¹´ë“œë¡œ ì½°ë“œë¥¼ ì™„ì„±í•  ìˆ˜ ìˆë‹¤ë©´, ì¦‰ì‹œ 'ê°€ì ¸ì˜¤ê¸°'ë¥¼ ì™¸ì³ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>
        </div>
    </div>

    <!-- ê²Œì„ ì§„í–‰ í™”ë©´ -->
    <div id="game-screen" class="hidden">
        <!-- ìƒëŒ€ í”Œë ˆì´ì–´ ì˜ì—­ -->
        <div id="opponents-area" class="flex justify-around mb-4 space-x-2 md:space-x-4">
            <!-- ë´‡ í”Œë ˆì´ì–´ UI ìƒì„± ìœ„ì¹˜ -->
        </div>

        <!-- í…Œì´ë¸” ì¤‘ì•™ ì˜ì—­ -->
        <div id="table-area" class="flex justify-center items-center my-4 md:my-8 h-32 space-x-4 md:space-x-8">
            <div id="deck-pile" class="w-24 h-32 card face-down flex items-center justify-center text-white font-bold cursor-pointer relative">
                <span>ë±</span>
                <span id="deck-count" class="absolute bottom-1 right-1 text-xs bg-black bg-opacity-50 px-1 rounded"></span>
            </div>
            <div id="discard-pile" class="w-24 h-32 relative">
                <!-- ë²„ë ¤ì§„ ì¹´ë“œ í‘œì‹œ ìœ„ì¹˜ -->
            </div>
            <div class="w-48 h-32 bg-gray-100 rounded-lg p-2 text-left">
                <h4 class="font-bold text-sm border-b pb-1 mb-1">ë²„ë¦° íŒ¨ ë¡œê·¸</h4>
                <div id="discard-log-area" class="text-xs space-y-1">
                    <!-- ë¡œê·¸ ë‚´ìš© -->
                </div>
            </div>
        </div>

        <!-- í”Œë ˆì´ì–´ ì˜ì—­ -->
        <div id="player-area-human" class="player-area p-4 bg-gray-50 border-2 border-transparent rounded-lg">
            <div class="flex justify-between items-center mb-2">
                <div class="text-left">
                    <h2 class="font-bold text-lg">í”Œë ˆì´ì–´ (ë‚˜)</h2>
                    <div class="text-sm">ì ìˆ˜: <span id="player-score-human" class="font-semibold">0</span></div>
                    <div id="player-d-info-human" class="text-sm text-blue-600 font-bold"></div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="declare-d-btn" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 transition">d ì„ ì–¸</button>
                </div>
            </div>
            <div id="player-open-quads-human" class="open-quads flex justify-center items-center mb-2 h-16"></div>
            <div id="player-hand-human" class="player-hand flex justify-center space-x-2">
                <!-- í”Œë ˆì´ì–´ ì¹´ë“œ ìƒì„± ìœ„ì¹˜ -->
            </div>
        </div>
        <div id="game-message" class="mt-4 font-semibold text-indigo-600 h-6"></div>
    </div>
</div>

<!-- ëª¨ë‹¬ ì°½ë“¤ -->
<div id="d-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
    <div class="bg-white rounded-lg p-6 w-full max-w-xs text-center">
        <h2 class="text-xl font-bold mb-4">d ë³´ë„ˆìŠ¤ ì„ ì–¸</h2>
        <p class="text-sm text-gray-600 mb-4">ì´ë²ˆ ë¼ìš´ë“œì— ë„ì „í•  dê°’(2~9)ì„ ì…ë ¥í•˜ì„¸ìš”. (ë¼ìš´ë“œë‹¹ 1íšŒ)</p>
        <input type="number" id="d-input" min="2" max="9" class="w-full border-2 border-gray-300 p-2 rounded text-center text-lg focus:border-blue-500 focus:ring-0">
        <div class="flex justify-center space-x-4 mt-4">
            <button id="confirm-d-btn" class="bg-blue-500 text-white px-6 py-2 rounded-md">í™•ì¸</button>
            <button id="cancel-d-btn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="take-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
    <div class="bg-white rounded-lg p-6 w-full max-w-xs text-center">
        <h2 class="text-2xl font-bold mb-2 text-yellow-500">ê°€ì ¸ì˜¤ê¸°!</h2>
        <p class="text-gray-700 mb-4">ë²„ë ¤ì§„ ì¹´ë“œë¡œ ì½°ë“œë¥¼ ì™„ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div id="take-card-display" class="flex justify-center mb-4"></div>
        <div class="flex justify-center space-x-4 mt-4">
            <button id="confirm-take-btn" class="bg-yellow-500 text-white px-6 py-2 rounded-md">ê°€ì ¸ì˜¤ê¸°</button>
            <button id="cancel-take-btn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md">íŒ¨ìŠ¤</button>
        </div>
    </div>
</div>

<div id="round-end-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
    <div class="bg-white rounded-lg p-6 w-full max-w-md text-center">
        <h2 id="round-end-title" class="text-3xl font-bold mb-4">ë¼ìš´ë“œ ì¢…ë£Œ!</h2>
        <div id="round-winner-info" class="mb-4"></div>
        <div id="score-details" class="text-left bg-gray-50 p-4 rounded-md space-y-2 mb-6"></div>
        <button id="next-round-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg">ë‹¤ìŒ ë¼ìš´ë“œ</button>
    </div>
</div>

<script>
    // --- ê²Œì„ ì„¤ì • ---
    const PLAYER_COUNT = 3;
    const BOT_NAMES = ["Bot Alpha", "Bot Bravo"];
    const HAND_SIZE = 5;
    const CARD_NUMBERS = [1, 2, 3, 4, 5, 6, 7, 8, 9];
    const SUITS_BASE = ['A', 'B', 'C', 'D', 'E', 'F'];

    // --- ê²Œì„ ìƒíƒœ ê´€ë¦¬ ---
    let gameState = {};

    function resetGameState() {
        gameState = {
            players: [],
            deck: [],
            discardPile: [],
            discardLog: [],
            currentTurnIndex: 0,
            gamePhase: 'setup',
            takeOpportunity: null,
            turnCounter: 0,
            difficulty: 4, // ê¸°ë³¸ê°’: ì–´ë ¤ì›€(4ì¥)
        };
    }

    // --- DOM ìš”ì†Œ ---
    const getEl = (id) => document.getElementById(id);
    const startScreen = getEl('start-screen');
    const gameScreen = getEl('game-screen');
    const deckPile = getEl('deck-pile');
    const discardPileDiv = getEl('discard-pile');
    const gameMessage = getEl('game-message');

    // --- ë Œë”ë§ í•¨ìˆ˜ ---
    function renderCard(card, faceUp = true) {
        const isFaceDown = !faceUp || !card;
        const value = card ? card.value : '';
        const bgColor = isFaceDown ? 'bg-gray-700' : 'bg-white';
        const textColor = isFaceDown ? 'text-transparent' : 'text-gray-800';
        return `
        <div class="card w-20 h-28 ${bgColor} border-2 border-gray-300 rounded-lg flex items-center justify-center text-3xl font-bold ${textColor}" data-value="${value}">
            ${value}
        </div>
    `;
    }

    function renderSmallCard(value) {
        return `<div class="card w-12 h-16 bg-white border-2 border-gray-300 rounded-md flex items-center justify-center text-lg font-bold" data-value="${value}">${value}</div>`;
    }

    function renderDiscardLog() {
        const logArea = getEl('discard-log-area');
        logArea.innerHTML = gameState.discardLog
            .map(entry => `<div><span class="font-semibold">${entry.playerName}</span> â†’ <span class="font-bold text-red-600">${entry.cardValue}</span></div>`)
            .reverse()
            .join('');
        logArea.scrollTop = 0;
    }

    function renderAll() {
        const opponentsArea = getEl('opponents-area');
        opponentsArea.innerHTML = '';
        gameState.players.forEach((player, index) => {
            if (index === 0) return;

            let openQuadsHTML = player.openQuads.map(q => renderSmallCard(q.value).repeat(4)).join('');

            opponentsArea.innerHTML += `
            <div id="player-area-${index}" class="player-area flex-1 p-3 bg-gray-50 border-2 border-transparent rounded-lg">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="font-bold">${player.name}</h2>
                        <div class="text-sm">ì ìˆ˜: <span class="font-semibold">${player.score}</span></div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg">${player.hand.length} ì¥</div>
                    </div>
                </div>
                <div id="player-open-quads-${index}" class="open-quads flex justify-center items-center mt-2 h-16 gap-1">${openQuadsHTML}</div>
            </div>
        `;
        });

        getEl('deck-count').textContent = gameState.deck.length;
        discardPileDiv.innerHTML = renderCard(gameState.discardPile[gameState.discardPile.length - 1]);
        renderDiscardLog();

        const humanPlayer = gameState.players[0];
        getEl('player-score-human').textContent = humanPlayer.score;
        const handDiv = getEl('player-hand-human');
        handDiv.innerHTML = humanPlayer.hand.map(card => renderCard(card)).join('');

        let openQuadsHTML = humanPlayer.openQuads.map(q => renderSmallCard(q.value).repeat(4)).join('');
        getEl('player-open-quads-human').innerHTML = openQuadsHTML;

        const dInfo = getEl('player-d-info-human');
        if (humanPlayer.declaredD) {
            dInfo.textContent = `ì„ ì–¸í•œ d = ${humanPlayer.declaredD}`;
            getEl('declare-d-btn').disabled = true;
        } else {
            dInfo.textContent = '';
            getEl('declare-d-btn').disabled = false;
        }

        document.querySelectorAll('.player-area').forEach(el => el.classList.remove('active'));
        if (gameState.gamePhase !== 'round-over') {
            const activeArea = getEl(`player-area-${gameState.currentTurnIndex === 0 ? 'human' : gameState.currentTurnIndex}`);
            if(activeArea) activeArea.classList.add('active');
        }
    }

    // --- ê²Œì„ ë¡œì§ ---
    function createDeck(difficulty) {
        const deck = [];
        const suits = SUITS_BASE.slice(0, difficulty);
        CARD_NUMBERS.forEach(num => {
            suits.forEach(suit => {
                deck.push({ value: num, id: `${num}-${suit}` });
            });
        });
        return deck;
    }

    function shuffleDeck(deck) {
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
        return deck;
    }

    function checkWinCondition(hand, openQuads) {
        if (hand.length === HAND_SIZE && openQuads.length === 0) {
            const counts = {};
            hand.forEach(card => { counts[card.value] = (counts[card.value] || 0) + 1; });
            let quadValue = null, kickerValue = null;
            for (const value in counts) {
                if (counts[value] === 4) quadValue = parseInt(value);
                else if (counts[value] === 1) kickerValue = parseInt(value);
            }
            if (quadValue !== null && kickerValue !== null) {
                return { isWin: true, quadValue, kickerValue, type: 'closed' };
            }
        }

        if (hand.length === 1 && openQuads.length === 1) {
            return { isWin: true, quadValue: openQuads[0].value, kickerValue: hand[0].value, type: 'open' };
        }

        return { isWin: false };
    }

    function calculateScores(winnerIndex) {
        const winner = gameState.players[winnerIndex];
        let scoreDetailsHTML = '';
        const winInfo = checkWinCondition(winner.hand, winner.openQuads);
        if (!winInfo.isWin) return;
        let totalScore = 0;
        const baseScore = winInfo.quadValue * 2 + 5;
        totalScore += baseScore;
        scoreDetailsHTML += `<div class="p-2 rounded-md bg-white"><strong>${winner.name} (ìŠ¹ì)</strong>`;
        scoreDetailsHTML += `<p>ê¸°ë³¸ ì ìˆ˜ (ì½°ë“œ ${winInfo.quadValue} Ã— 2 + 5): <span class="font-bold text-green-600">+${baseScore}</span></p>`;
        if (winInfo.kickerValue <= 4) {
            const kickerBonus = 5 - winInfo.kickerValue;
            totalScore += kickerBonus;
            scoreDetailsHTML += `<p>í‚¤ì»¤ ë³´ë„ˆìŠ¤ (5 - ${winInfo.kickerValue}): <span class="font-bold text-green-600">+${kickerBonus}</span></p>`;
        }
        if (winner.declaredD && (winInfo.quadValue - winInfo.kickerValue) % winner.declaredD === 0) {
            totalScore += 4;
            scoreDetailsHTML += `<p>d ë³´ë„ˆìŠ¤ ((${winInfo.quadValue} - ${winInfo.kickerValue}) % ${winner.declaredD} == 0): <span class="font-bold text-green-600">+4</span></p>`;
        }
        if (winInfo.type === 'closed') {
            totalScore += 2;
            scoreDetailsHTML += `<p>í´ë¡œì¦ˆë“œ ë³´ë„ˆìŠ¤ (ë¹„ê³µê°œ ì™„ì„±): <span class="font-bold text-green-600">+2</span></p>`;
        }
        if (winner.turnCount <= 3) {
            totalScore += 2;
            scoreDetailsHTML += `<p>ìŠ¤í”¼ë“œ ë³´ë„ˆìŠ¤ (3í„´ ì´ë‚´ ì™„ì„±): <span class="font-bold text-green-600">+2</span></p>`;
        }
        winner.score += totalScore;
        scoreDetailsHTML += `</div>`;
        gameState.players.forEach((player, index) => {
            if (index === winnerIndex) return;
            const counts = {};
            player.hand.forEach(card => { counts[card.value] = (counts[card.value] || 0) + 1; });
            let compensation = 0;
            let reason = "ë³´ìƒ ì—†ìŒ";
            if (Object.values(counts).includes(3)) {
                compensation = 2;
                reason = "íŠ¸ë¦¬í”Œ ë³´ìœ ";
            } else if (Object.values(counts).includes(2)) {
                compensation = 1;
                reason = "í˜ì–´ ë³´ìœ ";
            }
            player.score += compensation;
            scoreDetailsHTML += `<div class="p-2 rounded-md bg-white mt-1"><strong>${player.name}</strong>`;
            scoreDetailsHTML += `<p>${reason}: <span class="font-bold text-blue-600">+${compensation}</span></p></div>`;
        });
        getEl('score-details').innerHTML = scoreDetailsHTML;
    }

    function startRound() {
        gameState.deck = shuffleDeck(createDeck(gameState.difficulty));
        gameState.discardPile = [];
        gameState.discardLog = [];
        gameState.turnCounter = 0;
        gameState.players.forEach(player => {
            player.hand = gameState.deck.splice(0, HAND_SIZE);
            player.openQuads = [];
            player.declaredD = null;
            player.turnCount = 0;
        });
        gameState.discardPile.push(gameState.deck.pop());
        const firstDiscard = gameState.discardPile[0];
        gameState.discardLog.push({ playerName: "ì‹œìŠ¤í…œ", cardValue: firstDiscard.value });
        gameState.currentTurnIndex = 0;
        executeTurn();
    }

    function advanceTurn() {
        gameState.currentTurnIndex = (gameState.currentTurnIndex + 1) % PLAYER_COUNT;
        if (gameState.currentTurnIndex === 0) {
            gameState.turnCounter++;
            gameState.players[0].turnCount++;
        }
        executeTurn();
    }

    function executeTurn() {
        renderAll();
        const currentPlayer = gameState.players[gameState.currentTurnIndex];
        if (currentPlayer.isBot) {
            gameMessage.textContent = `${currentPlayer.name}ì˜ í„´ì…ë‹ˆë‹¤...`;
            setTimeout(executeBotTurn, 1500);
        } else {
            gameMessage.textContent = "ì¹´ë“œë¥¼ ë“œë¡œìš°í•˜ì„¸ìš” (ë± ë˜ëŠ” ë²„ë¦° ì¹´ë“œ).";
            gameState.gamePhase = 'player-draw';
        }
    }

    function handleDraw(source) {
        if (gameState.gamePhase !== 'player-draw' || gameState.currentTurnIndex !== 0) return;
        const player = gameState.players[0];
        if (source === 'deck') {
            if (gameState.deck.length === 0) {
                if (gameState.discardPile.length > 1) {
                    const topCard = gameState.discardPile.pop();
                    gameState.deck = shuffleDeck(gameState.discardPile);
                    gameState.discardPile = [topCard];
                    gameMessage.textContent = "ë±ì„ ì…”í”Œí•©ë‹ˆë‹¤.";
                } else {
                    gameMessage.textContent = "ë±ì— ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.";
                    return;
                }
            }
            player.hand.push(gameState.deck.pop());
        } else if (source === 'discard') {
            player.hand.push(gameState.discardPile.pop());
        }
        gameState.gamePhase = 'player-discard';
        gameMessage.textContent = "ë²„ë¦´ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.";
        renderAll();
    }

    function handleDiscard(cardValue) {
        if (gameState.gamePhase !== 'player-discard' || gameState.currentTurnIndex !== 0) return;
        const player = gameState.players[0];
        const cardIndex = player.hand.findIndex(card => card.value === cardValue);
        if (cardIndex === -1) return;

        const [discardedCard] = player.hand.splice(cardIndex, 1);

        if (checkWinCondition(player.hand, player.openQuads).isWin) {
            gameState.discardPile.push(discardedCard);
            gameState.discardLog.push({ playerName: player.name, cardValue: discardedCard.value });
            handleRoundEnd(0);
            return;
        }

        gameState.discardPile.push(discardedCard);
        gameState.discardLog.push({ playerName: player.name, cardValue: discardedCard.value });
        gameState.gamePhase = 'post-discard-check';
        checkForTake(discardedCard);
    }

    function checkForTake(discardedCard) {
        let takeFound = false;
        for (let i = 0; i < PLAYER_COUNT; i++) {
            if (i === gameState.currentTurnIndex) continue;
            const player = gameState.players[i];
            const counts = {};
            player.hand.forEach(c => { counts[c.value] = (counts[c.value] || 0) + 1; });
            if (counts[discardedCard.value] === 3) {
                gameState.takeOpportunity = { playerIndex: i, card: discardedCard };
                if (player.isBot) {
                    gameMessage.textContent = `${player.name}ì´(ê°€) 'ê°€ì ¸ì˜¤ê¸°'ë¥¼ ì™¸ì³¤ìŠµë‹ˆë‹¤!`;
                    setTimeout(() => handleTake(true), 1500);
                } else {
                    getEl('take-card-display').innerHTML = renderCard(discardedCard);
                    getEl('take-modal').classList.remove('hidden');
                }
                takeFound = true;
                break;
            }
        }
        if (!takeFound) {
            advanceTurn();
        }
    }

    function handleTake(isConfirm) {
        const { playerIndex, card } = gameState.takeOpportunity;
        const player = gameState.players[playerIndex];
        getEl('take-modal').classList.add('hidden');
        gameState.takeOpportunity = null;
        if (!isConfirm) {
            if (playerIndex === 0) { advanceTurn(); }
            return;
        }
        const takenCard = gameState.discardPile.pop();
        player.hand = player.hand.filter(c => c.value !== takenCard.value);
        player.openQuads.push({ value: takenCard.value });
        if(checkWinCondition(player.hand, player.openQuads).isWin) {
            handleRoundEnd(playerIndex);
            return;
        }
        gameState.currentTurnIndex = playerIndex;
        renderAll();
        if (player.isBot) {
            gameMessage.textContent = `${player.name}ì´(ê°€) ë²„ë¦´ ì¹´ë“œë¥¼ ì„ íƒ ì¤‘...`;
            setTimeout(() => {
                const cardToDiscard = getBotDiscardChoice(player.hand);
                const cardIndex = player.hand.findIndex(c => c.id === cardToDiscard.id);
                const [discardedCard] = player.hand.splice(cardIndex, 1);
                gameState.discardPile.push(discardedCard);
                gameState.discardLog.push({ playerName: player.name, cardValue: discardedCard.value });
                checkForTake(discardedCard);
            }, 1500);
        } else {
            gameState.gamePhase = 'player-discard';
            gameMessage.textContent = "ì¹´ë“œë¥¼ ê°€ì ¸ì™”ìœ¼ë¯€ë¡œ, ë²„ë¦´ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.";
        }
    }

    function handleRoundEnd(winnerIndex) {
        gameState.gamePhase = 'round-over';
        const winner = gameState.players[winnerIndex];
        getEl('round-end-title').textContent = `${winner.name}ì˜ ìŠ¹ë¦¬!`;
        calculateScores(winnerIndex);
        renderAll();
        setTimeout(() => getEl('round-end-modal').classList.remove('hidden'), 500);
    }

    function getBotDiscardChoice(hand) {
        const counts = {};
        hand.forEach(c => { counts[c.value] = (counts[c.value] || 0) + 1 });
        let singleCards = [];
        for (const card of hand) {
            if (counts[card.value] === 1) { singleCards.push(card); }
        }
        if (singleCards.length > 0) {
            return singleCards.sort((a, b) => b.value - a.value)[0];
        }
        return hand.sort((a,b) => a.value - b.value)[0];
    }

    function executeBotTurn() {
        const bot = gameState.players[gameState.currentTurnIndex];
        bot.turnCount++;
        const discardTop = gameState.discardPile[gameState.discardPile.length - 1];
        const counts = {};
        bot.hand.forEach(c => { counts[c.value] = (counts[c.value] || 0) + 1; });
        let drawnCard;
        if (discardTop && counts[discardTop.value] >= 2) {
            drawnCard = gameState.discardPile.pop();
        } else {
            drawnCard = gameState.deck.pop();
        }
        bot.hand.push(drawnCard);
        setTimeout(() => {
            const cardToDiscard = getBotDiscardChoice(bot.hand);
            const cardIndex = bot.hand.findIndex(c => c.id === cardToDiscard.id);
            const [discardedCard] = bot.hand.splice(cardIndex, 1);

            if(checkWinCondition(bot.hand, bot.openQuads).isWin) {
                gameState.discardPile.push(discardedCard);
                gameState.discardLog.push({ playerName: bot.name, cardValue: discardedCard.value });
                handleRoundEnd(gameState.currentTurnIndex);
                return;
            }

            gameState.discardPile.push(discardedCard);
            gameState.discardLog.push({ playerName: bot.name, cardValue: discardedCard.value });
            checkForTake(discardedCard);
        }, 1000);
    }

    function initGame(difficulty) {
        resetGameState();
        gameState.difficulty = difficulty;
        gameState.players.push({ name: "í”Œë ˆì´ì–´", isBot: false, score: 0, hand: [], openQuads: [] });
        BOT_NAMES.forEach(name => {
            gameState.players.push({ name: name, isBot: true, score: 0, hand: [], openQuads: [] });
        });
        startScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        startRound();
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    document.querySelectorAll('.difficulty-btn').forEach(button => {
        button.addEventListener('click', () => {
            const difficulty = parseInt(button.dataset.difficulty);
            initGame(difficulty);
        });
    });

    deckPile.addEventListener('click', () => handleDraw('deck'));
    discardPileDiv.addEventListener('click', () => handleDraw('discard'));
    getEl('player-hand-human').addEventListener('click', (e) => {
        const cardDiv = e.target.closest('.card');
        if (cardDiv && cardDiv.dataset.value) {
            handleDiscard(parseInt(cardDiv.dataset.value));
        }
    });
    getEl('declare-d-btn').addEventListener('click', () => {
        getEl('d-modal').classList.remove('hidden');
    });
    getEl('cancel-d-btn').addEventListener('click', () => {
        getEl('d-modal').classList.add('hidden');
    });
    getEl('confirm-d-btn').addEventListener('click', () => {
        const dValue = parseInt(getEl('d-input').value);
        if (dValue >= 2 && dValue <= 9) {
            gameState.players[0].declaredD = dValue;
            getEl('d-modal').classList.add('hidden');
            renderAll();
        } else {
            alert("2ì—ì„œ 9 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        }
    });

    getEl('next-round-btn').addEventListener('click', () => {
        getEl('round-end-modal').classList.add('hidden');
        startRound();
    });
    getEl('confirm-take-btn').addEventListener('click', () => handleTake(true));
    getEl('cancel-take-btn').addEventListener('click', () => handleTake(false));
</script>

</body>
</html>

