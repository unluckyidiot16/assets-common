<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê°¯ë²Œ íƒì‚¬ëŒ€</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      touch-action: manipulation;
    }
    .tile {
      width: 100%;
      height: 100%;
      aspect-ratio: 1 / 1;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .tile-hidden {
      background-color: #d2b48c;
      border: 2px solid #a08464;
    }
    .tile-hidden:hover {
      background-color: #e0c8a6;
    }
    .tile-revealed {
      background-color: #f5deb3;
      border: 1px solid #d2b48c;
      font-weight: bold;
      font-size: 1.5rem;
    }
    .tile-creature {
      animation: pop-in 0.3s ease-out;
      padding: 2px;
    }
    @keyframes pop-in {
      0% { transform: scale(0.5); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .color-1 { color: #1e90ff; }
    .color-2 { color: #32cd32; }
    .color-3 { color: #ff4500; }
    .color-4 { color: #4b0082; }
    .color-5 { color: #a0522d; }
    .color-6 { color: #00ced1; }
    .color-7 { color: #000000; }
    .color-8 { color: #808080; }
    .modal {
      animation: fade-in 0.3s ease-out;
    }
    @keyframes fade-in {
      0% { opacity: 0; transform: translateY(-20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .shovel-active {
      box-shadow: 0 0 20px 5px rgba(255, 223, 186, 0.9);
      transform: scale(1.05);
    }
    .dot-pattern { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 2px; width: 80%; height: 80%; }
    .dot { width: 6px; height: 6px; background-color: currentColor; border-radius: 50%; }

    /* ë„ê° ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card {
      background-color: #4a5568;
      border: 2px solid #718096;
      transition: transform 0.2s;
    }
    .card-locked {
      background-color: #2d3748;
      color: #a0aec0;
    }
    .card:not(.card-locked):hover {
      transform: scale(1.05);
      border-color: #a0aec0;
    }
  </style>
</head>
<body class="bg-slate-800 text-white flex flex-col items-center justify-center min-h-screen p-4">

<div id="game-container" class="w-full max-w-2xl mx-auto hidden">
  <!-- ìƒë‹¨ ì •ë³´ UI -->
  <header class="bg-slate-700 p-4 rounded-t-lg shadow-lg">
    <div class="flex justify-between items-center text-lg md:text-xl">
      <div id="stage-name" class="font-bold"></div>
      <div class="flex space-x-4 md:space-x-6">
        <div class="flex items-center"><span class="text-yellow-400 mr-2">ğŸ–±ï¸</span><span id="clicks-left"></span></div>
        <div class="flex items-center"><span id="creature-icon" class="mr-2 h-8 w-8 flex items-center justify-center"></span><span id="creatures-left"></span></div>
        <div class="flex items-center"><span class="text-xl mr-2">ğŸš</span><span id="shovels-left"></span></div>
      </div>
    </div>
  </header>

  <!-- ê²Œì„ ë³´ë“œ -->
  <main id="game-board" class="bg-amber-100 p-2 md:p-4 rounded-b-lg shadow-lg grid gap-1"></main>

  <!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ UI -->
  <footer class="mt-4 flex justify-between items-center w-full">
    <button id="shovel-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center">
      <img src="https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/trowel.png" alt="ì¡°ê°œì‚½ ì•„ì´ì½˜" class="h-12 w-12 object-contain">
      <div class="ml-2 text-left leading-tight"><span class="block font-semibold">ì¡°ê°œì‚½</span><span class="block text-sm">ì‚¬ìš©</span></div>
    </button>
    <div class="flex items-center space-x-2"><label for="dot-pattern-toggle" class="text-sm cursor-pointer">ì  íŒ¨í„´</label><input type="checkbox" id="dot-pattern-toggle" class="form-checkbox h-5 w-5 text-blue-600 rounded"></div>
  </footer>
</div>

<!-- ì‹œì‘ í™”ë©´ -->
<div id="start-screen" class="text-center">
  <h1 class="text-5xl font-bold mb-4">ê°¯ë²Œ íƒì‚¬ëŒ€</h1>
  <p class="text-slate-300 mb-8">ê°¯ë²Œì— ìˆ¨ì–´ìˆëŠ” ìƒë¬¼ë“¤ì„ ì°¾ì•„ë³´ì„¸ìš”!</p>
  <div class="space-y-4">
    <button id="start-game-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-10 rounded-lg shadow-lg text-xl transition-transform transform hover:scale-105">ê²Œì„ ì‹œì‘</button>
    <button id="encyclopedia-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-10 rounded-lg shadow-lg text-xl transition-transform transform hover:scale-105">ë„ê° ë³´ê¸°</button>
  </div>
</div>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="result-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
  <div class="modal bg-slate-700 rounded-lg p-8 max-w-lg w-full">
    <h2 id="result-title" class="text-4xl font-bold text-center mb-4"></h2>
    <div id="result-stars" class="text-5xl text-center mb-6"></div>
    <div class="grid grid-cols-2 gap-4 text-lg mb-6">
      <p><strong>ğŸ… ì ìˆ˜:</strong> <span id="result-score"></span></p>
      <p><strong>ğŸ¯ ì •í™•ë„:</strong> <span id="result-accuracy"></span></p>
      <p><strong>ğŸ–±ï¸ ë‚¨ì€ í´ë¦­:</strong> <span id="result-clicks"></span></p>
      <p><strong>ğŸ”¥ ìµœëŒ€ ì½¤ë³´:</strong> <span id="result-combo"></span></p>
    </div>
    <div id="new-unlocks-container" class="hidden"><h3 class="text-xl font-bold text-center mb-2">âœ¨ ì—…ì  ë‹¬ì„±! ìƒˆë¡œìš´ ìƒë¬¼ ë°œê²¬!</h3><div id="new-unlocks" class="flex justify-center"></div></div>
    <div class="flex justify-center space-x-4 mt-8">
      <button id="restart-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">ë‹¤ì‹œí•˜ê¸°</button>
      <button id="next-stage-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">ë‹¤ìŒ</button>
      <button id="main-menu-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">ë©”ì¸ìœ¼ë¡œ</button>
    </div>
  </div>
</div>

<!-- ë„ê° ëª¨ë‹¬ -->
<div id="encyclopedia-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 p-4 sm:p-8 z-50 overflow-y-auto">
  <div class="relative max-w-4xl mx-auto">
    <h2 class="text-4xl font-bold text-center mb-6">ìƒë¬¼ ë„ê°</h2>
    <div id="encyclopedia-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      <!-- JSë¡œ ì¹´ë“œ ìƒì„± -->
    </div>
    <button id="close-encyclopedia-btn" class="absolute top-0 right-0 bg-red-600 hover:bg-red-700 text-white font-bold rounded-full h-10 w-10 flex items-center justify-center text-2xl">&times;</button>
  </div>
</div>

<script>
  const game = {
    // --- DOM ìš”ì†Œ ---
    elements: {
      gameContainer: document.getElementById('game-container'),
      startScreen: document.getElementById('start-screen'),
      board: document.getElementById('game-board'),
      stageName: document.getElementById('stage-name'),
      clicksLeft: document.getElementById('clicks-left'),
      creaturesLeft: document.getElementById('creatures-left'),
      shovelsLeft: document.getElementById('shovels-left'),
      creatureIcon: document.getElementById('creature-icon'),
      shovelButton: document.getElementById('shovel-button'),
      dotPatternToggle: document.getElementById('dot-pattern-toggle'),
      resultModal: document.getElementById('result-modal'),
      resultTitle: document.getElementById('result-title'),
      resultStars: document.getElementById('result-stars'),
      resultScore: document.getElementById('result-score'),
      resultAccuracy: document.getElementById('result-accuracy'),
      resultClicks: document.getElementById('result-clicks'),
      resultCombo: document.getElementById('result-combo'),
      newUnlocksContainer: document.getElementById('new-unlocks-container'),
      newUnlocks: document.getElementById('new-unlocks'),
      restartBtn: document.getElementById('restart-btn'),
      nextStageBtn: document.getElementById('next-stage-btn'),
      mainMenuBtn: document.getElementById('main-menu-btn'),
      startGameBtn: document.getElementById('start-game-btn'),
      encyclopediaBtn: document.getElementById('encyclopedia-btn'),
      encyclopediaModal: document.getElementById('encyclopedia-modal'),
      encyclopediaGrid: document.getElementById('encyclopedia-grid'),
      closeEncyclopediaBtn: document.getElementById('close-encyclopedia-btn'),
    },

    // --- ê²Œì„ ì„¤ì • ë° ë°ì´í„° ---
    config: {
      stages: [
        { id: "1-1", name: "ë°”ì§€ë½ ë°­", width: 8, height: 8, specimens: 8, clicksLimit: 30, shellShovel: 1, creatureId: 'bajirak' },
        { id: "1-2", name: "ê°¯ì§€ë ì´ êµ´", width: 8, height: 8, specimens: 10, clicksLimit: 30, shellShovel: 1, creatureId: 'mudworm' },
        { id: "1-3", name: "ë‹¬íŒ½ì´ ì–¸ë•", width: 9, height: 9, specimens: 12, clicksLimit: 32, shellShovel: 1, creatureId: 'mudSnail' },
        { id: "1-4", name: "ì‘ì€ ê²Œ êµ°ë½", width: 9, height: 9, specimens: 14, clicksLimit: 34, shellShovel: 2, creatureId: 'smallCrab' },
        { id: "1-5", name: "ëŒ€í•© ì„œì‹ì§€", width: 10, height: 10, specimens: 16, clicksLimit: 36, shellShovel: 2, creatureId: 'daehap' },
        { id: "1-6", name: "ë§ë‘¥ì–´ ì›…ë©ì´", width: 10, height: 10, specimens: 18, clicksLimit: 40, shellShovel: 2, creatureId: 'mangdungeo' },
        { id: "1-7", name: "ë†ê²Œ ë§ˆì„", width: 11, height: 11, specimens: 20, clicksLimit: 45, shellShovel: 3, creatureId: 'nongge' },
        { id: "1-8", name: "ì§±ëš±ì–´ í„", width: 11, height: 11, specimens: 22, clicksLimit: 48, shellShovel: 3, creatureId: 'jjangddungeo' },
        { id: "1-9", name: "ì¹ ê²Œ í•´ë³€", width: 12, height: 12, specimens: 25, clicksLimit: 55, shellShovel: 3, creatureId: 'chilge' },
        { id: "1-10", name: "ë‚™ì§€ ë™êµ´", width: 12, height: 12, specimens: 28, clicksLimit: 60, shellShovel: 3, creatureId: 'nakji' }
      ],
      creatures: [
        { id: "bajirak", nameKo: "ë°”ì§€ë½", image: "https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/bajirak.png", desc: "ê°¯ë²Œì˜ ê°€ì¥ í”í•œ ì¡°ê°œë¡œ, í‘œë©´ì— ë°©ì‚¬ìƒ ë¬´ëŠ¬ê°€ ìˆìŠµë‹ˆë‹¤. ì¹¼êµ­ìˆ˜ë‚˜ ì°œ ìš”ë¦¬ì— ë§ì´ ì‚¬ìš©ë˜ì–´ ìš°ë¦¬ì—ê²Œ ì¹œìˆ™í•©ë‹ˆë‹¤." },
        { id: "mudworm", nameKo: "ê°¯ì§€ë ì´", image: "https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/mudworm.png", desc: "ê°¯ë²Œ í‡´ì ë¬¼ ì†ì— êµ´ì„ íŒŒê³  ì‚¬ëŠ” í™˜í˜•ë™ë¬¼ì…ë‹ˆë‹¤. ë‚šì‹œ ë¯¸ë¼ë¡œ ìœ ëª…í•˜ë©°, ê°¯ë²Œ ìƒíƒœê³„ì˜ ì¤‘ìš”í•œ ë¶„í•´ì ì—­í• ì„ í•©ë‹ˆë‹¤." },
        { id: "mudSnail", nameKo: "ê°¯ë²Œ ë‹¬íŒ½ì´", image: "https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/mudSnail.png", desc: "ê°¯ë²Œ í‘œë©´ì„ ê¸°ì–´ ë‹¤ë‹ˆë©° ìœ ê¸°ë¬¼ì„ ë¨¹ê³  ì‚½ë‹ˆë‹¤. ëŠë¦¿ëŠë¦¿ ì›€ì§ì´ë©° ê°¯ë²Œì„ ê¹¨ë—í•˜ê²Œ ë§Œë“œëŠ” ì²­ì†Œë¶€ì…ë‹ˆë‹¤." },
        { id: "smallCrab", nameKo: "ì‘ì€ ê²Œ", image: "https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/smallCrab.png", desc: "ê°¯ë²Œì—ëŠ” ì¹ ê²Œ, ë°©ê²Œ ë“± ë‹¤ì–‘í•œ ì‘ì€ ê²Œë“¤ì´ ì‚½ë‹ˆë‹¤. ì˜†ìœ¼ë¡œ ì¬ë¹ ë¥´ê²Œ ì›€ì§ì´ë©° ìˆ¨ëŠ” ëª¨ìŠµì´ ì¸ìƒì ì¸ ê°¯ë²Œì˜ ë¬´ë²•ìì…ë‹ˆë‹¤." },
        { id: "daehap", nameKo: "ëŒ€í•©", image: "https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/daehap.png", desc: "ë°”ì§€ë½ë³´ë‹¤ í¬ê³  ê»ë°ê¸°ê°€ ë‘êº¼ìš´ ì¡°ê°œì…ë‹ˆë‹¤. ê¹Šì€ ëª¨ë˜ ì†ì— ì„œì‹í•˜ë©°, ì‹œì›í•œ êµ­ë¬¼ ë§›ì´ ì¼í’ˆì´ë¼ íƒ• ìš”ë¦¬ì— ì œê²©ì…ë‹ˆë‹¤." },
        { id: "mangdungeo", nameKo: "ë§ë‘¥ì–´", image: "https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/mangdungeo.png", desc: "ê°¯ë²Œì˜ ë¬¼ì›…ë©ì´ì—ì„œ í”íˆ ë³´ì´ëŠ” ë¬¼ê³ ê¸°ì…ë‹ˆë‹¤. ê°€ìŠ´ì§€ëŠëŸ¬ë¯¸ë¥¼ ì´ìš©í•´ í„ ìœ„ë¥¼ ê¸°ì–´ ë‹¤ë‹ˆëŠ” ì‹ ê¸°í•œ ëŠ¥ë ¥ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤." },
        { id: "nongge", nameKo: "ë†ê²Œ", image: "https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/nongge.png", desc: "ìˆ˜ì»·ì˜ í•œìª½ ì§‘ê²Œë°œì´ ê±°ëŒ€í•œ ê²ƒì´ íŠ¹ì§•ì…ë‹ˆë‹¤. ì´ í° ì§‘ê²Œë°œì„ í”ë“¤ë©° ì•”ì»·ì—ê²Œ êµ¬ì• í•˜ê±°ë‚˜ ë‹¤ë¥¸ ìˆ˜ì»·ê³¼ ì‹¸ìš°ê¸°ë„ í•©ë‹ˆë‹¤." },
        { id: "jjangddungeo", nameKo: "ì§±ëš±ì–´", image: "https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/jjangddungeo.png", desc: "ë¨¸ë¦¬ ìœ„ë¡œ íˆ­ íŠ€ì–´ë‚˜ì˜¨ ëˆˆì´ ë§¤ë ¥ì ì¸ ë¬¼ê³ ê¸°ì…ë‹ˆë‹¤. í”¼ë¶€ë¡œë„ í˜¸í¡í•  ìˆ˜ ìˆì–´ ê°¯ë²Œ ìœ„ì—ì„œ ì˜¤ë«ë™ì•ˆ ëŒì•„ë‹¤ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
        { id: "chilge", nameKo: "ì¹ ê²Œ", image: "https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/chilge.png", desc: "ê°¯ë²Œì—ì„œ ê°€ì¥ í”í•˜ê²Œ ë³¼ ìˆ˜ ìˆëŠ” ê²Œ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ë“±ê»ì§ˆì— 7ê°œì˜ ì ì´ ìˆëŠ” ê²ƒì²˜ëŸ¼ ë³´ì—¬ ì¹ ê²Œë¼ëŠ” ì´ë¦„ì´ ë¶™ì—ˆìŠµë‹ˆë‹¤." },
        { id: "nakji", nameKo: "ë‚™ì§€", image: "https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/nakji.png", desc: "ê°¯ë²Œì˜ ëŒ í‹ˆì´ë‚˜ êµ´ì— ì‚¬ëŠ” ëŒ€í‘œì ì¸ ì—°ì²´ë™ë¬¼ì…ë‹ˆë‹¤. 'ì“°ëŸ¬ì§„ ì†Œë„ ì¼ìœ¼í‚¨ë‹¤'ëŠ” ë§ì´ ìˆì„ ì •ë„ë¡œ ìœ ëª…í•œ ë³´ì–‘ì‹ì…ë‹ˆë‹¤." }
      ],
    },

    // --- ê²Œì„ ìƒíƒœ ---
    state: {},
    playerData: {
      currentStageIndex: 0,
      unlockedCreatures: new Set(),
    },

    // --- ì´ˆê¸°í™” ---
    init() {
      this.loadPlayerData();
      this.bindEvents();
    },

    bindEvents() {
      this.elements.shovelButton.addEventListener('click', () => this.toggleShovelMode());
      this.elements.dotPatternToggle.addEventListener('change', () => this.renderBoard(false));
      this.elements.restartBtn.addEventListener('click', () => this.startStage(this.state.stageIndex));
      this.elements.nextStageBtn.addEventListener('click', () => this.startNextStage());
      this.elements.mainMenuBtn.addEventListener('click', () => this.showStartScreen());
      this.elements.startGameBtn.addEventListener('click', () => this.startStage(this.playerData.currentStageIndex));
      this.elements.encyclopediaBtn.addEventListener('click', () => this.showEncyclopedia());
      this.elements.closeEncyclopediaBtn.addEventListener('click', () => this.hideEncyclopedia());
    },

    // --- ë°ì´í„° ê´€ë¦¬ ---
    loadPlayerData() {
      const savedData = localStorage.getItem('tidal_flat_playerData');
      if (savedData) {
        const parsedData = JSON.parse(savedData);
        this.playerData.currentStageIndex = parsedData.currentStageIndex;
        this.playerData.unlockedCreatures = new Set(parsedData.unlockedCreatures);
      }
    },

    savePlayerData() {
      const dataToSave = {
        currentStageIndex: this.playerData.currentStageIndex,
        unlockedCreatures: Array.from(this.playerData.unlockedCreatures)
      };
      localStorage.setItem('tidal_flat_playerData', JSON.stringify(dataToSave));
    },

    // --- í™”ë©´ ì „í™˜ ---
    showStartScreen() {
      this.elements.resultModal.classList.add('hidden');
      this.elements.gameContainer.classList.add('hidden');
      this.elements.startScreen.classList.remove('hidden');
    },

    showEncyclopedia() {
      this.renderEncyclopedia();
      this.elements.encyclopediaModal.classList.remove('hidden');
    },

    hideEncyclopedia() {
      this.elements.encyclopediaModal.classList.add('hidden');
    },

    // --- ë„ê° ë Œë”ë§ ---
    renderEncyclopedia() {
      this.elements.encyclopediaGrid.innerHTML = '';
      this.config.creatures.forEach(creature => {
        const stage = this.config.stages.find(s => s.creatureId === creature.id);
        const isUnlocked = this.playerData.unlockedCreatures.has(creature.id);

        const card = document.createElement('div');
        card.className = `card rounded-lg p-4 text-center ${isUnlocked ? '' : 'card-locked'}`;

        if (isUnlocked) {
          card.innerHTML = `
                    <h3 class="text-xl font-bold mb-2">${creature.nameKo}</h3>
                    <img src="${creature.image}" alt="${creature.nameKo}" class="w-24 h-24 mx-auto object-contain bg-slate-600 rounded-full p-1 mb-3">
                    <p class="text-sm text-slate-300">${creature.desc}</p>
                `;
        } else {
          card.innerHTML = `
                    <h3 class="text-xl font-bold mb-2">?</h3>
                    <div class="w-24 h-24 mx-auto flex items-center justify-center bg-slate-800 rounded-full text-4xl font-bold mb-3">?</div>
                    <p class="text-sm"><strong>í•´ê¸ˆ ì¡°ê±´:</strong><br>Stage ${stage.id} í´ë¦¬ì–´</p>
                `;
        }
        this.elements.encyclopediaGrid.appendChild(card);
      });
    },

    // --- ê²Œì„ ì‹œì‘/ì¢…ë£Œ ---
    startStage(stageIndex) {
      if (stageIndex >= this.config.stages.length) {
        alert("ëª¨ë“  ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤! ì²« ìŠ¤í…Œì´ì§€ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.");
        stageIndex = 0;
        this.playerData.currentStageIndex = 0;
        this.savePlayerData();
      }

      this.elements.resultModal.classList.add('hidden');
      this.elements.startScreen.classList.add('hidden');
      this.elements.gameContainer.classList.remove('hidden');

      const stage = this.config.stages[stageIndex];
      const creature = this.config.creatures.find(c => c.id === stage.creatureId);

      this.state = { stageIndex, ...stage, boardData: [], revealed: new Set(), creaturesFound: 0, clicksMade: 0, clicksLeft: stage.clicksLimit, shovelsLeft: stage.shellShovel, score: 0, combo: 0, maxCombo: 0, isFirstClick: true, isShovelMode: false, isGameOver: false, isNewUnlock: false };

      this.elements.stageName.textContent = `Stage ${stage.id}: ${stage.name}`;
      this.elements.creatureIcon.innerHTML = `<img src="${creature.image}" alt="${creature.nameKo}" class="h-full w-full object-contain">`;

      this.generateBoard();
      this.renderBoard(true);
      this.updateStats();
    },

    startNextStage() {
      this.startStage(this.playerData.currentStageIndex);
    },

    endGame(isWin) {
      if (this.state.isGameOver) return;
      this.state.isGameOver = true;

      if (isWin) {
        const unlockedCreatureId = this.state.creatureId;
        if (!this.playerData.unlockedCreatures.has(unlockedCreatureId)) {
          this.state.isNewUnlock = true;
          this.playerData.unlockedCreatures.add(unlockedCreatureId);
        }
        this.playerData.currentStageIndex = this.state.stageIndex + 1;
        this.savePlayerData();
      }

      // ì ìˆ˜ ê³„ì‚° ë° í‘œì‹œ
      const accuracy = this.state.clicksMade > 0 ? (this.state.creaturesFound / this.state.clicksMade * 100).toFixed(1) : 0;
      let finalScore = this.state.score;
      if (isWin) {
        finalScore += this.state.clicksLeft * 10;
        finalScore += this.state.shovelsLeft * 50;
      }

      let stars = 0;
      if(isWin) {
        stars++;
        if (accuracy >= 60) stars++;
        if (this.state.clicksLeft / this.state.clicksLimit >= 0.2) stars++;
      }

      this.elements.resultModal.classList.remove('hidden');
      this.elements.resultTitle.textContent = isWin ? "íƒì‚¬ ì„±ê³µ!" : "íƒì‚¬ ì‹¤íŒ¨...";
      this.elements.resultTitle.className = `text-4xl font-bold text-center mb-4 ${isWin ? 'text-yellow-300' : 'text-red-500'}`;
      this.elements.resultStars.innerHTML = 'â­'.repeat(stars) + 'â˜†'.repeat(3 - stars);
      this.elements.resultScore.textContent = finalScore;
      this.elements.resultAccuracy.textContent = `${accuracy}%`;
      this.elements.resultClicks.textContent = this.state.clicksLeft;
      this.elements.resultCombo.textContent = this.state.maxCombo;
      this.elements.nextStageBtn.style.display = isWin ? 'inline-block' : 'none';

      // ì‹ ê·œ í•´ê¸ˆ í‘œì‹œ
      if (this.state.isNewUnlock) {
        this.elements.newUnlocksContainer.classList.remove('hidden');
        const creatureData = this.config.creatures.find(c => c.id === this.state.creatureId);
        this.elements.newUnlocks.innerHTML = `<div class="bg-slate-600 p-2 rounded text-center"><img src="${creatureData.image}" alt="${creatureData.nameKo}" class="w-16 h-16 mx-auto object-contain mb-1"><div class="font-bold">${creatureData.nameKo}</div></div>`;
      } else {
        this.elements.newUnlocksContainer.classList.add('hidden');
      }
    },

    // --- ë³´ë“œ ìƒì„± ë° ë Œë”ë§ ---
    generateBoard() {
      // ... (ì´í•˜ ë™ì¼, ë³€ê²½ ì—†ìŒ)
      const { width, height, specimens, creatureId } = this.state;
      this.state.boardData = Array(height).fill(null).map(() => Array(width).fill(null).map(() => ({ creatureId: null, adjacent: 0 })));

      let placed = 0;
      while (placed < specimens) {
        const r = Math.floor(Math.random() * height);
        const c = Math.floor(Math.random() * width);
        if (!this.state.boardData[r][c].creatureId) {
          this.state.boardData[r][c].creatureId = creatureId;
          placed++;
        }
      }

      for (let r = 0; r < height; r++) {
        for (let c = 0; c < width; c++) {
          if (!this.state.boardData[r][c].creatureId) {
            let count = 0;
            this.getNeighbors(r, c).forEach(([nr, nc]) => {
              if (this.state.boardData[nr][nc].creatureId) {
                count++;
              }
            });
            this.state.boardData[r][c].adjacent = count;
          }
        }
      }
    },

    renderBoard(isInitial) {
      // ... (ì´í•˜ ë™ì¼, ë³€ê²½ ì—†ìŒ)
      this.elements.board.innerHTML = '';
      const { width } = this.state;
      this.elements.board.style.gridTemplateColumns = `repeat(${width}, 1fr)`;

      for (let r = 0; r < this.state.height; r++) {
        for (let c = 0; c < this.state.width; c++) {
          const tileEl = document.createElement('button');
          tileEl.className = 'tile rounded-md tile-hidden';
          tileEl.dataset.r = r;
          tileEl.dataset.c = c;

          const pos = `${r},${c}`;
          if (this.state.revealed.has(pos)) {
            this.updateTileAppearance(tileEl, r, c);
          }

          if (isInitial) {
            tileEl.addEventListener('click', () => this.onTileClick(r, c));
          }
          this.elements.board.appendChild(tileEl);
        }
      }
    },

    updateTileAppearance(tileEl, r, c) {
      // ... (ì´í•˜ ë™ì¼, ë³€ê²½ ì—†ìŒ)
      const cell = this.state.boardData[r][c];
      tileEl.disabled = true;
      tileEl.classList.remove('tile-hidden');
      tileEl.classList.add('tile-revealed');

      if (cell.creatureId) {
        const creature = this.config.creatures.find(cr => cr.id === cell.creatureId);
        tileEl.classList.add('tile-creature');
        tileEl.innerHTML = `<img src="${creature.image}" alt="${creature.nameKo}" class="w-full h-full object-contain">`;
      } else if (cell.adjacent > 0) {
        const useDotPattern = this.elements.dotPatternToggle.checked;
        if(useDotPattern) {
          const patternContainer = document.createElement('div');
          patternContainer.className = `dot-pattern color-${cell.adjacent}`;
          for(let i=0; i < cell.adjacent; i++) {
            const dot = document.createElement('div');
            dot.className = 'dot';
            patternContainer.appendChild(dot);
          }
          tileEl.appendChild(patternContainer);
        } else {
          tileEl.textContent = cell.adjacent;
          tileEl.classList.add(`color-${cell.adjacent}`);
        }
      }
    },

    // --- ê²Œì„ ë¡œì§ ---
    onTileClick(r, c) {
      // ... (ì´í•˜ ë™ì¼, ë³€ê²½ ì—†ìŒ)
      if (this.state.isGameOver || this.state.revealed.has(`${r},${c}`)) return;

      if (this.state.isShovelMode) {
        this.useShovel(r, c);
        return;
      }

      if (this.state.isFirstClick) {
        this.state.isFirstClick = false;
        if (this.state.boardData[r][c].creatureId) {
          this.moveCreature(r, c);
        }
      }

      this.revealTile(r, c);
      this.updateStats();
      this.checkGameStatus();
    },

    revealTile(r, c, isByShovel = false) {
      const pos = `${r},${c}`;
      if (this.state.revealed.has(pos)) return 0;

      this.state.revealed.add(pos);
      const cell = this.state.boardData[r][c];
      const tileEl = this.elements.board.querySelector(`[data-r='${r}'][data-c='${c}']`);
      this.updateTileAppearance(tileEl, r, c);

      if (!isByShovel) {
        this.state.clicksMade++;
        this.state.clicksLeft--;
      }

      if (cell.creatureId) {
        this.state.creaturesFound++;
        this.state.score += 100 + (this.state.combo * 20);
        this.state.combo++;
        if (this.state.combo > this.state.maxCombo) {
          this.state.maxCombo = this.state.combo;
        }
      } else {
        this.state.combo = 0;
      }

      return 1;
    },

    moveCreature(r, c) {
      let moved = false;
      const creatureId = this.state.boardData[r][c].creatureId;
      for (let newR = 0; newR < this.state.height; newR++) {
        for (let newC = 0; newC < this.state.width; newC++) {
          if (!this.state.boardData[newR][newC].creatureId) {
            this.state.boardData[r][c].creatureId = null;
            this.state.boardData[newR][newC].creatureId = creatureId;
            moved = true;
            break;
          }
        }
        if(moved) break;
      }
      this.recalculateNumbers();
    },

    recalculateNumbers() {
      for (let r = 0; r < this.state.height; r++) {
        for (let c = 0; c < this.state.width; c++) {
          if (!this.state.boardData[r][c].creatureId) {
            let count = 0;
            this.getNeighbors(r, c).forEach(([nr, nc]) => {
              if (this.state.boardData[nr][nc].creatureId) count++;
            });
            this.state.boardData[r][c].adjacent = count;
          }
        }
      }
    },

    toggleShovelMode() {
      if (this.state.isGameOver || this.state.shovelsLeft <= 0) return;
      this.state.isShovelMode = !this.state.isShovelMode;
      this.elements.shovelButton.classList.toggle('shovel-active', this.state.isShovelMode);
      this.elements.board.style.cursor = this.state.isShovelMode ? 'crosshair' : 'pointer';
    },

    useShovel(r, c) {
      this.state.shovelsLeft--;
      this.state.clicksLeft--;

      const area = this.getNeighbors(r, c);
      area.push([r, c]);

      area.forEach(([ar, ac]) => {
        const cell = this.state.boardData[ar][ac];
        if (!cell.creatureId) {
          this.revealTile(ar, ac, true);
        }
      });

      this.state.isShovelMode = false;
      this.elements.shovelButton.classList.remove('shovel-active');
      this.elements.board.style.cursor = 'pointer';

      this.updateStats();
      this.checkGameStatus();
    },

    checkGameStatus() {
      if (this.state.creaturesFound === this.state.specimens) {
        this.endGame(true);
      } else if (this.state.clicksLeft <= 0) {
        this.endGame(false);
      }
    },

    updateStats() {
      this.elements.clicksLeft.textContent = this.state.clicksLeft;
      this.elements.creaturesLeft.textContent = `${this.state.specimens - this.state.creaturesFound}/${this.state.specimens}`;
      this.elements.shovelsLeft.textContent = this.state.shovelsLeft;
      this.elements.shovelButton.disabled = this.state.shovelsLeft <= 0;
    },

    getNeighbors(r, c) {
      const neighbors = [];
      for (let dr = -1; dr <= 1; dr++) {
        for (let dc = -1; dc <= 1; dc++) {
          if (dr === 0 && dc === 0) continue;
          const nr = r + dr;
          const nc = c + dc;
          if (nr >= 0 && nr < this.state.height && nc >= 0 && nc < this.state.width) {
            neighbors.push([nr, nc]);
          }
        }
      }
      return neighbors;
    },
  };

  game.init();

</script>
</body>
</html>
