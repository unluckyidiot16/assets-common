<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ê°ì„  ì—­ì‚¬ ê³„ë‹¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì ìš© */
        body {
            font-family: "Inter", sans-serif;
            overscroll-behavior: none; /* ëª¨ë°”ì¼ì—ì„œ ë°”ìš´ìŠ¤ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        /* ìº”ë²„ìŠ¤ í”½ì…€ì´ íë¦¿í•´ì§€ì§€ ì•Šë„ë¡ ì„¤ì • */
        canvas {
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-color: #f0f4f8; /* ìº”ë²„ìŠ¤ ë°°ê²½ìƒ‰ */
        }
        /* ê²Œì„ ì˜¤ë²„ë ˆì´ */
        #game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        #game-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .skin-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            /* ë ˆì´ì•„ì›ƒì´ í”ë“¤ë¦¬ì§€ ì•Šë„ë¡ íˆ¬ëª…í•œ í…Œë‘ë¦¬ ì¶”ê°€ */
            border: 4px solid transparent;
            /* --- ì¶”ê°€ë¨: í•´ê¸ˆ ì•ˆ ëœ ìŠ¤í‚¨ ì²˜ë¦¬ --- */
            position: relative;
            background-color: #f3f4f6; /* gray-100 */
        }
        .skin-item.locked {
            filter: grayscale(80%) brightness(0.8);
            cursor: not-allowed;
        }
        .skin-item.locked::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            color: white;
            text-shadow: 0 0 5px black;
        }
        .skin-item img {
            width: 100%;
            height: 6rem; /* 96px */
            object-fit: contain;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 0.25rem; /* rounded */
        }
        .skin-item:hover {
            transform: scale(1.05);
        }
        /* --- ì¶”ê°€ë¨: ìŠ¤í‚¨ ì„ íƒ í•˜ì´ë¼ì´íŠ¸ --- */
        .skin-item.selected {
            border-color: #facc15; /* yellow-400 */
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(250, 204, 21, 0.3);
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col md:flex-row h-screen overflow-hidden">

<!-- ì™¼ìª½ ì‚¬ì´ë“œë°”: ì‹œëŒ€ ë° ìš´ì†¡ìˆ˜ë‹¨ ì •ë³´ -->
<aside class="w-full md:w-1/4 bg-gray-800 text-white p-6 overflow-y-auto shadow-lg">
    <h1 class="text-3xl font-bold mb-6">ì—­ì‚¬ ê³„ë‹¨</h1>

    <!-- í˜„ì¬ ì‹œëŒ€ -->
    <div class="mb-8">
        <h2 class="text-xl font-semibold mb-2">í˜„ì¬ ì‹œëŒ€</h2>
        <p id="year-display" class="text-4xl font-bold text-teal-300">1000ë…„</p>
        <p class="text-gray-400">(ì ìˆ˜: <span id="score-display">0</span>)</p>
    </div>

    <!-- í•´ê¸ˆëœ ìš´ì†¡ìˆ˜ë‹¨ -->
    <div>
        <h2 class="text-xl font-semibold mb-3">í•´ê¸ˆëœ ìš´ì†¡ìˆ˜ë‹¨</h2>
        <ul id="unlocked-list" class="space-y-2">
            <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì¶”ê°€ë¨ -->
        </ul>
    </div>
</aside>

<!-- ì˜¤ë¥¸ìª½ ë©”ì¸ ê²Œì„ ì˜ì—­ -->
<main class="w-full md:w-3/4 h-full bg-gray-200 relative" id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- ê²Œì„ ì˜¤ë²„ë ˆì´ (ì‹œì‘/ì¬ì‹œì‘) -->
    <div id="game-overlay" class="flex p-4">
        <h2 id="overlay-title" class="text-4xl font-bold mb-4">ëŒ€ê°ì„  ì—­ì‚¬ ê³„ë‹¨</h2>
        <p id="overlay-score" class="text-2xl mb-6 hidden"></p>

        <!-- --- ìˆ˜ì •ë¨: ìŠ¤í‚¨ ì„ íƒ ê·¸ë¦¬ë“œë¥¼ ë©”ë‰´ì— ì§ì ‘ ì‚½ì… --- -->
        <h3 class="text-xl font-semibold mb-4 text-white">ìŠ¤í‚¨ ì„ íƒ (ìµœê³  ì ìˆ˜: <span id="highest-score-display">0</span>)</h3>
        <div id="menu-skin-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 p-4 w-full max-w-3xl max-h-[50vh] overflow-y-auto bg-gray-900/50 rounded-lg mb-6">
            <!-- ìŠ¤í‚¨ ì•„ì´í…œì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <button id="start-button" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-md transition-transform transform hover:scale-105 mb-4">
            ê²Œì„ ì‹œì‘
        </button>
    </div>

</main>

<script>
    // --- DOM ìš”ì†Œ ---
    const gameContainer = document.getElementById('game-container');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const yearDisplay = document.getElementById('year-display');
    const scoreDisplay = document.getElementById('score-display');
    const unlockedList = document.getElementById('unlocked-list');
    const overlay = document.getElementById('game-overlay');
    const overlayTitle = document.getElementById('overlay-title');
    const overlayScore = document.getElementById('overlay-score');
    const startButton = document.getElementById('start-button');
    const menuSkinGrid = document.getElementById('menu-skin-grid');
    const highestScoreDisplay = document.getElementById('highest-score-display');


    // --- ê²Œì„ ì„¤ì • ---
    let gameStatus = 'menu'; // 'menu', 'playing', 'over'
    let score = 0;
    let currentYear = 1000;
    let highestScore = 0; // --- ì¶”ê°€ë¨: ìµœê³  ì ìˆ˜ ---

    // --- í”Œë ˆì´ì–´ ---
    const player = {
        width: 40, // ì´ë¯¸ì§€ê°€ ì˜ ë³´ì´ë„ë¡ í¬ê¸° ì¡°ì ˆ
        height: 40,
        imageElement: null, // --- ì¶”ê°€ë¨: í”Œë ˆì´ì–´ ì´ë¯¸ì§€ ---
        stairIndex: 0, // í˜„ì¬ ë°Ÿê³  ìˆëŠ” ê³„ë‹¨ ì¸ë±ìŠ¤
        x: 0, // í”Œë ˆì´ì–´ì˜ 'í™”ë©´' X ì¢Œí‘œ
        y: 0, // í”Œë ˆì´ì–´ì˜ 'í™”ë©´' Y ì¢Œí‘œ (ê³ ì •ë¨)
    };

    // --- ê³„ë‹¨ ---
    let stairs = [];
    const stairWidth = 80;
    const stairHeight = 20;
    const stepX = 50; // ëŒ€ê°ì„  X ê°„ê²©
    const stepY = 30; // ëŒ€ê°ì„  Y ê°„ê²© (ì˜¬ë¼ê°€ëŠ” ë†’ì´)
    const totalStairsToGenerate = 50; // ë¯¸ë¦¬ ìƒì„±í•´ ë‘˜ ê³„ë‹¨ ìˆ˜

    // --- ì¹´ë©”ë¼ (ì›”ë“œ ì˜¤í”„ì…‹) ---
    let worldY = 0;
    let targetWorldY = 0;
    const cameraLerpRate = 0.2;

    let targetPlayerX = 0;
    const playerLerpRate = 0.25;

    // --- íƒ€ì´ë¨¸ ---
    const maxTime = 1500; // 1.5ì´ˆ
    let timeRemaining = maxTime;
    let lastTime = 0;

    // --- ìš´ì†¡ìˆ˜ë‹¨ ë§ˆì¼ìŠ¤í†¤ (200ë…„/20ì  ê°„ê²© + ì´ë¯¸ì§€) ---
    const imageRoot = "https://unluckyidiot16.github.io/assets-common/HistoryStair/";
    const milestones = [
        { score: 0, year: 1000, name: "ê±·ê¸°", image: `${imageRoot}walk.png` },
        { score: 20, year: 1200, name: "ë§ˆì°¨", image: `${imageRoot}carriage.png` },
        { score: 40, year: 1400, name: "ì¦ê¸°ê¸°ê´€ì°¨", image: `${imageRoot}train_0.png` },
        { score: 60, year: 1600, name: "í´ë˜ì‹ ì¹´", image: `${imageRoot}car_1.png` },
        { score: 80, year: 1800, name: "íƒì‹œ", image: `${imageRoot}car_3.png` },
        { score: 100, year: 2000, name: "ë¹„í–‰ê¸°", image: `${imageRoot}airplane.png` },
        { score: 120, year: 2200, name: "ì „ì² ", image: `${imageRoot}train_1.png` },
        { score: 140, year: 2400, name: "ìš°ì£¼ì„ A", image: `${imageRoot}spaceship_1.png` },
        { score: 160, year: 2600, name: "ìš°ì£¼ì„ B", image: `${imageRoot}spaceship_2.png` },
        { score: 180, year: 2800, name: "ìš°ì£¼ê³ ì–‘ì´", image: `${imageRoot}Spacekitty.png` }
    ];
    let currentMilestoneIndex = 0;
    let selectedSkin = milestones[0];
    let preloadedImages = {}; // --- ì¶”ê°€ë¨: ì´ë¯¸ì§€ í”„ë¦¬ë¡œë”© ---

    // --- ì¶”ê°€ë¨: ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ í•¨ìˆ˜ ---
    function preloadImages() {
        milestones.forEach(m => {
            const img = new Image();
            img.src = m.image;
            preloadedImages[m.name] = img;
        });
        player.imageElement = preloadedImages[milestones[0].name]; // ê¸°ë³¸ ìŠ¤í‚¨ ì„¤ì •
    }

    // --- ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì ˆ ---
    function resizeCanvas() {
        const mainRect = gameContainer.getBoundingClientRect();
        // --- ìˆ˜ì •: ì˜¤ë²„ë ˆì´ í¬ê¸°ì— ë§ê²Œ ì¡°ì ˆ
        const overlayRect = overlay.getBoundingClientRect();
        // ì˜¤ë²„ë ˆì´ê°€ ìº”ë²„ìŠ¤ë¥¼ ë®ìœ¼ë¯€ë¡œ ì˜¤ë²„ë ˆì´ ê¸°ì¤€ìœ¼ë¡œ í¬ê¸° ì„¤ì •
        canvas.width = overlayRect.width;
        canvas.height = overlayRect.height;


        player.y = canvas.height * 0.75;

        if (gameStatus !== 'playing') {
            if (stairs.length > 0) {
                player.x = (canvas.width / 2) + stairs[player.stairIndex].x;
                targetPlayerX = player.x;
            } else {
                player.x = canvas.width / 2;
                targetPlayerX = player.x;
            }
            draw(); // í¬ê¸° ì¡°ì ˆ í›„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        }
    }

    // --- ê³„ë‹¨ ìƒì„± ---
    function generateNewStair() {
        const lastStair = stairs[stairs.length - 1]; // (N-1)ë²ˆì§¸ ê³„ë‹¨

        let newDir = lastStair.dir;

        // --- *** ìˆ˜ì •ë¨: ê³„ë‹¨ ì´íƒˆ ë°©ì§€ ë¡œì§ *** ---
        const horizontalLimit = stepX * 8; // ì¢Œìš° 8ì¹¸ (400px) ì œí•œ
        let forceTurn = false;

        if (lastStair.x > horizontalLimit && lastStair.dir === 'right') {
            newDir = 'left';
            forceTurn = true;
        } else if (lastStair.x < -horizontalLimit && lastStair.dir === 'left') {
            newDir = 'right';
            forceTurn = true;
        }

        let shouldTurn = false;
        if (forceTurn) {
            shouldTurn = true;
        } else {
            // ê¸°ì¡´ì˜ ëœë¤ í„´ ë¡œì§
            if (stairs.length > 3 &&
                stairs[stairs.length-1].dir === stairs[stairs.length-2].dir &&
                stairs[stairs.length-2].dir === stairs[stairs.length-3].dir &&
                Math.random() < 0.2
            ) {
                shouldTurn = true;
            } else if (stairs.length > 5 && Math.random() < 0.1) {
                shouldTurn = true;
            }
        }

        if (shouldTurn && !forceTurn) { // ê°•ì œ í„´ì´ ì•„ë‹ ë•Œë§Œ ë°©í–¥ì„ ë’¤ì§‘ìŒ
            newDir = (lastStair.dir === 'right') ? 'left' : 'right';
        }

        if (shouldTurn) {
            lastStair.isTurn = true;
        }

        const newX = lastStair.x + (newDir === 'right' ? stepX : -stepX);
        const newY = lastStair.y - stepY;

        stairs.push({
            x: newX,
            y: newY,
            dir: newDir,
            isTurn: false
        });
    }

    function generateInitialStairs() {
        stairs = [];
        stairs.push({ x: 0, y: 0, dir: 'right', isTurn: false }); // ì²« ë²ˆì§¸ ê³„ë‹¨

        while (stairs.length < totalStairsToGenerate) {
            generateNewStair();
        }
    }

    // --- ê²Œì„ ì´ˆê¸°í™” ---
    function initGame() {
        score = 0;
        currentYear = 1000;
        currentMilestoneIndex = 0;
        // --- ìˆ˜ì •ë¨: ì„ íƒí•œ ìŠ¤í‚¨ ì´ë¯¸ì§€ë¡œ ì„¤ì • ---
        player.imageElement = preloadedImages[selectedSkin.name];
        player.stairIndex = 0;

        worldY = 0;
        targetWorldY = 0;

        timeRemaining = maxTime;
        lastTime = 0; // *** ì¤‘ìš”: íƒ€ì´ë¨¸ ë£¨í”„ë¥¼ ìœ„í•´ 0ìœ¼ë¡œ ë¦¬ì…‹ ***

        generateInitialStairs();

        player.x = (canvas.width / 2) + stairs[0].x;
        targetPlayerX = player.x;

        updateSidebar();
    }

    // --- ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸ ---
    function updateSidebar() {
        yearDisplay.textContent = `${currentYear}ë…„`;
        scoreDisplay.textContent = score;

        unlockedList.innerHTML = "";
        for (let i = 0; i <= currentMilestoneIndex; i++) {
            const li = document.createElement('li');
            li.className = "flex items-center";
            // --- ìˆ˜ì •ë¨: í˜„ì¬ ì„ íƒëœ ìŠ¤í‚¨ê³¼ ì´ë¦„ì´ ê°™ë‹¤ë©´ ê°•ì¡° í‘œì‹œ + ì´ë¯¸ì§€ ---
            let fontWeight = (milestones[i].name === selectedSkin.name) ? 'font-bold text-yellow-300' : '';
            li.innerHTML = `<img src="${milestones[i].image}" class="inline-block w-6 h-6 rounded-full mr-3 object-contain bg-gray-700 p-0.5"> <span class="${fontWeight}">${milestones[i].year}ë…„: ${milestones[i].name}</span>`;
            unlockedList.appendChild(li);
        }
    }

    // --- ë§ˆì¼ìŠ¤í†¤ í™•ì¸ ---
    function checkMilestones() {
        if (currentMilestoneIndex < milestones.length - 1) {
            const nextMilestone = milestones[currentMilestoneIndex + 1];
            if (score >= nextMilestone.score) {
                currentMilestoneIndex++;
                updateSidebar();
            }
        }
    }

    // --- *** ìˆ˜ì •ë¨: ê²Œì„ ì‹œì‘ (íƒ€ì´ë¨¸ ë²„ê·¸ ìˆ˜ì •) *** ---
    function startGame() {
        initGame(); // This sets lastTime = 0 and timeRemaining = maxTime
        gameStatus = 'playing';
        overlay.classList.add('hidden');
        // lastTime = performance.now(); // REMOVED: This was a bug
        // gameLoop(); // REMOVED: This was a bug
        requestAnimationFrame(gameLoop); // ADDED: This starts the loop correctly
    }

    // --- ê²Œì„ ì˜¤ë²„ ---
    function gameOver() {
        gameStatus = 'over';

        // --- ì¶”ê°€ë¨: ìµœê³  ì ìˆ˜ ê°±ì‹  ---
        if (score > highestScore) {
            highestScore = score;
            saveHighestScore();
            populateMenuSkinGrid(); // ìŠ¤í‚¨ ê·¸ë¦¬ë“œ ê°±ì‹ 
        }
        highestScoreDisplay.textContent = highestScore;

        overlayTitle.textContent = "ê²Œì„ ì˜¤ë²„!";
        overlayScore.textContent = `ìµœì¢… ë…„ë„: ${currentYear}ë…„ (ì ìˆ˜: ${score})`;
        overlayScore.classList.remove('hidden'); // ì ìˆ˜ í‘œì‹œ
        startButton.textContent = "ë‹¤ì‹œ ì‹œì‘";
        overlay.classList.remove('hidden');
    }

    // --- ê·¸ë¦¬ê¸° í•¨ìˆ˜ ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const camOffsetY = player.y - worldY;

        // ê³„ë‹¨ ê·¸ë¦¬ê¸°
        for (let i = stairs.length - 1; i >= 0; i--) {
            const s = stairs[i];
            const drawX = s.x + (canvas.width / 2) - stairWidth / 2;
            const drawY = s.y + camOffsetY;

            if (drawX > canvas.width + stairWidth || drawX < -stairWidth || drawY < -stairHeight || drawY > canvas.height + stairHeight) {
                continue;
            }

            ctx.fillStyle = s.isTurn ? '#facc15' : '#6b7280';
            ctx.fillRect(drawX, drawY, stairWidth, stairHeight);
        }

        // --- ìˆ˜ì •ë¨: í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸° (ì´ë¯¸ì§€) ---
        if (player.imageElement && player.imageElement.complete) {
            ctx.drawImage(
                player.imageElement,
                player.x - player.width / 2,
                player.y - player.height - (player.height / 2), // ì´ë¯¸ì§€ê°€ ë°œíŒ ìœ„ì— ì˜¤ë„ë¡ Yì¡°ì •
                player.width,
                player.height
            );
        } else {
            // ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°, ì‚¬ê°í˜• (fallback)
            ctx.fillStyle = '#a8907a';
            ctx.fillRect(player.x - player.width / 2, player.y - player.height, player.width, player.height);
        }

        // íƒ€ì´ë¨¸ ë°” ê·¸ë¦¬ê¸°
        if (gameStatus === 'playing') {
            const timerBarWidth = 100;
            const timerBarHeight = 10;
            const timerX = player.x - timerBarWidth / 2;
            const timerY = player.y - player.height - (player.height / 2) - 20; // í”Œë ˆì´ì–´ ë¨¸ë¦¬ ìœ„ì—

            ctx.fillStyle = '#9ca3af';
            ctx.fillRect(timerX, timerY, timerBarWidth, timerBarHeight);

            const barWidth = (timeRemaining / maxTime) * timerBarWidth;
            ctx.fillStyle = timeRemaining < maxTime * 0.3 ? '#ef4444' : '#22c55e';
            ctx.fillRect(timerX, timerY, barWidth, timerBarHeight);
        }
    }

    // --- ë©”ì¸ ê²Œì„ ë£¨í”„ ---
    function gameLoop(now) {
        if (gameStatus !== 'playing') return;

        if (!lastTime) { //
            lastTime = now;
        }
        const deltaTime = now - lastTime;
        lastTime = now;

        // 1. íƒ€ì´ë¨¸ ê°ì†Œ
        timeRemaining -= deltaTime;
        if (timeRemaining <= 0) {
            gameOver();
            return;
        }

        // 2. ì¹´ë©”ë¼ ë° í”Œë ˆì´ì–´ X ìœ„ì¹˜ ë¶€ë“œëŸ½ê²Œ ì´ë™
        worldY += (targetWorldY - worldY) * cameraLerpRate;
        player.x += (targetPlayerX - player.x) * playerLerpRate;

        draw();
        requestAnimationFrame(gameLoop);
    }

    // --- ì…ë ¥ ì²˜ë¦¬ (í•µì‹¬ ë¡œì§) ---
    function handleInput(direction) { // 'left' ë˜ëŠ” 'right'
        if (gameStatus !== 'playing') return;

        const nextStair = stairs[player.stairIndex + 1];
        if (!nextStair) return;

        const correctDirection = nextStair.dir; // 'left' ë˜ëŠ” 'right'

        if (direction === correctDirection) {
            // --- ì„±ê³µ ---
            player.stairIndex++;
            score = player.stairIndex;
            currentYear = 1000 + score * 10;

            timeRemaining = maxTime;

            const newStair = stairs[player.stairIndex];
            if (newStair) {
                targetPlayerX = (canvas.width / 2) + newStair.x;
                targetWorldY = newStair.y;
            }

            updateSidebar();
            checkMilestones();

            if (stairs.length - player.stairIndex < totalStairsToGenerate) {
                generateNewStair();
            }

        } else {
            // --- ì‹¤íŒ¨ (ì˜ëª»ëœ ë°©í–¥) ---
            gameOver();
        }
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

    // PC í´ë¦­ (í„°ì¹˜ì™€ ë™ì¼í•˜ê²Œ ì‘ë™)
    gameContainer.addEventListener('click', (e) => {
        if (gameStatus !== 'playing') return;
        // --- ìˆ˜ì •: ë©”ë‰´ ê·¸ë¦¬ë“œ í´ë¦­ ë¬´ì‹œ ---
        if (e.target.closest('#menu-skin-grid')) return;

        const clickX = e.clientX - gameContainer.getBoundingClientRect().left;
        const direction = (clickX < canvas.width / 2) ? 'left' : 'right';
        handleInput(direction);
    });

    // ëª¨ë°”ì¼ í„°ì¹˜
    gameContainer.addEventListener('touchstart', (e) => {
        if (gameStatus !== 'playing') return;
        // --- ìˆ˜ì •: ë©”ë‰´ ê·¸ë¦¬ë“œ í´ë¦­ ë¬´ì‹œ ---
        if (e.target.closest('#menu-skin-grid')) return;
        e.preventDefault();

        const touchX = e.touches[0].clientX - gameContainer.getBoundingClientRect().left;
        const direction = (touchX < canvas.width / 2) ? 'left' : 'right';
        handleInput(direction);
    }, { passive: false });

    // í‚¤ë³´ë“œ ì…ë ¥
    window.addEventListener('keydown', (e) => {
        if (gameStatus === 'playing') {
            if (e.key === 'ArrowLeft') {
                handleInput('left');
            } else if (e.key === 'ArrowRight') {
                handleInput('right');
            }
        } else if (gameStatus !== 'playing' && (e.key === 'Enter' || e.key === ' ')) {
            // ìŠ¤í˜ì´ìŠ¤ë°”ë‚˜ ì—”í„°ë¡œ ê²Œì„ ì‹œì‘/ì¬ì‹œì‘
            startGame();
        }
    });

    // ì‹œì‘ ë²„íŠ¼
    startButton.addEventListener('click', (e) => {
        e.stopPropagation();
        startGame();
    });

    // --- *** ìŠ¤í‚¨ ëª¨ë‹¬ ê´€ë ¨ ë¡œì§ (ìˆ˜ì •ë¨) *** ---

    // ìŠ¤í‚¨ ì„ íƒ í•¨ìˆ˜
    function selectSkin(milestone, selectedElement) {
        // --- ì¶”ê°€ë¨: ì ê¸ˆ í•´ì œ í™•ì¸ ---
        if (milestone.score > highestScore) {
            // í”ë“¤ê¸° ì• ë‹ˆë©”ì´ì…˜
            if (selectedElement) {
                selectedElement.classList.add('animate-shake');
                setTimeout(() => selectedElement.classList.remove('animate-shake'), 300);
            }
            return; // ì„ íƒ ë¶ˆê°€
        }

        selectedSkin = milestone;
        player.imageElement = preloadedImages[selectedSkin.name]; // --- ìˆ˜ì •ë¨: ì´ë¯¸ì§€ë¡œ ì„¤ì • ---

        // --- ì¶”ê°€ë¨: ì„ íƒëœ ìŠ¤í‚¨ í•˜ì´ë¼ì´íŠ¸ ---
        // 1. ëª¨ë“  í•˜ì´ë¼ì´íŠ¸ ì œê±°
        document.querySelectorAll('#menu-skin-grid .skin-item').forEach(el => {
            el.classList.remove('selected');
        });
        // 2. í´ë¦­ëœ ìš”ì†Œì— í•˜ì´ë¼ì´íŠ¸ ì¶”ê°€
        if (selectedElement) {
            selectedElement.classList.add('selected');
        }

        // ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ë‹¤ë©´(ë©”ë‰´/ì˜¤ë²„ ìƒíƒœ)
        if (gameStatus !== 'playing') {
            draw(); // ìº”ë²„ìŠ¤ì˜ í”Œë ˆì´ì–´ ìƒ‰ìƒì„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        }
        updateSidebar(); // ì‚¬ì´ë“œë°”ì˜ ê°•ì¡° í‘œì‹œ ì—…ë°ì´íŠ¸
    }

    // --- *** ì¶”ê°€ë¨: ì…°ì´í¬ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ keyframes *** ---
    const styleSheet = document.createElement("style");
    styleSheet.type = "text/css";
    styleSheet.innerText = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                50% { transform: translateX(5px); }
                75% { transform: translateX(-5px); }
            }
            .animate-shake {
                animation: shake 0.3s ease-in-out;
            }
        `;
    document.head.appendChild(styleSheet);


    // --- ìˆ˜ì •ë¨: ìŠ¤í‚¨ 'ê·¸ë¦¬ë“œ' ì±„ìš°ê¸° (í•´ê¸ˆ ë¡œì§ í¬í•¨) ---
    function populateMenuSkinGrid() {
        menuSkinGrid.innerHTML = ""; // ë¹„ìš°ê¸°
        highestScoreDisplay.textContent = highestScore; // ìµœê³  ì ìˆ˜ í‘œì‹œ

        milestones.forEach(m => {
            const item = document.createElement('div');
            const isLocked = m.score > highestScore;

            item.className = "skin-item bg-gray-100 rounded-lg p-4 text-center shadow hover:shadow-md";
            if (isLocked) {
                item.classList.add('locked');
            }

            item.innerHTML = `
                    <img src="${m.image}" alt="${m.name}" class="rounded mb-2">
                    <p class="font-semibold text-gray-800">${m.name}</p>
                    <p class="text-sm text-gray-600">${m.year}ë…„</p>
                    ${isLocked ? `<p class="text-xs text-red-500 font-bold">ì ìˆ˜ ${m.score} í•„ìš”</p>` : ''}
                `;
            // --- ìˆ˜ì •ë¨: selectedElement(item) ì „ë‹¬ ---
            item.addEventListener('click', () => selectSkin(m, item));
            menuSkinGrid.appendChild(item);
        });
    }

    // --- *** ì¶”ê°€ë¨: ìµœê³  ì ìˆ˜ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° *** ---
    function saveHighestScore() {
        try {
            localStorage.setItem('historyStair_highestScore', highestScore.toString());
        } catch (e) {
            console.error("Could not save highest score to localStorage:", e);
        }
    }

    function loadHighestScore() {
        try {
            const storedScore = localStorage.getItem('historyStair_highestScore');
            if (storedScore) {
                highestScore = parseInt(storedScore, 10) || 0;
            }
        } catch (e) {
            console.error("Could not load highest score from localStorage:", e);
            highestScore = 0;
        }
    }


    // ì°½ í¬ê¸° ì¡°ì ˆ
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', resizeCanvas);

    // --- ì´ˆê¸°í™” ---
    loadHighestScore(); // --- ì¶”ê°€ë¨: ìµœê³  ì ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ---
    preloadImages(); // --- ì¶”ê°€ë¨: ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ ---
    initGame(); // ê²Œì„ ë°ì´í„° ì´ˆê¸°í™”
    resizeCanvas(); // ìº”ë²„ìŠ¤ í¬ê¸° ì´ˆê¸° ì„¤ì •
    populateMenuSkinGrid(); // --- ìˆ˜ì •ë¨: ë©”ë‰´ ìŠ¤í‚¨ ê·¸ë¦¬ë“œ ì±„ìš°ê¸° ---

    // --- ìˆ˜ì •ë¨: ê²Œì„ ì‹œì‘ ì „ ë©”ë‰´ ìƒíƒœë¡œ ì„¤ì • ---
    gameStatus = 'menu';
    overlayTitle.textContent = "ëŒ€ê°ì„  ì—­ì‚¬ ê³„ë‹¨";
    overlayScore.classList.add('hidden');
    startButton.textContent = "ê²Œì„ ì‹œì‘";
    overlay.classList.remove('hidden');

    // --- ì¶”ê°€ë¨: ê¸°ë³¸ ìŠ¤í‚¨ ì„ íƒ ë° í•˜ì´ë¼ì´íŠ¸ (í•´ê¸ˆëœ ìŠ¤í‚¨ ì¤‘ ì²« ë²ˆì§¸) ---
    const firstUnlockedSkin = milestones.find(m => m.score <= highestScore) || milestones[0];
    const firstUnlockedElement = menuSkinGrid.querySelector('.skin-item:not(.locked)');
    selectSkin(firstUnlockedSkin, firstUnlockedElement);

    draw(); // ì´ˆê¸° í™”ë©´ ê·¸ë¦¬ê¸°
</script>
</body>
</html>

