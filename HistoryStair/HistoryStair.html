<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대각선 역사 계단</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter 폰트 적용 */
        body {
            font-family: "Inter", sans-serif;
            overscroll-behavior: none; /* 모바일에서 바운스 스크롤 방지 */
        }
        /* 캔버스 픽셀이 흐릿해지지 않도록 설정 */
        canvas {
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-color: #f0f4f8; /* 캔버스 배경색 */
        }
        /* 게임 오버레이 */
        #game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        #game-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* --- 제거됨: 스킨 선택 모달 --- */
        /* #skin-modal { ... } */

        .skin-item {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            /* 레이아웃이 흔들리지 않도록 투명한 테두리 추가 */
            border: 4px solid transparent;
        }
        .skin-item:hover {
            transform: scale(1.05);
        }
        /* --- 추가됨: 스킨 선택 하이라이트 --- */
        .skin-item.selected {
            border-color: #facc15; /* yellow-400 */
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(250, 204, 21, 0.3);
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col md:flex-row h-screen overflow-hidden">

<!-- 왼쪽 사이드바: 시대 및 운송수단 정보 -->
<aside class="w-full md:w-1/4 bg-gray-800 text-white p-6 overflow-y-auto shadow-lg">
    <h1 class="text-3xl font-bold mb-6">역사 계단</h1>

    <!-- 현재 시대 -->
    <div class="mb-8">
        <h2 class="text-xl font-semibold mb-2">현재 시대</h2>
        <p id="year-display" class="text-4xl font-bold text-teal-300">1000년</p>
        <p class="text-gray-400">(점수: <span id="score-display">0</span>)</p>
    </div>

    <!-- 해금된 운송수단 -->
    <div>
        <h2 class="text-xl font-semibold mb-3">해금된 운송수단</h2>
        <ul id="unlocked-list" class="space-y-2">
            <!-- 자바스크립트로 추가됨 -->
        </ul>
    </div>
</aside>

<!-- 오른쪽 메인 게임 영역 -->
<main class="w-full md:w-3/4 h-full bg-gray-200 relative" id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- 게임 오버레이 (시작/재시작) -->
    <div id="game-overlay" class="flex p-4">
        <h2 id="overlay-title" class="text-4xl font-bold mb-4">대각선 역사 계단</h2>
        <p id="overlay-score" class="text-2xl mb-6 hidden"></p>

        <!-- --- 수정됨: 스킨 선택 그리드를 메뉴에 직접 삽입 --- -->
        <h3 class="text-xl font-semibold mb-4 text-white">스킨 선택</h3>
        <div id="menu-skin-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 p-4 w-full max-w-2xl max-h-[50vh] overflow-y-auto bg-gray-900/50 rounded-lg mb-6">
            <!-- 스킨 아이템이 여기에 동적으로 추가됩니다 -->
        </div>

        <button id="start-button" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-md transition-transform transform hover:scale-105 mb-4">
            게임 시작
        </button>
        <!-- --- 제거됨: 스킨 버튼 --- -->
        <!-- <button id="skin-button" ...>스킨 선택</button> -->
    </div>

    <!-- --- 제거됨: 스킨 선택 모달 --- -->
    <!-- <div id="skin-modal" ...> ... </div> -->

</main>

<script>
    // --- DOM 요소 ---
    const gameContainer = document.getElementById('game-container');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const yearDisplay = document.getElementById('year-display');
    const scoreDisplay = document.getElementById('score-display');
    const unlockedList = document.getElementById('unlocked-list');
    const overlay = document.getElementById('game-overlay');
    const overlayTitle = document.getElementById('overlay-title');
    const overlayScore = document.getElementById('overlay-score');
    const startButton = document.getElementById('start-button');
    // --- 제거됨 ---
    // const skinButton = document.getElementById('skin-button');
    // const skinModal = document.getElementById('skin-modal');
    // const skinGrid = document.getElementById('skin-grid');
    // const closeSkinModal = document.getElementById('close-skin-modal');
    // const currentSkinDisplay = document.getElementById('current-skin-display');
    // --- 추가됨 ---
    const menuSkinGrid = document.getElementById('menu-skin-grid');


    // --- 게임 설정 ---
    let gameStatus = 'menu'; // 'menu', 'playing', 'over'
    let score = 0;
    let currentYear = 1000;

    // --- 플레이어 ---
    const player = {
        width: 30,
        height: 30,
        color: '#a8907a',
        stairIndex: 0, // 현재 밟고 있는 계단 인덱스
        x: 0, // 플레이어의 '화면' X 좌표
        y: 0, // 플레이어의 '화면' Y 좌표 (고정됨)
    };

    // --- 계단 ---
    let stairs = [];
    const stairWidth = 80;
    const stairHeight = 20;
    const stepX = 50; // 대각선 X 간격
    const stepY = 30; // 대각선 Y 간격 (올라가는 높이)
    const totalStairsToGenerate = 50; // 미리 생성해 둘 계단 수

    // --- 카메라 (월드 오프셋) ---
    let worldY = 0;
    let targetWorldY = 0;
    const cameraLerpRate = 0.2;

    let targetPlayerX = 0;
    const playerLerpRate = 0.25;

    // --- 타이머 ---
    const maxTime = 1500; // 1.5초
    let timeRemaining = maxTime;
    let lastTime = 0;

    // --- *** 수정됨: 운송수단 마일스톤 (500년/50점 간격) *** ---
    const milestones = [
        { score: 0, year: 1000, name: "고대 (걷기)", color: "#a8907a" },
        { score: 50, year: 1500, name: "중세 (마차/항해선)", color: "#0077be" },
        { score: 100, year: 2000, name: "근대 (증기기관)", color: "#595959" },
        { score: 150, year: 2500, name: "현대 (자동차/비행기)", color: "#e60000" },
        { score: 200, year: 3000, name: "미래 (우주선)", color: "#f0e68c" },
        { score: 250, year: 3500, name: "초미래 (에너지체)", color: "#00f0c0" }
    ];
    let currentMilestoneIndex = 0;
    let selectedSkin = milestones[0]; // --- 추가됨: 선택한 스킨 ---

    // --- 캔버스 크기 조절 ---
    function resizeCanvas() {
        const mainRect = gameContainer.getBoundingClientRect();
        // --- 수정: 오버레이 크기에 맞게 조절
        const overlayRect = overlay.getBoundingClientRect();
        // canvas.width = mainRect.width;
        // canvas.height = mainRect.height;
        // 오버레이가 캔버스를 덮으므로 오버레이 기준으로 크기 설정
        canvas.width = overlayRect.width;
        canvas.height = overlayRect.height;


        player.y = canvas.height * 0.75;

        if (gameStatus !== 'playing') {
            if (stairs.length > 0) {
                player.x = (canvas.width / 2) + stairs[player.stairIndex].x;
                targetPlayerX = player.x;
            } else {
                player.x = canvas.width / 2;
                targetPlayerX = player.x;
            }
            draw(); // 크기 조절 후 다시 그리기
        }
    }

    // --- 계단 생성 ---
    function generateNewStair() {
        const lastStair = stairs[stairs.length - 1]; // (N-1)번째 계단

        let newDir = lastStair.dir;

        // --- *** 수정됨: 계단 이탈 방지 로직 *** ---
        const horizontalLimit = stepX * 8; // 좌우 8칸 (400px) 제한
        let forceTurn = false;

        if (lastStair.x > horizontalLimit && lastStair.dir === 'right') {
            newDir = 'left';
            forceTurn = true;
        } else if (lastStair.x < -horizontalLimit && lastStair.dir === 'left') {
            newDir = 'right';
            forceTurn = true;
        }

        let shouldTurn = false;
        if (forceTurn) {
            shouldTurn = true;
        } else {
            // 기존의 랜덤 턴 로직
            if (stairs.length > 3 &&
                stairs[stairs.length-1].dir === stairs[stairs.length-2].dir &&
                stairs[stairs.length-2].dir === stairs[stairs.length-3].dir &&
                Math.random() < 0.2
            ) {
                shouldTurn = true;
            } else if (stairs.length > 5 && Math.random() < 0.1) {
                shouldTurn = true;
            }
        }

        if (shouldTurn && !forceTurn) { // 강제 턴이 아닐 때만 방향을 뒤집음
            newDir = (lastStair.dir === 'right') ? 'left' : 'right';
        }

        if (shouldTurn) {
            lastStair.isTurn = true;
        }

        const newX = lastStair.x + (newDir === 'right' ? stepX : -stepX);
        const newY = lastStair.y - stepY;

        stairs.push({
            x: newX,
            y: newY,
            dir: newDir,
            isTurn: false
        });
    }

    function generateInitialStairs() {
        stairs = [];
        stairs.push({ x: 0, y: 0, dir: 'right', isTurn: false }); // 첫 번째 계단

        while (stairs.length < totalStairsToGenerate) {
            generateNewStair();
        }
    }

    // --- 게임 초기화 ---
    function initGame() {
        score = 0;
        currentYear = 1000;
        currentMilestoneIndex = 0;
        // --- 수정됨: 선택한 스킨으로 플레이어 색상 설정 ---
        player.color = selectedSkin.color;
        player.stairIndex = 0;

        worldY = 0;
        targetWorldY = 0;

        timeRemaining = maxTime;
        lastTime = 0;

        generateInitialStairs();

        player.x = (canvas.width / 2) + stairs[0].x;
        targetPlayerX = player.x;

        updateSidebar();
    }

    // --- 사이드바 업데이트 ---
    function updateSidebar() {
        yearDisplay.textContent = `${currentYear}년`;
        scoreDisplay.textContent = score;

        unlockedList.innerHTML = "";
        for (let i = 0; i <= currentMilestoneIndex; i++) {
            const li = document.createElement('li');
            li.className = "flex items-center";
            // --- 수정됨: 현재 선택된 스킨과 이름이 같다면 강조 표시 ---
            let fontWeight = (milestones[i].name === selectedSkin.name) ? 'font-bold text-yellow-300' : '';
            li.innerHTML = `<span class="inline-block w-4 h-4 rounded-full mr-3" style="background-color: ${milestones[i].color};"></span> <span class="${fontWeight}">${milestones[i].year}년: ${milestones[i].name}</span>`;
            unlockedList.appendChild(li);
        }
    }

    // --- 마일스톤 확인 ---
    function checkMilestones() {
        if (currentMilestoneIndex < milestones.length - 1) {
            const nextMilestone = milestones[currentMilestoneIndex + 1];
            if (score >= nextMilestone.score) {
                currentMilestoneIndex++;
                // --- 수정됨: 스킨 선택 기능을 위해 이 줄을 주석 처리 ---
                // player.color = milestones[currentMilestoneIndex].color;
                updateSidebar();
            }
        }
    }

    // --- 게임 시작 ---
    function startGame() {
        initGame();
        gameStatus = 'playing';
        overlay.classList.add('hidden');
        lastTime = performance.now();
        gameLoop();
    }

    // --- 게임 오버 ---
    function gameOver() {
        gameStatus = 'over';
        overlayTitle.textContent = "게임 오버!";
        overlayScore.textContent = `최종 년도: ${currentYear}년 (점수: ${score})`;
        overlayScore.classList.remove('hidden'); // 점수 표시
        startButton.textContent = "다시 시작";
        // --- 제거됨: 스킨 버튼 표시 로직 ---
        // skinButton.classList.remove('hidden'); 
        overlay.classList.remove('hidden');
    }

    // --- 그리기 함수 ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const camOffsetY = player.y - worldY;

        // 계단 그리기
        for (let i = stairs.length - 1; i >= 0; i--) {
            const s = stairs[i];
            const drawX = s.x + (canvas.width / 2) - stairWidth / 2;
            const drawY = s.y + camOffsetY;

            if (drawX > canvas.width + stairWidth || drawX < -stairWidth || drawY < -stairHeight || drawY > canvas.height + stairHeight) {
                continue;
            }

            ctx.fillStyle = s.isTurn ? '#facc15' : '#6b7280';
            ctx.fillRect(drawX, drawY, stairWidth, stairHeight);
        }

        // 플레이어 그리기
        ctx.fillStyle = player.color;
        ctx.fillRect(player.x - player.width / 2, player.y - player.height, player.width, player.height);

        // 타이머 바 그리기
        if (gameStatus === 'playing') {
            const timerBarWidth = 100;
            const timerBarHeight = 10;
            const timerX = player.x - timerBarWidth / 2;
            const timerY = player.y - player.height - 20;

            ctx.fillStyle = '#9ca3af';
            ctx.fillRect(timerX, timerY, timerBarWidth, timerBarHeight);

            const barWidth = (timeRemaining / maxTime) * timerBarWidth;
            ctx.fillStyle = timeRemaining < maxTime * 0.3 ? '#ef4444' : '#22c55e';
            ctx.fillRect(timerX, timerY, barWidth, timerBarHeight);
        }
    }

    // --- 메인 게임 루프 ---
    function gameLoop(now) {
        if (gameStatus !== 'playing') return;

        if (!lastTime) {
            lastTime = now;
        }
        const deltaTime = now - lastTime;
        lastTime = now;

        // 1. 타이머 감소
        timeRemaining -= deltaTime;
        if (timeRemaining <= 0) {
            gameOver();
            return;
        }

        // 2. 카메라 및 플레이어 X 위치 부드럽게 이동
        worldY += (targetWorldY - worldY) * cameraLerpRate;
        player.x += (targetPlayerX - player.x) * playerLerpRate;

        draw();
        requestAnimationFrame(gameLoop);
    }

    // --- 입력 처리 (핵심 로직) ---
    function handleInput(direction) { // 'left' 또는 'right'
        if (gameStatus !== 'playing') return;

        const nextStair = stairs[player.stairIndex + 1];
        if (!nextStair) return;

        const correctDirection = nextStair.dir; // 'left' 또는 'right'

        if (direction === correctDirection) {
            // --- 성공 ---
            player.stairIndex++;
            score = player.stairIndex;
            currentYear = 1000 + score * 10;

            timeRemaining = maxTime;

            const newStair = stairs[player.stairIndex];
            if (newStair) {
                targetPlayerX = (canvas.width / 2) + newStair.x;
                targetWorldY = newStair.y;
            }

            updateSidebar();
            checkMilestones();

            if (stairs.length - player.stairIndex < totalStairsToGenerate) {
                generateNewStair();
            }

        } else {
            // --- 실패 (잘못된 방향) ---
            gameOver();
        }
    }

    // --- 이벤트 리스너 ---

    // PC 클릭 (터치와 동일하게 작동)
    gameContainer.addEventListener('click', (e) => {
        if (gameStatus !== 'playing') return;
        // --- 수정: 모달 클릭 무시 -> 메뉴 그리드 클릭 무시 ---
        if (e.target.closest('#menu-skin-grid')) return;

        const clickX = e.clientX - gameContainer.getBoundingClientRect().left;
        const direction = (clickX < canvas.width / 2) ? 'left' : 'right';
        handleInput(direction);
    });

    // 모바일 터치
    gameContainer.addEventListener('touchstart', (e) => {
        if (gameStatus !== 'playing') return;
        // --- 수정: 모달 클릭 무시 -> 메뉴 그리드 클릭 무시 ---
        if (e.target.closest('#menu-skin-grid')) return;
        e.preventDefault();

        const touchX = e.touches[0].clientX - gameContainer.getBoundingClientRect().left;
        const direction = (touchX < canvas.width / 2) ? 'left' : 'right';
        handleInput(direction);
    }, { passive: false });

    // 키보드 입력
    window.addEventListener('keydown', (e) => {
        if (gameStatus === 'playing') {
            if (e.key === 'ArrowLeft') {
                handleInput('left');
            } else if (e.key === 'ArrowRight') {
                handleInput('right');
            }
        } else if (gameStatus !== 'playing' && (e.key === 'Enter' || e.key === ' ')) {
            startGame();
        }
    });

    // 시작 버튼
    startButton.addEventListener('click', (e) => {
        e.stopPropagation();
        startGame();
    });

    // --- *** 스킨 모달 관련 로직 (수정됨) *** ---

    // --- 제거됨: 스킨 버튼 클릭 ---
    // skinButton.addEventListener('click', ...);

    // --- 제거됨: 스킨 모달 닫기 버튼 ---
    // closeSkinModal.addEventListener('click', ...);

    // 스킨 선택 함수
    function selectSkin(milestone, selectedElement) {
        selectedSkin = milestone;
        player.color = selectedSkin.color;
        // --- 제거됨: currentSkinDisplay ---
        // currentSkinDisplay.textContent = `선택한 스킨: ${selectedSkin.name}`;

        // --- 제거됨: 모달 숨기기 ---
        // skinModal.classList.add('hidden');

        // --- 추가됨: 선택된 스킨 하이라이트 ---
        // 1. 모든 하이라이트 제거
        document.querySelectorAll('#menu-skin-grid .skin-item').forEach(el => {
            el.classList.remove('selected');
        });
        // 2. 클릭된 요소에 하이라이트 추가
        if (selectedElement) {
            selectedElement.classList.add('selected');
        }

        // 게임이 시작되지 않았다면(메뉴/오버 상태)
        if (gameStatus !== 'playing') {
            draw(); // 캔버스의 플레이어 색상을 즉시 업데이트
        }
        updateSidebar(); // 사이드바의 강조 표시 업데이트
    }

    // --- 수정됨: 스킨 '그리드' 채우기 (모달X) ---
    function populateMenuSkinGrid() {
        menuSkinGrid.innerHTML = ""; // 비우기
        milestones.forEach(m => {
            const item = document.createElement('div');
            item.className = "skin-item bg-gray-100 rounded-lg p-4 text-center shadow hover:shadow-md";
            item.innerHTML = `
                    <div class="w-full h-16 rounded mb-2" style="background-color: ${m.color};"></div>
                    <p class="font-semibold text-gray-800">${m.name}</p>
                    <p class="text-sm text-gray-600">${m.year}년</p>
                `;
            // --- 수정됨: selectedElement(item) 전달 ---
            item.addEventListener('click', () => selectSkin(m, item));
            menuSkinGrid.appendChild(item);
        });
    }


    // 창 크기 조절
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', resizeCanvas);

    // --- 초기화 ---
    initGame(); // 게임 데이터 초기화
    resizeCanvas(); // 캔버스 크기 초기 설정
    populateMenuSkinGrid(); // --- 수정됨: 메뉴 스킨 그리드 채우기 ---

    // --- 수정됨: 게임 시작 전 메뉴 상태로 설정 ---
    gameStatus = 'menu';
    overlayTitle.textContent = "대각선 역사 계단";
    overlayScore.classList.add('hidden');
    startButton.textContent = "게임 시작";
    // --- 제거됨: 스킨 버튼 표시 ---
    // skinButton.classList.remove('hidden');
    overlay.classList.remove('hidden');

    // --- 추가됨: 기본 스킨 선택 및 하이라이트 ---
    selectSkin(milestones[0], document.querySelector('#menu-skin-grid .skin-item'));

    draw(); // 초기 화면 그리기
</script>
</body>
</html>

