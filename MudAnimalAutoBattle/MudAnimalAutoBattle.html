<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê°¯ë²Œ ì „íˆ¬ ì‹œë®¬ë ˆì´í„°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #F0EAD6; /* ëª¨ë˜ì‚¬ì¥ ëŠë‚Œì˜ ë°°ê²½ìƒ‰ */
    }
    .unit-card {
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      -webkit-user-select: none; /* Safari */
      -ms-user-select: none; /* IE 10+ */
      user-select: none;
    }
    .unit-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .selected {
      outline: 3px solid #4A90E2;
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 6px 12px rgba(74,144,226,0.4);
    }
    .faint-animation {
      animation: faint 0.5s ease-out forwards;
    }
    @keyframes faint {
      from { opacity: 1; transform: scale(1); }
      to { opacity: 0; transform: scale(0.8); }
    }
    .attack-animation {
      animation: attack 0.4s ease-in-out;
    }
    @keyframes attack {
      0% { transform: translateX(0); }
      50% { transform: translateX(15px); }
      100% { transform: translateX(0); }
    }
    .enemy-attack-animation {
      animation: enemy-attack 0.4s ease-in-out;
    }
    @keyframes enemy-attack {
      0% { transform: translateX(0); }
      50% { transform: translateX(-15px); }
      100% { transform: translateX(0); }
    }
    .damage-text {
      animation: damage-show 0.5s ease-out forwards;
      position: absolute;
      bottom: 50%;
      left: 50%;
      transform: translateX(-50%);
      font-weight: bold;
      font-size: 1.5rem;
      color: #E53E3E; /* Red */
      text-shadow: 1px 1px #fff;
      pointer-events: none;
    }
    @keyframes damage-show {
      from { opacity: 1; transform: translate(-50%, 0); }
      to { opacity: 0; transform: translate(-50%, -30px); }
    }
    #life-counter {
      font-size: 1.5rem;
      letter-spacing: 0.1em;
    }
    .team-board {
      transition: background-color 0.5s ease-in-out;
    }
    .unit-card img {
      -webkit-user-drag: none; /* Safari */
      -khtml-user-drag: none; /* Konqueror */
      -moz-user-drag: none; /* Firefox */
      -o-user-drag: none; /* Opera */
      user-drag: none;
    }
  </style>
</head>
<body class="bg-[#F0EAD6] text-gray-800 p-4">

<div id="game-container" class="max-w-7xl mx-auto">
  <!-- ìƒë‹¨ ì •ë³´ UI -->
  <div id="info-bar" class="flex justify-between items-center bg-[#A4C3B2] p-3 rounded-lg shadow-md mb-4 text-white">
    <div class="flex items-center space-x-6">
      <div><span class="font-bold">í„´:</span> <span id="turn-counter">1</span></div>
      <div id="life-counter"></div>
    </div>
    <div class="text-2xl font-bold" id="environment-indicator"></div>
    <div><span class="font-bold">ê³¨ë“œ:</span> <span id="gold-counter">10</span> ğŸ’°</div>
  </div>

  <!-- ì„ íƒ ì •ë³´ -->
  <div id="selection-info" class="text-center mb-2 h-6 font-semibold text-blue-700"></div>

  <!-- ìƒëŒ€ íŒ€ (ì „íˆ¬ ì‹œì—ë§Œ ë³´ì„) -->
  <div id="enemy-team-area" class="mb-4 min-h-[160px]">
    <h2 class="text-center text-xl font-bold text-gray-500 mb-2">ìƒëŒ€ íŒ€</h2>
    <div id="enemy-team" class="team-board flex justify-center items-center space-x-2"></div>
  </div>

  <!-- ì „íˆ¬ ë¡œê·¸ -->
  <div id="battle-log-container" class="h-24 bg-white/50 rounded-lg p-2 overflow-y-auto mb-4 border-2 border-gray-300 shadow-inner hidden">
    <div id="battle-log" class="text-sm"></div>
  </div>

  <!-- í”Œë ˆì´ì–´ íŒ€ -->
  <div id="player-team-area" class="mb-4 min-h-[160px]">
    <h2 class="text-center text-xl font-bold text-gray-600 mb-2">ë‚˜ì˜ íŒ€ (í´ë¦­í•˜ì—¬ ì¡°ì‘)</h2>
    <div id="player-team" class="team-board flex justify-center items-start space-x-2 p-4 rounded-lg"></div>
  </div>

  <!-- ìƒì  -->
  <div id="shop-area" class="bg-[#6B9080]/80 p-4 rounded-xl shadow-lg">
    <div class="flex justify-between items-center mb-4">
      <div class="flex space-x-2">
        <h2 class="text-2xl font-bold text-white">ìƒì </h2>
      </div>
      <div class="flex items-center space-x-2">
        <button id="roll-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">ë¦¬ë¡¤ (1 ê³¨ë“œ)</button>
        <button id="end-turn-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">í„´ ì¢…ë£Œ</button>
      </div>
    </div>
    <div class="flex justify-center space-x-4">
      <!-- ìƒì  ìœ ë‹› -->
      <div id="shop-units" class="flex justify-start items-center space-x-2"></div>
      <!-- ìƒì  ìŒì‹ -->
      <div id="shop-foods" class="flex justify-start items-center space-x-2"></div>
    </div>
  </div>

  <!-- ìŠ¹ë¦¬ íŠ¸ë¡œí”¼ ë°” -->
  <div id="win-trophy-bar" class="mt-4 bg-[#A4C3B2] p-3 rounded-lg shadow-md flex justify-center items-center space-x-2 h-16">
    <!-- Trophies will be rendered here by JavaScript -->
  </div>
</div>

<!-- ê²Œì„ ì˜¤ë²„/ìŠ¹ë¦¬ ëª¨ë‹¬ -->
<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50">
  <div class="bg-white p-8 rounded-2xl shadow-2xl text-center">
    <h2 id="modal-title" class="text-4xl font-bold mb-4"></h2>
    <p id="modal-text" class="text-lg mb-6"></p>
    <button id="restart-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-xl">ë‹¤ì‹œ ì‹œì‘</button>
  </div>
</div>

<script type="module">
  // --- ê²Œì„ ë°ì´í„° ì •ì˜ ---
  const ENVIRONMENTS = {
    HIGH_TIDE: { name: 'ë°€ë¬¼', color: '#a2d2ff' }, // í•˜ëŠ˜ìƒ‰
    LOW_TIDE: { name: 'ì°ë¬¼', color: '#b08968' },  // í™©í† ìƒ‰
  };

  const UNIT_DATA = {
    // T1
    bajirak: { name: 'ë°”ì§€ë½', tier: 1, atk: 3, hp: 2, trigger: 'hurt', desc: 'í”¼ê²©: ìì‹  ê³µê²©ë ¥ +1(ì „íˆ¬).' },
    mudworm: { name: 'ê°¯ì§€ë ì´', tier: 1, atk: 2, hp: 2, trigger: 'faint', desc: 'í‡´ì¥: 1/1 ì‘ì€ ë²Œë ˆ 1ë§ˆë¦¬ ì†Œí™˜.' },
    mudSnail: { name: 'ê°¯ë²Œ ë‹¬íŒ½ì´', tier: 1, atk: 1, hp: 3, trigger: 'buy', desc: 'êµ¬ë§¤: ë¬´ì‘ìœ„ ì•„êµ° ì²´ë ¥ +1(ì˜êµ¬).' },
    smallCrab: { name: 'ì‘ì€ ê²Œ', tier: 1, atk: 3, hp: 2, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ë’¤ ì¹œêµ¬ ê³µê²©ë ¥ +1(ì „íˆ¬).' },
    // T2
    daehap: { name: 'ëŒ€í•©', tier: 2, atk: 2, hp: 4, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ë’¤ ì¹œêµ¬ +1/+1(ì „íˆ¬).' },
    ppulsora: { name: 'ë¿”ì†Œë¼', tier: 2, atk: 3, hp: 3, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ì „ì—´ì´ë©´ íšŒí”¼ 1íšŒ.' },
    mangdungeo: { name: 'ë§ë‘¥ì–´', tier: 2, atk: 3, hp: 3, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ë¬´ì‘ìœ„ ì•„êµ° ê³µê²©ë ¥ +1(ì „íˆ¬).' },
    nongge: { name: 'ë†ê²Œ', tier: 2, atk: 4, hp: 2, trigger: 'beforeAttack', desc: 'ê³µê²© ì „: ì• ì ì—ê²Œ 1 í”¼í•´.' },
    // T3
    honghap: { name: 'í™í•©', tier: 3, atk: 4, hp: 3, trigger: 'hurt', desc: 'í”¼ê²©: ì• ì  ê³µê²©ë ¥ -1(ì „íˆ¬).' },
    garibi: { name: 'ê°€ë¦¬ë¹„', tier: 3, atk: 5, hp: 3, trigger: 'faint', desc: 'í‡´ì¥: 2/2 ì‘ì€ ê°€ë¦¬ë¹„ 2ë§ˆë¦¬ ì†Œí™˜.' },
    jjangddungeo: { name: 'ì§±ëš±ì–´', tier: 3, atk: 5, hp: 3, trigger: 'beforeAttack', desc: 'ê³µê²© ì „: ì• ì ì—ê²Œ 2 í”¼í•´.' },
    chilmyeoncho: { name: 'ì¹ ë©´ì´ˆ', tier: 3, atk: 3, hp: 5, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ë’¤ ì¹œêµ¬ +1/+1(ì „íˆ¬).' },
    // T4
    haehongnamul: { name: 'í•´í™ë‚˜ë¬¼', tier: 4, atk: 2, hp: 8, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ëª¨ë“  ì•„êµ° ì²´ë ¥ +1(ì „íˆ¬).' },
    sora: { name: 'ì†Œë¼', tier: 4, atk: 6, hp: 3, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ë’¤ ì¹œêµ¬ ê³µê²©ë ¥ +2(ì „íˆ¬).' },
    kkotge: { name: 'ê½ƒê²Œ', tier: 4, atk: 5, hp: 4, trigger: 'beforeAttack', desc: 'ê³µê²© ì „: ì• ì ê³¼ ê·¸ ë’¤ ì ì—ê²Œ ê°ê° 1 í”¼í•´.' },
    chilge: { name: 'ì¹ ê²Œ', tier: 4, atk: 4, hp: 7, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ì´ ì „íˆ¬ ë™ì•ˆ ìì‹ ì´ ë°›ëŠ” í”¼í•´ -2.' },
    // T5
    nakji: { name: 'ë‚™ì§€', tier: 5, atk: 6, hp: 3, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: í›„ì—´ë¡œ ì´ë™. ì²« í”¼ê²© í”¼í•´ -2.' },
    bigSnail: { name: 'í° ë‹¬íŒ½ì´', tier: 5, atk: 4, hp: 9, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ëª¨ë“  ì•„êµ°ì´ ë°›ëŠ” í”¼í•´ -1(ì´ ì „íˆ¬ ë™ì•ˆ).' },
    muneo: { name: 'ë¬¸ì–´', tier: 5, atk: 6, hp: 5, trigger: 'beforeAttack', desc: 'ê³µê²© ì „: ì• ì ì—ê²Œ 1 í”¼í•´. ë’¤ ì¹œêµ¬ ê³µê²©ë ¥ +1(ì „íˆ¬).' },
    sungeo: { name: 'ìˆ­ì–´', tier: 5, atk: 7, hp: 6, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ë¬´ì‘ìœ„ ì•„êµ° ê³µê²©ë ¥ +2(ì „íˆ¬).' },
    // T6
    doyosae: { name: 'ë„ìš”ìƒˆ', tier: 6, atk: 8, hp: 8, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ì• ì ì—ê²Œ 2 í”¼í•´.' },
    galmaegi: { name: 'ê°ˆë§¤ê¸°', tier: 6, atk: 8, hp: 8, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ëª¨ë“  ì•„êµ° ê³µê²©ë ¥ +1(ì „íˆ¬).' },
    waegari: { name: 'ì™œê°€ë¦¬', tier: 6, atk: 9, hp: 9, trigger: 'startOfBattle', desc: 'ì „íˆ¬ ì‹œì‘: ë’¤ ì¹œêµ¬ +2/+2(ì „íˆ¬).' },
    daewangjogae: { name: 'ëŒ€ì™•ì¡°ê°œ', tier: 6, atk: 10, hp: 5, trigger: 'beforeAttack', desc: 'ê³µê²© ì „: ê´€í†µ 1 í”¼í•´(ë’¤ ì  1 ì „ì´).' },
    // Tokens
    smallWorm: { name: 'ì‘ì€ ë²Œë ˆ', tier: 'T', atk: 1, hp: 1, isToken: true, desc: '' },
    smallScallop: { name: 'ì‘ì€ ê°€ë¦¬ë¹„', tier: 'T', atk: 2, hp: 2, isToken: true, desc: '' },
  };

  const FOOD_DATA = {
    plankton: { name: 'í”Œë‘í¬í†¤', tier: 1, cost: 3, desc: 'ìœ ë‹›ì—ê²Œ ì˜êµ¬ +1/+1 ë¶€ì—¬.', effect: (unit) => { unit.atk += 1; unit.hp += 1; } },
    shell: { name: 'ê»ì§ˆ ê°•í™”', tier: 2, cost: 3, desc: 'ìœ ë‹›ì—ê²Œ ë©œë¡  ì•„ë¨¸(í”¼í•´ 7 í¡ìˆ˜) ë¶€ì—¬.', effect: (unit) => { unit.effects.armorType = 'melon'; unit.effects.armorValue = 7; } },
    mudCoating: { name: 'ê°¯ë²Œ í™ˆ', tier: 3, cost: 3, desc: 'ìœ ë‹›ì—ê²Œ ê°ˆë¦­ ì•„ë¨¸(ë°›ëŠ” í”¼í•´ -2) ë¶€ì—¬.', effect: (unit) => { unit.effects.armorType = 'garlic'; unit.effects.armorValue = 2; } },
  };

  // --- ê²Œì„ ìƒíƒœ ê´€ë¦¬ ---
  let gameState = {};

  function createUnitInstance(id, level = 1) {
    const data = UNIT_DATA[id];
    return {
      id: id,
      ...data,
      instanceId: crypto.randomUUID(),
      atk: data.atk + (level - 1),
      hp: data.hp + (level - 1),
      level: level,
      exp: 0,
      battleAtk: 0,
      battleHp: 0,
      effects: {
        evade: 0,
        armorType: null,
        armorValue: 0,
        damageReduction: 0,
        firstHitTaken: false,
      }
    };
  }

  // --- UI ë Œë”ë§ ---
  const $ = (selector) => document.querySelector(selector);
  const $$ = (selector) => document.querySelectorAll(selector);

  function renderUnit(unit, index, teamType) {
    const isShop = teamType === 'shop';
    const isEmpty = !unit;
    const baseClasses = `unit-card w-32 h-36 rounded-lg p-2 flex flex-col justify-between items-center relative flex-shrink-0`;

    if (isEmpty) {
      return `<div class="${baseClasses} border-2 border-dashed border-gray-400/50" data-team="player" data-index="${index}"></div>`;
    }

    const selectedClass = gameState.selectedItem?.instanceId === unit.instanceId ? 'selected' : '';
    const costText = isShop ? `<div class="absolute -bottom-1 w-full bg-blue-500 text-white text-xs py-1 rounded-b-lg">êµ¬ë§¤ (3)</div>` : '';
    const sellButton = teamType === 'player' && gameState.phase === 'shop' ? `<button class="sell-button absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs z-10" data-index="${index}">íŒë§¤</button>` : '';
    const imageURL = `https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/${unit.id}.png`;

    return `
        <div id="unit-${unit.instanceId}" class="${baseClasses} bg-white ${selectedClass}" data-team="${teamType}" data-index="${index}" data-id="${unit.id}" data-instance-id="${unit.instanceId}" title="${unit.desc}">
            ${sellButton}
            <div class="text-xs font-bold text-center">${unit.name} (L${unit.level})</div>
            <img src="${imageURL}" alt="${unit.name}" class="my-1 w-20 h-20 object-contain" onerror="this.style.display='none'">
            <div class="text-center text-lg">
                <span class="text-red-500 font-bold">${unit.atk + unit.battleAtk}</span> / 
                <span class="text-blue-500 font-bold">${unit.hp + unit.battleHp}</span>
            </div>
            ${costText}
            <div class="damage-text-container absolute inset-0"></div>
        </div>
    `;
  }

  function renderFood(food, index) {
    if (!food) return `<div class="w-24 h-24 border-2 border-dashed border-gray-400/50 rounded-lg"></div>`;
    const selectedClass = gameState.selectedItem?.type === 'food' && gameState.selectedItem.index === index ? 'selected' : '';
    return `
        <div class="unit-card w-24 h-24 bg-green-100 rounded-lg p-2 flex flex-col justify-center items-center text-center ${selectedClass}" data-type="food" data-index="${index}">
            <div class="text-sm font-bold">${food.name}</div>
            <div class="text-xs mt-1">${food.desc}</div>
            <div class="font-bold mt-1 text-yellow-600">${food.cost} ê³¨ë“œ</div>
        </div>
     `;
  }

  function renderAll() {
    $('#turn-counter').textContent = gameState.turn;
    $('#life-counter').innerHTML = Array(gameState.lives).fill('â¤ï¸').join('') + Array(4 - gameState.lives).fill('ğŸ¤').join('');
    $('#gold-counter').textContent = gameState.gold;

    const currentEnvData = ENVIRONMENTS[gameState.currentEnvironment];
    $('#environment-indicator').textContent = currentEnvData.name;
    $('#player-team').style.backgroundColor = currentEnvData.color;

    let selectionText = '';
    if (gameState.selectedItem) {
      const { type, data } = gameState.selectedItem;
      if (type === 'unit' || type === 'playerUnit') {
        selectionText = `${data.name} ì„ íƒë¨. ì•„êµ° ì¹¸ì„ í´ë¦­í•˜ì—¬ ë°°ì¹˜/ì´ë™í•˜ê±°ë‚˜ ë‹¤ë¥¸ ìœ ë‹›ê³¼ í•©ì²´í•˜ì„¸ìš”.`;
      } else if (type === 'food') {
        selectionText = `${data.name} ì„ íƒë¨. ì•„êµ° ìœ ë‹›ì—ê²Œ í´ë¦­í•˜ì—¬ ë¨¹ì´ì„¸ìš”.`;
      }
    }
    $('#selection-info').textContent = selectionText;

    let playerTeamHtml = '';
    for (let i = 0; i < 5; i++) {
      playerTeamHtml += renderUnit(gameState.playerTeam[i], i, 'player');
    }
    $('#player-team').innerHTML = playerTeamHtml;

    let enemyTeamHtml = '';
    if (gameState.phase === 'battle') {
      $('#enemy-team').style.backgroundColor = currentEnvData.color;
      $('#enemy-team').classList.add('p-4', 'rounded-lg');
      for (let i = 0; i < 5; i++) {
        enemyTeamHtml += renderUnit(gameState.enemyTeam[i], i, 'enemy');
      }
    } else {
      $('#enemy-team').style.backgroundColor = 'transparent';
      $('#enemy-team').classList.remove('p-4', 'rounded-lg');
      enemyTeamHtml = '<div class="h-36"></div>';
    }
    $('#enemy-team').innerHTML = enemyTeamHtml;

    if (gameState.phase === 'shop') {
      $('#shop-area').classList.remove('hidden');
      $('#enemy-team-area').classList.add('hidden');
      $('#battle-log-container').classList.add('hidden');

      let shopUnitsHtml = '';
      for (let i = 0; i < 3; i++) {
        shopUnitsHtml += renderUnit(gameState.shop.units[i], i, 'shop');
      }
      $('#shop-units').innerHTML = shopUnitsHtml;

      let shopFoodsHtml = '';
      for (let i = 0; i < 2; i++) {
        shopFoodsHtml += renderFood(gameState.shop.foods[i], i);
      }
      $('#shop-foods').innerHTML = shopFoodsHtml;

    } else {
      $('#shop-area').classList.add('hidden');
      $('#enemy-team-area').classList.remove('hidden');
      $('#battle-log-container').classList.remove('hidden');
    }

    // Render Win Trophies
    const trophyBar = $('#win-trophy-bar');
    trophyBar.innerHTML = '';
    const filledTrophySVG = `<svg class="h-10 w-10 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13 3.25A2.25 2.25 0 0 0 10.75 1H6.25A2.25 2.25 0 0 0 4 3.25V5.5h9.25v10.25h-3.5a.75.75 0 0 1 0-1.5h2v-1.5h-2a.75.75 0 0 1 0-1.5h2v-1.5h-2a.75.75 0 0 1 0-1.5h2V8h-2a.75.75 0 0 1 0-1.5h2.75A2.25 2.25 0 0 0 13 4.25V3.25Z M8.5 18.25a.75.75 0 0 0-1.5 0v1.5h-1.5a.75.75 0 0 0 0 1.5H7v1.5a.75.75 0 0 0 1.5 0V21h1.5a.75.75 0 0 0 0-1.5H8.5v-1.25Z M18 17a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z"></path></svg>`;
    const emptyTrophySVG = `<svg class="h-10 w-10 text-white/40" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13 3.25A2.25 2.25 0 0 0 10.75 1H6.25A2.25 2.25 0 0 0 4 3.25V5.5h9.25v10.25h-3.5a.75.75 0 0 1 0-1.5h2v-1.5h-2a.75.75 0 0 1 0-1.5h2v-1.5h-2a.75.75 0 0 1 0-1.5h2V8h-2a.75.75 0 0 1 0-1.5h2.75A2.25 2.25 0 0 0 13 4.25V3.25Z M8.5 18.25a.75.75 0 0 0-1.5 0v1.5h-1.5a.75.75 0 0 0 0 1.5H7v1.5a.75.75 0 0 0 1.5 0V21h1.5a.75.75 0 0 0 0-1.5H8.5v-1.25Z M18 17a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z"></path></svg>`;

    for (let i = 0; i < 10; i++) {
      trophyBar.innerHTML += (i < gameState.wins) ? filledTrophySVG : emptyTrophySVG;
    }

    addClickListeners();
  }


  // --- ê²Œì„ ë¡œì§ ---
  function getAvailableUnits(tier) {
    return Object.keys(UNIT_DATA).filter(id => !UNIT_DATA[id].isToken && UNIT_DATA[id].tier <= tier);
  }

  function populateShop() {
    // BUG FIX: Adjusted the tier calculation to match SAP progression.
    const maxTier = Math.min(6, Math.floor((gameState.turn - 1) / 2) + 1);
    const availableUnits = getAvailableUnits(maxTier);

    gameState.shop.units = [];
    for(let i=0; i<3; i++) {
      if (availableUnits.length === 0) continue;
      const randomId = availableUnits[Math.floor(Math.random() * availableUnits.length)];
      gameState.shop.units.push(createUnitInstance(randomId));
    }

    const availableFoods = Object.keys(FOOD_DATA);
    gameState.shop.foods = [];
    for(let i=0; i<2; i++) {
      const randomId = availableFoods[Math.floor(Math.random() * availableFoods.length)];
      gameState.shop.foods.push({id: randomId, ...FOOD_DATA[randomId]});
    }
  }

  function levelUp(unit) {
    unit.level++;
    unit.exp = 1;
    unit.atk++;
    unit.hp++;
  }

  function clearSelection() {
    gameState.selectedItem = null;
    renderAll();
  }

  function sellUnit(index) {
    const unit = gameState.playerTeam[index];
    if (!unit) return;
    gameState.gold += unit.level;
    gameState.playerTeam[index] = null;
    clearSelection();
  }

  function rollShop() {
    if (gameState.gold < 1) return;
    gameState.gold -= 1;
    populateShop();
    renderAll();
  }

  function startTurn() {
    gameState.turn++;
    gameState.gold = 10;
    gameState.phase = 'shop';
    const environments = Object.keys(ENVIRONMENTS);
    gameState.currentEnvironment = environments[Math.floor(Math.random() * environments.length)];
    populateShop();
    renderAll();
  }

  function initGame() {
    gameState = {
      turn: 1,
      wins: 0,
      lives: 4,
      gold: 10,
      phase: 'shop',
      playerTeam: Array(5).fill(null),
      enemyTeam: [],
      shop: { units: [], foods: [] },
      currentEnvironment: 'LOW_TIDE',
      selectedItem: null,
    };
    const environments = Object.keys(ENVIRONMENTS);
    gameState.currentEnvironment = environments[Math.floor(Math.random() * environments.length)];
    populateShop();
    renderAll();
  }

  // --- ì „íˆ¬ ë¡œì§ ---
  async function startBattle() {
    gameState.phase = 'battle';
    generateEnemyTeam();

    let playerBattleTeam = gameState.playerTeam.filter(u => u).map(u => JSON.parse(JSON.stringify(u)));
    playerBattleTeam.forEach(u => u.instanceId = crypto.randomUUID()); // ì „íˆ¬ìš© ìƒˆ ID
    let enemyBattleTeam = gameState.enemyTeam.filter(u => u).map(u => JSON.parse(JSON.stringify(u)));

    renderAll();
    await delay(100);
    renderBattleState(playerBattleTeam, enemyBattleTeam);

    const battleLog = $('#battle-log');
    battleLog.innerHTML = '';
    const log = (msg) => {
      const p = document.createElement('p');
      p.textContent = msg;
      battleLog.appendChild(p);
      battleLog.scrollTop = battleLog.scrollHeight;
    };

    log('--- ì „íˆ¬ ì‹œì‘ ---');
    await delay(500);

    await resolveTriggers('startOfBattle', playerBattleTeam, playerBattleTeam, enemyBattleTeam, log);
    await resolveTriggers('startOfBattle', enemyBattleTeam, enemyBattleTeam, playerBattleTeam, log);
    renderBattleState(playerBattleTeam, enemyBattleTeam);
    await delay(1000);

    while (playerBattleTeam.length > 0 && enemyBattleTeam.length > 0) {
      const playerUnit = playerBattleTeam[0];
      const enemyUnit = enemyBattleTeam[0];
      if (!playerUnit || !enemyUnit) break;

      await delay(500);

      await resolveTriggers('beforeAttack', [playerUnit], playerBattleTeam, enemyBattleTeam, log);
      renderBattleState(playerBattleTeam, enemyBattleTeam);
      await resolveTriggers('beforeAttack', [enemyUnit], enemyBattleTeam, playerBattleTeam, log);
      renderBattleState(playerBattleTeam, enemyBattleTeam);
      await delay(500);

      playerBattleTeam = playerBattleTeam.filter(u => u.hp + u.battleHp > 0);
      enemyBattleTeam = enemyBattleTeam.filter(u => u.hp + u.battleHp > 0);
      if (playerBattleTeam.length === 0 || enemyBattleTeam.length === 0) break;

      $(`#unit-${playerUnit.instanceId}`)?.classList.add('attack-animation');
      $(`#unit-${enemyUnit.instanceId}`)?.classList.add('enemy-attack-animation');

      await applyDamage(enemyUnit, playerUnit.atk + playerUnit.battleAtk, enemyBattleTeam, playerBattleTeam, log, playerUnit);
      if (enemyBattleTeam.some(u => u.hp + u.battleHp > 0)) {
        await applyDamage(playerUnit, enemyUnit.atk + enemyUnit.battleAtk, playerBattleTeam, enemyBattleTeam, log, enemyUnit);
      }

      await delay(500);
      $(`#unit-${playerUnit.instanceId}`)?.classList.remove('attack-animation');
      $(`#unit-${enemyUnit.instanceId}`)?.classList.remove('enemy-attack-animation');

      playerBattleTeam = playerBattleTeam.filter(u => u && u.hp + u.battleHp > 0);
      enemyBattleTeam = enemyBattleTeam.filter(u => u && u.hp + u.battleHp > 0);

      renderBattleState(playerBattleTeam, enemyBattleTeam);
      await delay(500);
    }

    await delay(1000);
    if (playerBattleTeam.length > 0 && enemyBattleTeam.length === 0) {
      log('--- ìŠ¹ë¦¬! ---');
      gameState.wins++;
    } else if (playerBattleTeam.length === 0 && enemyBattleTeam.length > 0) {
      log('--- íŒ¨ë°°... ---');
      gameState.lives--;
    } else {
      log('--- ë¬´ìŠ¹ë¶€ ---');
    }

    await delay(2000);

    if (gameState.wins >= 10) {
      showModal('ìµœì¢… ìŠ¹ë¦¬!', 'ê°¯ë²Œì˜ ì§€ë°°ìê°€ ë˜ì…¨ìŠµë‹ˆë‹¤!');
    } else if (gameState.lives <= 0) {
      showModal('ê²Œì„ ì˜¤ë²„', `ìµœì¢… ${gameState.wins}ìŠ¹ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.`);
    } else {
      startTurn();
    }
  }

  function renderBattleState(playerTeam, enemyTeam) {
    let playerTeamHtml = '';
    for (let i = 0; i < 5; i++) playerTeamHtml += renderUnit(playerTeam[i], i, 'player');
    $('#player-team').innerHTML = playerTeamHtml;

    let enemyTeamHtml = '';
    for (let i = 0; i < 5; i++) enemyTeamHtml += renderUnit(enemyTeam[i], i, 'enemy');
    $('#enemy-team').innerHTML = enemyTeamHtml;
  }

  async function applyDamage(target, damage, targetTeam, attackerTeam, log, attacker) {
    if (!target || target.hp + target.battleHp <= 0) return;

    let finalDamage = damage;
    if (target.id === 'nakji' && !target.effects.firstHitTaken) {
      finalDamage = Math.max(0, finalDamage - 2);
      target.effects.firstHitTaken = true;
    }
    finalDamage = Math.max(0, finalDamage - target.effects.damageReduction);

    const damageNumber = document.createElement('div');
    damageNumber.className = 'damage-text';
    damageNumber.textContent = `-${finalDamage}`;
    $(`#unit-${target.instanceId} .damage-text-container`)?.appendChild(damageNumber);

    target.hp -= finalDamage;
    log(`${attacker.name}ì´(ê°€) ${target.name}ì—ê²Œ ${finalDamage} í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤. (ë‚¨ì€ ì²´ë ¥: ${Math.max(0, target.hp + target.battleHp)})`);

    if (target.hp + target.battleHp > 0) {
      await resolveTriggers('hurt', [target], targetTeam, attackerTeam, log);
    } else {
      $(`#unit-${target.instanceId}`)?.classList.add('faint-animation');
      log(`${target.name} í‡´ì¥!`);
      await resolveTriggers('faint', [target], targetTeam, attackerTeam, log);
    }
  }

  async function dealDirectDamage(target, damage, log, source) {
    if(!target || target.hp + target.battleHp <= 0) return;
    const damageNumber = document.createElement('div');
    damageNumber.className = 'damage-text';
    damageNumber.textContent = `-${damage}`;
    $(`#unit-${target.instanceId} .damage-text-container`)?.appendChild(damageNumber);

    target.hp -= damage;
    log(`[${source.name}] íš¨ê³¼ë¡œ ${target.name}ì´(ê°€) ${damage}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤.`);
  }

  function generateEnemyTeam() {
    gameState.enemyTeam = [];
    const enemyUnitCount = Math.min(5, Math.floor(gameState.turn / 2) + 2);
    const maxTier = Math.min(6, Math.floor((gameState.turn + 1) / 2) + 1);
    const availableUnits = getAvailableUnits(maxTier);

    for (let i=0; i<enemyUnitCount; i++) {
      if (availableUnits.length === 0) continue;
      const randomId = availableUnits[Math.floor(Math.random() * availableUnits.length)];
      gameState.enemyTeam.push(createUnitInstance(randomId));
    }
  }

  async function resolveTriggers(trigger, actors, actorTeam, enemyTeam, log) {
    for (const actor of actors) {
      if (!actor || (actor.hp + actor.battleHp <= 0 && trigger !== 'faint')) continue;

      if (actor.trigger === trigger) {
        const effect = UNIT_EFFECTS[actor.id];
        if (effect) await effect(actor, actorTeam, enemyTeam, log);
      }
    }
  }

  const UNIT_EFFECTS = {
    bajirak: (self, _1, _2, log) => { self.battleAtk += 1; log(`[${self.name}] íš¨ê³¼: ê³µê²©ë ¥ +1.`); },
    mudworm: (self, team, _, log) => {
      log(`[${self.name}] íš¨ê³¼: ì‘ì€ ë²Œë ˆ ì†Œí™˜!`);
      const index = team.findIndex(u => u && u.instanceId === self.instanceId);
      if (index !== -1 && team.filter(u => u).length < 5) team.splice(index + 1, 0, createUnitInstance('smallWorm'));
    },
    smallCrab: (self, team, _, log) => {
      const i = team.findIndex(u => u && u.instanceId === self.instanceId);
      if (i !== -1 && i < team.length - 1 && team[i+1]) {
        team[i+1].battleAtk += 1;
        log(`[${self.name}] íš¨ê³¼: ${team[i+1].name} ê³µê²©ë ¥ +1.`);
      }
    },
    daehap: (self, team, _, log) => {
      const i = team.findIndex(u => u && u.instanceId === self.instanceId);
      if (i !== -1 && i < team.length - 1 && team[i+1]) {
        team[i+1].battleAtk += 1;
        team[i+1].battleHp += 1;
        log(`[${self.name}] íš¨ê³¼: ${team[i+1].name} +1/+1.`);
      }
    },
    ppulsora: (self, team, _, log) => { if (team.findIndex(u=>u && u.instanceId===self.instanceId) === 0) { self.effects.evade = 1; log(`[${self.name}] íš¨ê³¼: íšŒí”¼ 1íšŒ íšë“.`); } },
    mangdungeo: (self, team, _, log) => {
      const allies = team.filter(u => u && u.instanceId !== self.instanceId);
      if (allies.length > 0) {
        const target = allies[Math.floor(Math.random() * allies.length)];
        target.battleAtk += 1;
        log(`[${self.name}] íš¨ê³¼: ${target.name} ê³µê²©ë ¥ +1.`);
      }
    },
    nongge: async (self, _, enemyTeam, log) => { await dealDirectDamage(enemyTeam[0], 1, log, self); },
    honghap: (self, _, enemyTeam, log) => {
      if (enemyTeam[0]) {
        enemyTeam[0].battleAtk = Math.max(0, enemyTeam[0].atk + enemyTeam[0].battleAtk - 1) - enemyTeam[0].atk;
        log(`[${self.name}] íš¨ê³¼: ${enemyTeam[0].name} ê³µê²©ë ¥ -1.`);
      }
    },
    garibi: (self, team, _, log) => {
      log(`[${self.name}] íš¨ê³¼: ì‘ì€ ê°€ë¦¬ë¹„ 2ë§ˆë¦¬ ì†Œí™˜!`);
      const index = team.findIndex(u => u && u.instanceId === self.instanceId);
      if (index !== -1) {
        let count = 0;
        for(let i = 0; i < 2 && team.filter(u=>u).length < 5; i++) {
          team.splice(index + 1 + i, 0, createUnitInstance('smallScallop'));
          count++;
        }
      }
    },
    jjangddungeo: async (self, _, enemyTeam, log) => { await dealDirectDamage(enemyTeam[0], 2, log, self); },
    chilmyeoncho: (self, team, _, log) => { UNIT_EFFECTS.daehap(self, team, _, log); },
    haehongnamul: (self, team, _, log) => { team.forEach(u => u && (u.battleHp += 1)); log(`[${self.name}] íš¨ê³¼: ëª¨ë“  ì•„êµ° ì²´ë ¥ +1.`); },
    sora: (self, team, _, log) => {
      const i = team.findIndex(u => u && u.instanceId === self.instanceId);
      if (i !== -1 && i < team.length - 1 && team[i+1]) {
        team[i+1].battleAtk += 2;
        log(`[${self.name}] íš¨ê³¼: ${team[i+1].name} ê³µê²©ë ¥ +2.`);
      }
    },
    kkotge: async (self, _, enemyTeam, log) => {
      await dealDirectDamage(enemyTeam[0], 1, log, self);
      await dealDirectDamage(enemyTeam[1], 1, log, self);
    },
    chilge: (self, team, _, log) => { self.effects.damageReduction = 2; log(`[${self.name}] íš¨ê³¼: ë°›ëŠ” í”¼í•´ -2.`); },
    nakji: (self, team, _, log) => {
      const i = team.findIndex(u => u && u.instanceId === self.instanceId);
      if (i !== -1 && i < team.filter(u=>u).length - 1) {
        const [unit] = team.splice(i, 1);
        team.push(unit);
        log(`[${self.name}] íš¨ê³¼: í›„ì—´ë¡œ ì´ë™.`);
      }
    },
    bigSnail: (self, team, _, log) => { team.forEach(u => u && (u.effects.damageReduction += 1)); log(`[${self.name}] íš¨ê³¼: ëª¨ë“  ì•„êµ° ë°›ëŠ” í”¼í•´ -1.`); },
    muneo: async (self, team, enemyTeam, log) => {
      await dealDirectDamage(enemyTeam[0], 1, log, self);
      const i = team.findIndex(u => u && u.instanceId === self.instanceId);
      if (i !== -1 && i < team.length - 1 && team[i+1]) {
        team[i+1].battleAtk += 1;
        log(`[${self.name}] íš¨ê³¼: ${team[i+1].name} ê³µê²©ë ¥ +1.`);
      }
    },
    sungeo: (self, team, _, log) => {
      const allies = team.filter(u => u && u.instanceId !== self.instanceId);
      if (allies.length > 0) {
        const target = allies[Math.floor(Math.random() * allies.length)];
        target.battleAtk += 2;
        log(`[${self.name}] íš¨ê³¼: ${target.name} ê³µê²©ë ¥ +2.`);
      }
    },
    doyosae: async (self, _, enemyTeam, log) => { await dealDirectDamage(enemyTeam[0], 2, log, self); },
    galmaegi: (self, team, _, log) => { team.forEach(u => u && u.instanceId !== self.instanceId && (u.battleAtk += 1)); log(`[${self.name}] íš¨ê³¼: ë‹¤ë¥¸ ëª¨ë“  ì•„êµ° ê³µê²©ë ¥ +1.`); },
    waegari: (self, team, _, log) => {
      const i = team.findIndex(u => u && u.instanceId === self.instanceId);
      if (i !== -1 && i < team.length - 1 && team[i+1]) {
        team[i+1].battleAtk += 2;
        team[i+1].battleHp += 2;
        log(`[${self.name}] íš¨ê³¼: ${team[i+1].name} +2/+2.`);
      }
    },
    daewangjogae: async (self, _, enemyTeam, log) => { await UNIT_EFFECTS.kkotge(self, _, enemyTeam, log); },
  };

  function delay(ms) {
    return new Promise(res => setTimeout(res, ms));
  }

  function showModal(title, text) {
    $('#modal-title').textContent = title;
    $('#modal-text').textContent = text;
    $('#modal').classList.remove('hidden');
  }

  // --- í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (íƒ­-íƒ­ ì‹œìŠ¤í…œ) ---
  function addClickListeners() {
    $$('.unit-card').forEach(card => card.addEventListener('click', e => { e.stopPropagation(); handleCardClick(card.dataset); }));
    $$('.sell-button').forEach(button => button.addEventListener('click', e => { e.stopPropagation(); sellUnit(parseInt(e.target.dataset.index)); }));
  }

  function handleCardClick(dataset) {
    const { team, type, index, id, instanceId } = dataset;
    if (!id && !type && team !== 'player') return;
    const selected = gameState.selectedItem;

    if (!selected) {
      if (team === 'shop' || type === 'food') {
        const itemIndex = parseInt(index);
        const itemData = type === 'food' ? gameState.shop.foods[itemIndex] : gameState.shop.units[itemIndex];
        if (!itemData) return;
        gameState.selectedItem = { type: type || 'unit', index: itemIndex, data: itemData };
      } else if (team === 'player' && gameState.playerTeam[index]) {
        const unit = gameState.playerTeam[index];
        gameState.selectedItem = { type: 'playerUnit', index: parseInt(index), instanceId: unit.instanceId, data: unit };
      }
    } else {
      if ((selected.type === 'playerUnit' && selected.instanceId === instanceId) ||
              (selected.type !== 'playerUnit' && selected.index == index && (selected.type === 'food' ? type === 'food' : team === 'shop'))) {
        clearSelection(); return;
      }

      if (selected.type === 'unit') {
        if (team === 'player') {
          const unitToBuy = selected.data;
          if (gameState.gold < 3) return;

          const targetUnit = gameState.playerTeam[index];
          if (!targetUnit) {
            gameState.gold -= 3;
            gameState.playerTeam[index] = unitToBuy;
            if (unitToBuy.trigger === 'buy' && unitToBuy.id === 'mudSnail') {
              const allies = gameState.playerTeam.filter(u => u);
              if (allies.length > 0) allies[Math.floor(Math.random() * allies.length)].hp++;
            }
            gameState.shop.units[selected.index] = null;
          } else if (targetUnit.id === unitToBuy.id && targetUnit.level < 3) {
            gameState.gold -= 3;
            levelUp(targetUnit);
            gameState.shop.units[selected.index] = null;
          }
          clearSelection();
        }
      } else if (selected.type === 'food') {
        if (team === 'player' && gameState.playerTeam[index]) {
          const food = selected.data;
          if (gameState.gold < food.cost) return;
          gameState.gold -= food.cost;
          food.effect(gameState.playerTeam[index]);
          gameState.shop.foods[selected.index] = null;
          clearSelection();
        }
      } else if (selected.type === 'playerUnit') {
        if (team === 'player') {
          const sourceIndex = selected.index;
          const targetIndex = parseInt(index);
          [gameState.playerTeam[sourceIndex], gameState.playerTeam[targetIndex]] = [gameState.playerTeam[targetIndex], gameState.playerTeam[sourceIndex]];
          clearSelection();
        }
      }
    }
    renderAll();
  }

  $('#roll-button').addEventListener('click', rollShop);
  $('#end-turn-button').addEventListener('click', startBattle);
  $('#restart-button').addEventListener('click', () => { $('#modal').classList.add('hidden'); initGame(); });
  document.body.addEventListener('click', (e) => { if (e.target.tagName === 'BODY' || e.target.id === 'game-container') clearSelection(); });

  initGame();
</script>

</body>
</html>

