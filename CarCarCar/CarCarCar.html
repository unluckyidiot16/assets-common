<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§ˆì£¼ ë³¸ëŠ¥! ğŸš—ğŸ’¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Pretendard', sans-serif;
            overflow: hidden;
            background-color: #f0f0f0;
        }
        canvas {
            outline: none;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .retro-font {
            font-family: 'Press Start 2P', cursive;
        }
        .car-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .car-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .car-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .car-card.selected {
            border-color: #2563eb;
            background-color: #e0f2fe;
            box-shadow: 0 4px 12px rgba(37,99,235,0.2);
        }
        .car-card.locked {
            filter: grayscale(100%) brightness(50%);
            cursor: not-allowed;
        }
        .car-card.locked::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            color: rgba(255,255,255,0.7);
            text-shadow: 0 0 5px black;
        }
        .car-card img {
            width: 80%;
            height: auto;
            margin: 0 auto 5px;
            image-rendering: pixelated; /* í”½ì…€ ì•„íŠ¸ ì´ë¯¸ì§€ì— ìœ ìš© */
        }
        .car-stats {
            margin-top: 5px;
            font-size: 0.75em;
            color: #4a5568;
        }
        .car-stats p {
            margin: 2px 0;
            line-height: 1.2;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="w-full max-w-lg mx-auto p-4 bg-white rounded-xl shadow-lg relative">
    <h1 class="text-4xl retro-font text-center text-blue-700 mb-6">ì§ˆì£¼ ë³¸ëŠ¥!</h1>

    <!-- ì ìˆ˜ ë° UI --><div class="flex justify-between items-center mb-4 p-3 bg-blue-50 rounded-lg shadow-sm">
    <div>
        <span class="font-semibold text-gray-700">ìµœê³  ì ìˆ˜:</span>
        <span id="highScore" class="font-bold text-xl text-indigo-700 ml-1">0</span>
    </div>
    <div>
        <span class="font-semibold text-gray-700">ì ìˆ˜:</span>
        <span id="score" class="font-bold text-xl text-gray-800 ml-1">0</span>
    </div>
    <div>
        <span class="font-semibold text-gray-700">ìƒëª…:</span>
        <span id="lives" class="font-bold text-xl text-red-600 ml-1">â¤ï¸</span>
    </div>
</div>

    <!-- ê²Œì„ ìº”ë²„ìŠ¤ --><div class="relative w-full aspect-[9/16] bg-gray-700 rounded-lg shadow-inner overflow-hidden mx-auto" style="max-height: 75vh;">
    <canvas id="gameCanvas" class="w-full h-full"></canvas>

    <!-- ì‹œì‘/ì„ íƒ í™”ë©´ --><div id="startScreen" class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-80 text-white p-4">
    <h2 class="text-4xl retro-font text-yellow-400 mb-6">START GAME</h2>

    <h3 class="text-xl font-bold mb-4">ë‚´ ì°¨ ì„ íƒí•˜ê¸°</h3>
    <div id="carSelectionGrid" class="car-select-grid w-full max-w-sm mb-6">
        <!-- ìë™ì°¨ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ --></div>

    <button id="startButton" class="px-8 py-4 bg-green-500 text-white retro-font rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-400 focus:ring-opacity-75 transition duration-200 text-xl">
        ê²Œì„ ì‹œì‘
    </button>
    <p class="text-sm text-gray-300 mt-4">ìµœê³  ì ìˆ˜: <span id="startScreenHighScore">0</span></p>
</div>

    <!-- ê²Œì„ ì˜¤ë²„ ë©”ì‹œì§€ --><div id="gameOverMessage" class="absolute inset-0 flex-col items-center justify-center bg-black bg-opacity-70 text-white text-center p-4 hidden">
    <h2 class="text-5xl retro-font text-red-500 mb-4">GAME OVER!</h2>
    <p class="text-2xl mt-2">ìµœì¢… ì ìˆ˜: <span id="finalScore" class="font-bold">0</span></p>
    <p class="text-xl">ìµœê³  ì ìˆ˜: <span id="finalHighScore" class="font-bold">0</span></p>
    <p class="mt-6 text-lg">ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ 'ê²Œì„ ì‹œì‘' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
</div>

    <!-- ì¼ì‹œì •ì§€ ì˜¤ë²„ë ˆì´ --><div id="pauseOverlay" class="absolute inset-0 flex-col items-center justify-center bg-black bg-opacity-70 text-white text-center hidden">
    <h2 class="text-5xl retro-font text-purple-400 mb-4">PAUSED</h2>
    <p class="text-xl">ê³„ì†í•˜ë ¤ë©´ Esc í‚¤ ë˜ëŠ” í™”ë©´ì„ ë‹¤ì‹œ íƒ­í•˜ì„¸ìš”.</p>
</div>
</div>

    <!-- ì¡°ì‘ ì•ˆë‚´ --><div class="text-center text-gray-600 mt-4 p-3 bg-blue-50 rounded-lg shadow-sm">
    <p class="font-semibold text-lg mb-1">ì¡°ì‘ ë°©ë²•</p>
    <p class="text-md">
        <span class="font-mono font-bold text-gray-800">â†</span> /
        <span class="font-mono font-bold text-gray-800">â†’</span> ë˜ëŠ” í™”ë©´ í„°ì¹˜ (ì¢Œ/ìš°)
    </p>
    <p class="text-md">
        <span class="font-mono font-bold text-gray-800">Esc</span> í‚¤ë¡œ ì¼ì‹œì •ì§€ / ì¬ê°œ
    </p>
</div>
</div>

<script>
    // --- DOM ìš”ì†Œ ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const highScoreEl = document.getElementById('highScore');
    const livesEl = document.getElementById('lives');
    const startButton = document.getElementById('startButton');
    const startScreen = document.getElementById('startScreen');
    const startScreenHighScoreEl = document.getElementById('startScreenHighScore');
    const gameOverMessage = document.getElementById('gameOverMessage');
    const finalScoreEl = document.getElementById('finalScore');
    const finalHighScoreEl = document.getElementById('finalHighScore');
    const carSelectionGrid = document.getElementById('carSelectionGrid');
    const pauseOverlay = document.getElementById('pauseOverlay');

    // --- ì´ë¯¸ì§€ ë¡œë“œ ---
    const IMAGE_ROOT = 'https://raw.githubusercontent.com/s-yadav/Classic-Car-Racing-Game/master/assets/';
    const images = {};
    const imageFiles = [
        'playerCar_red.png', 'playerCar_blue.png', 'playerCar_green.png', 'playerCar_yellow.png',
        'enemyCar1.png', 'enemyCar2.png', 'enemyCar3.png', 'enemyCar4.png',
        'stopwatch.png', 'road_marker.png'
    ];
    let imagesLoadedCount = 0;
    let totalImagesToLoad = imageFiles.length;

    function loadImage(src, name) {
        const img = new Image();
        img.src = src;
        img.onload = () => {
            imagesLoadedCount++;
            if (imagesLoadedCount === totalImagesToLoad) {
                console.log('All images loaded!');
                initializeGame(); // ëª¨ë“  ì´ë¯¸ì§€ê°€ ë¡œë“œëœ í›„ ê²Œì„ ì´ˆê¸°í™”
            }
        };
        img.onerror = () => {
            console.error(`Failed to load image: ${src}`);
            imagesLoadedCount++; // ë¡œë“œ ì‹¤íŒ¨í•´ë„ ì¹´ìš´íŠ¸ëŠ” ì¦ê°€
            if (imagesLoadedCount === totalImagesToLoad) {
                console.log('All images (attempted) loaded!');
                initializeGame();
            }
        };
        images[name] = img;
    }

    imageFiles.forEach(file => {
        loadImage(IMAGE_ROOT + file, file.split('.')[0]);
    });

    // --- ê²Œì„ ì„¤ì • ---
    const GAME_CONFIG = {
        PLAYER_CAR_RATIO: 0.15, // ìº”ë²„ìŠ¤ ë„ˆë¹„ ëŒ€ë¹„ í”Œë ˆì´ì–´ ìë™ì°¨ ë„ˆë¹„ ë¹„ìœ¨
        ENEMY_CAR_RATIO: 0.15, // ìº”ë²„ìŠ¤ ë„ˆë¹„ ëŒ€ë¹„ ì  ìë™ì°¨ ë„ˆë¹„ ë¹„ìœ¨
        LANE_COUNT: 3, // ì°¨ì„  ìˆ˜
        ROAD_SHOULDER_RATIO: 0.08, // ê°“ê¸¸ ë¹„ìœ¨ (í•œìª½)
        LANE_MARKER_WIDTH_RATIO: 0.01,
        LANE_MARKER_HEIGHT_RATIO: 0.04,
        ITEM_RATIO: 0.08,
        SCORE_PER_FRAME: 1,
        SPEED_INCREMENT_INTERVAL: 500, // ì´ ì ìˆ˜ë§ˆë‹¤ ê²Œì„ ì†ë„ ì¦ê°€
        SPEED_INCREMENT_AMOUNT: 0.5,
        INITIAL_ENEMY_SPAWN_INTERVAL: 100, // í”„ë ˆì„
        MIN_ENEMY_SPAWN_INTERVAL: 30,
        ENEMY_SPAWN_DECREASE_RATE: 0.5,
        INITIAL_ITEM_SPAWN_CHANCE: 0.005, // 0.5%
        MAX_ITEM_SPAWN_CHANCE: 0.02, // 2%
        ITEM_SPAWN_CHANCE_INCREMENT: 0.0001,
    };

    // --- ìë™ì°¨ ë°ì´í„° ---
    const CAR_DATA = [
        { id: 'redCar', name: 'ë ˆë“œ ìŠ¤í†°', file: 'playerCar_red.png', unlockedAt: 0,
            initialSpeed: 4, maxSpeed: 10, acceleration: 0.01, lives: 3 },
        { id: 'blueCar', name: 'ë¸”ë£¨ ë¼ì´íŠ¸ë‹', file: 'playerCar_blue.png', unlockedAt: 1000,
            initialSpeed: 5, maxSpeed: 12, acceleration: 0.008, lives: 2 },
        { id: 'greenCar', name: 'ê·¸ë¦° ë¯¸ë¼ì§€', file: 'playerCar_green.png', unlockedAt: 3000,
            initialSpeed: 6, maxSpeed: 14, acceleration: 0.007, lives: 1 },
        { id: 'yellowCar', name: 'ê³¨ë“  ì¬ë”', file: 'playerCar_yellow.png', unlockedAt: 5000,
            initialSpeed: 7, maxSpeed: 15, acceleration: 0.006, lives: 1 }
    ];

    const ENEMY_CAR_FILES = ['enemyCar1.png', 'enemyCar2.png', 'enemyCar3.png', 'enemyCar4.png'];
    const ITEM_FILES = [{ id: 'stopwatch', file: 'stopwatch.png', duration: 3000 }]; // 3ì´ˆ

    // --- ê²Œì„ ë³€ìˆ˜ ---
    let player;
    let enemies = [];
    let laneMarkers = [];
    let items = [];
    let score = 0;
    let highScore = localStorage.getItem('racingHighScore') ? parseInt(localStorage.getItem('racingHighScore')) : 0;
    let lives = 0;
    let currentCarData; // í˜„ì¬ ì„ íƒëœ ìë™ì°¨ì˜ ë°ì´í„°
    let isPlaying = false;
    let isPaused = false;
    let gameSpeed = 0; // í˜„ì¬ ê²Œì„ ì†ë„ (í”Œë ˆì´ì–´ì˜ ì‹œì‘ì†ë„ + ê°€ì†ë„)
    let playerSpeed = 0; // í”Œë ˆì´ì–´ì˜ í˜„ì¬ ì‹¤ì œ ì†ë„ (ê²Œì„ ì†ë„ + ì•ŒíŒŒ)
    let enemySpawnTimer = 0;
    let currentEnemySpawnInterval = GAME_CONFIG.INITIAL_ENEMY_SPAWN_INTERVAL;
    let laneMarkerSpawnTimer = 0;
    let itemSpawnTimer = 0;
    let currentItemSpawnChance = GAME_CONFIG.INITIAL_ITEM_SPAWN_CHANCE;
    let gameLoopId;

    // ë¬´ì  ìƒíƒœ ë³€ìˆ˜
    let isInvincible = false;
    let invincibleTimer = 0;
    const INVINCIBLE_DURATION = 3000; // 3ì´ˆ

    // í‚¤ë³´ë“œ ì…ë ¥ ìƒíƒœ
    const keys = {
        ArrowLeft: false,
        ArrowRight: false,
        Escape: false, // ì¼ì‹œì •ì§€
    };

    // í„°ì¹˜ ì…ë ¥ ìƒíƒœ
    let touchSide = 'none'; // 'left', 'right', 'none'

    // --- ìœ í‹¸ë¦¬í‹° ---
    function resizeCanvas() {
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;

        // í”Œë ˆì´ì–´ê°€ ìˆì„ ê²½ìš° ìœ„ì¹˜ ì¬ì¡°ì • (ë¹„ìœ¨ ìœ ì§€)
        if (player) {
            const oldX = player.x / player.originalCanvasWidth;
            const oldY = player.y / player.originalCanvasHeight;
            player.width = canvas.width * GAME_CONFIG.PLAYER_CAR_RATIO;
            player.height = player.width * (player.originalImageHeight / player.originalImageWidth);
            player.x = oldX * canvas.width;
            player.y = oldY * canvas.height;
            player.originalCanvasWidth = canvas.width;
            player.originalCanvasHeight = canvas.height;
        }
        // ëª¨ë“  ê°ì²´ë“¤ì´ ìº”ë²„ìŠ¤ í¬ê¸°ì— ë§ì¶° ë¹„ìœ¨ì„ ìœ ì§€í•˜ë„ë¡ ì¬ì¡°ì • í•„ìš” (ë³µì¡í•˜ë¯€ë¡œ ê²Œì„ ì‹œì‘ ì‹œ ì´ˆê¸°í™”)
    }

    function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function drawLives() {
        livesEl.textContent = 'â¤ï¸'.repeat(lives);
    }

    // --- ê²Œì„ ê°ì²´ í´ë˜ìŠ¤ ---
    class GameObject {
        constructor(imageName, widthRatio, x, y, speedY = 0) {
            this.image = images[imageName];
            this.originalImageWidth = this.image ? this.image.width : 1;
            this.originalImageHeight = this.image ? this.image.height : 1;
            this.width = canvas.width * widthRatio;
            this.height = this.width * (this.originalImageHeight / this.originalImageWidth);
            this.x = x;
            this.y = y;
            this.speedY = speedY; // Yì¶• ì´ë™ ì†ë„
        }

        draw() {
            if (this.image && this.image.complete) {
                ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
            } else {
                // ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ì‚¬ê°í˜•ìœ¼ë¡œ í‘œì‹œ
                ctx.fillStyle = 'purple';
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
        }

        update() {
            this.y += this.speedY;
        }

        getBounds() {
            return {
                x: this.x,
                y: this.y,
                width: this.width,
                height: this.height
            };
        }
    }

    class Player extends GameObject {
        constructor(carData) {
            super(carData.file.split('.')[0], GAME_CONFIG.PLAYER_CAR_RATIO, 0, 0); // ì´ˆê¸° x, yëŠ” ë‚˜ì¤‘ì— ì„¤ì •
            this.x = canvas.width / 2 - this.width / 2;
            this.y = canvas.height - this.height - 20;
            this.moveSpeed = 7; // ì¢Œìš° ì´ë™ ì†ë„
            this.maxGameSpeed = carData.maxSpeed;
            this.initialGameSpeed = carData.initialSpeed;
            this.acceleration = carData.acceleration;

            // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ë¹„ìœ¨ ìœ ì§€ë¥¼ ìœ„í•œ ê°’ ì €ì¥
            this.originalCanvasWidth = canvas.width;
            this.originalCanvasHeight = canvas.height;
        }

        update() {
            if (keys.ArrowLeft || touchSide === 'left') {
                this.x -= this.moveSpeed;
            }
            if (keys.ArrowRight || touchSide === 'right') {
                this.x += this.moveSpeed;
            }

            // ìº”ë²„ìŠ¤ ê²½ê³„ ì²´í¬ (ê°“ê¸¸ í¬í•¨)
            const shoulderWidth = canvas.width * GAME_CONFIG.ROAD_SHOULDER_RATIO;
            if (this.x < shoulderWidth) this.x = shoulderWidth;
            if (this.x + this.width > canvas.width - shoulderWidth) {
                this.x = canvas.width - this.width - shoulderWidth;
            }
        }
    }

    class Enemy extends GameObject {
        constructor() {
            const enemyImageName = ENEMY_CAR_FILES[randomInt(0, ENEMY_CAR_FILES.length - 1)].split('.')[0];
            super(enemyImageName, GAME_CONFIG.ENEMY_CAR_RATIO, 0, 0);

            // ì°¨ì„  ê³„ì‚°
            const roadWidth = canvas.width * (1 - GAME_CONFIG.ROAD_SHOULDER_RATIO * 2);
            const roadStartX = canvas.width * GAME_CONFIG.ROAD_SHOULDER_RATIO;
            const laneWidth = roadWidth / GAME_CONFIG.LANE_COUNT;

            const lane = randomInt(0, GAME_CONFIG.LANE_COUNT - 1);
            this.x = roadStartX + lane * laneWidth + (laneWidth / 2) - (this.width / 2);

            this.y = -this.height; // í™”ë©´ ìœ„ì—ì„œ ì‹œì‘
            this.speedY = gameSpeed + Math.random() * 2 - 1; // ê¸°ë³¸ ì†ë„ + ì•½ê°„ì˜ ëœë¤ì„±
        }
    }

    class LaneMarker extends GameObject {
        constructor() {
            super('road_marker', GAME_CONFIG.LANE_MARKER_WIDTH_RATIO, 0, 0);
            this.height = canvas.width * GAME_CONFIG.LANE_MARKER_HEIGHT_RATIO; // ë„ˆë¹„ ë¹„ìœ¨ë¡œ ë†’ì´ ì„¤ì •

            const roadWidth = canvas.width * (1 - GAME_CONFIG.ROAD_SHOULDER_RATIO * 2);
            const roadStartX = canvas.width * GAME_CONFIG.ROAD_SHOULDER_RATIO;
            const laneWidth = roadWidth / GAME_CONFIG.LANE_COUNT;

            // 2ê°œì˜ ì°¨ì„  ë¶„ë¦¬ ë§ˆì»¤
            const markerLane = randomInt(1, GAME_CONFIG.LANE_COUNT - 1); // 1 ë˜ëŠ” 2
            this.x = roadStartX + laneWidth * markerLane - (this.width / 2);
            this.y = -this.height;
            this.speedY = gameSpeed;
        }
        // LaneMarkerëŠ” ì´ë¯¸ GameObjectì˜ updateë¥¼ ì‚¬ìš©
    }

    class Item extends GameObject {
        constructor(itemId) {
            const itemData = ITEM_FILES.find(item => item.id === itemId);
            super(itemData.file.split('.')[0], GAME_CONFIG.ITEM_RATIO, 0, 0);

            const roadWidth = canvas.width * (1 - GAME_CONFIG.ROAD_SHOULDER_RATIO * 2);
            const roadStartX = canvas.width * GAME_CONFIG.ROAD_SHOULDER_RATIO;
            const laneWidth = roadWidth / GAME_CONFIG.LANE_COUNT;

            const lane = randomInt(0, GAME_CONFIG.LANE_COUNT - 1);
            this.x = roadStartX + lane * laneWidth + (laneWidth / 2) - (this.width / 2);

            this.y = -this.height;
            this.speedY = gameSpeed;
            this.id = itemId;
        }
    }

    // --- ê²Œì„ ë¡œì§ í•¨ìˆ˜ ---
    function initializeGame() {
        resizeCanvas();
        highScoreEl.textContent = highScore;
        startScreenHighScoreEl.textContent = highScore;
        renderCarSelection(); // ìë™ì°¨ ì„ íƒ UI ë Œë”ë§

        // ì²˜ìŒì—ëŠ” ì‹œì‘ í™”ë©´ ë³´ì—¬ì£¼ê¸°
        startScreen.classList.remove('hidden');
        gameOverMessage.classList.add('hidden');
        pauseOverlay.classList.add('hidden');
        canvas.style.display = 'none'; // ê²Œì„ ìº”ë²„ìŠ¤ ìˆ¨ê¸°ê¸°
        startButton.textContent = 'ê²Œì„ ì‹œì‘'; // ì‹œì‘ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
    }

    function startGame() {
        if (isPlaying) return; // ì´ë¯¸ ì‹œì‘ëœ ê²½ìš° ë¬´ì‹œ

        // ì„ íƒëœ ìë™ì°¨ê°€ ì—†ìœ¼ë©´ ì‹œì‘ ë¶ˆê°€
        if (!currentCarData) {
            alert('í”Œë ˆì´í•  ìë™ì°¨ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
            return;
        }

        isPlaying = true;
        isPaused = false;

        // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
        score = 0;
        lives = currentCarData.lives; // ì„ íƒëœ ì°¨ì˜ ìƒëª…ë ¥ìœ¼ë¡œ ì´ˆê¸°í™”
        gameSpeed = currentCarData.initialSpeed; // ì„ íƒëœ ì°¨ì˜ ì‹œì‘ ì†ë„ë¡œ ì´ˆê¸°í™”
        playerSpeed = currentCarData.initialSpeed; // í”Œë ˆì´ì–´ì˜ ì´ˆê¸° ì†ë„
        enemies = [];
        laneMarkers = [];
        items = [];
        enemySpawnTimer = 0;
        currentEnemySpawnInterval = GAME_CONFIG.INITIAL_ENEMY_SPAWN_INTERVAL;
        laneMarkerSpawnTimer = 0;
        itemSpawnTimer = 0;
        currentItemSpawnChance = GAME_CONFIG.INITIAL_ITEM_SPAWN_CHANCE;
        isInvincible = false;
        invincibleTimer = 0;

        // í”Œë ˆì´ì–´ (ì¬)ìƒì„±
        player = new Player(currentCarData);

        // UI ì—…ë°ì´íŠ¸
        scoreEl.textContent = score;
        drawLives();
        startButton.textContent = 'ì¬ì‹œì‘';
        startButton.blur(); // ë²„íŠ¼ í¬ì»¤ìŠ¤ í•´ì œ
        gameOverMessage.classList.add('hidden');
        startScreen.classList.add('hidden'); // ì‹œì‘ í™”ë©´ ìˆ¨ê¸°ê¸°
        pauseOverlay.classList.add('hidden');
        canvas.style.display = 'block'; // ê²Œì„ ìº”ë²„ìŠ¤ ë³´ì´ê¸°

        // ê¸°ì¡´ ë£¨í”„ ì¤‘ì§€ (ìˆì„ ê²½ìš°)
        if (gameLoopId) {
            cancelAnimationFrame(gameLoopId);
        }

        // ìƒˆ ê²Œì„ ë£¨í”„ ì‹œì‘
        gameLoop();
    }

    function togglePause() {
        isPaused = !isPaused;
        if (isPaused) {
            cancelAnimationFrame(gameLoopId);
            pauseOverlay.classList.remove('hidden');
        } else {
            pauseOverlay.classList.add('hidden');
            gameLoop();
        }
    }

    function gameOver() {
        isPlaying = false;
        cancelAnimationFrame(gameLoopId);

        // ìµœê³  ì ìˆ˜ ì—…ë°ì´íŠ¸
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('racingHighScore', highScore);
        }
        highScoreEl.textContent = highScore;
        startScreenHighScoreEl.textContent = highScore; // ì‹œì‘ í™”ë©´ì—ë„ ì—…ë°ì´íŠ¸

        // ê²Œì„ ì˜¤ë²„ ë©”ì‹œì§€ í‘œì‹œ
        finalScoreEl.textContent = score;
        finalHighScoreEl.textContent = highScore;
        gameOverMessage.classList.remove('hidden');
        startButton.textContent = 'ê²Œì„ ì‹œì‘';

        // ì‹œì‘ í™”ë©´ì—ì„œ ìë™ì°¨ ì ê¸ˆ í•´ì œ ì—¬ë¶€ ì—…ë°ì´íŠ¸
        renderCarSelection();
    }

    function checkCollision(obj1, obj2) {
        const b1 = obj1.getBounds();
        const b2 = obj2.getBounds();

        return (
            b1.x < b2.x + b2.width &&
            b1.x + b1.width > b2.x &&
            b1.y < b2.y + b2.height &&
            b1.y + b1.height > b2.y
        );
    }

    function spawnEnemy() {
        enemySpawnTimer++;
        if (enemySpawnTimer > currentEnemySpawnInterval) {
            enemies.push(new Enemy());
            enemySpawnTimer = 0;

            // ë‚œì´ë„ ì¡°ì ˆ: ìŠ¤í° ê°„ê²© ì ì°¨ ì¤„ì„
            if (currentEnemySpawnInterval > GAME_CONFIG.MIN_ENEMY_SPAWN_INTERVAL) {
                currentEnemySpawnInterval -= GAME_CONFIG.ENEMY_SPAWN_DECREASE_RATE;
            }
        }
    }

    function spawnLaneMarkers() {
        laneMarkerSpawnTimer++;
        // ì†ë„ê°€ ë¹ ë¥¼ìˆ˜ë¡ ì°¨ì„ ì´ ìì£¼ ê·¸ë ¤ì§€ëŠ” ë“¯í•œ íš¨ê³¼
        const markerSpawnRate = Math.max(10, 50 - gameSpeed * 2);
        if (laneMarkerSpawnTimer > markerSpawnRate) {
            laneMarkers.push(new LaneMarker());
            laneMarkerSpawnTimer = 0;
        }
    }

    function spawnItem() {
        itemSpawnTimer++;
        if (Math.random() < currentItemSpawnChance && itemSpawnTimer > 300) { // ì¼ì • ì‹œê°„ í›„ í™•ë¥  ì²´í¬
            items.push(new Item('stopwatch')); // í˜„ì¬ëŠ” ìŠ¤í†±ì›Œì¹˜ë§Œ
            itemSpawnTimer = 0;
            currentItemSpawnChance += GAME_CONFIG.ITEM_SPAWN_CHANCE_INCREMENT;
            if (currentItemSpawnChance > GAME_CONFIG.MAX_ITEM_SPAWN_CHANCE) {
                currentItemSpawnChance = GAME_CONFIG.MAX_ITEM_SPAWN_CHANCE;
            }
        }
    }

    function activateStopwatch() {
        isInvincible = true;
        invincibleTimer = INVINCIBLE_DURATION;
        playerSpeed = currentCarData.maxSpeed * 1.5; // ìµœëŒ€ ì†ë„ë³´ë‹¤ ë” ë¹ ë¥´ê²Œ
        // ì¶©ëŒí•˜ëŠ” ì  ì°¨ë“¤ì„ ë‚ ë ¤ë²„ë¦¬ëŠ” íš¨ê³¼ëŠ” ì¶©ëŒ ê°ì§€ ë¡œì§ì—ì„œ ì²˜ë¦¬
        console.log('ìŠ¤í†±ì›Œì¹˜ ë°œë™! ë¬´ì  ë° ìŠˆí¼ ìŠ¤í”¼ë“œ!');
    }

    function updateGameObjects() {
        if (!isPlaying || isPaused) return;

        // í”Œë ˆì´ì–´ ì†ë„ ì¦ê°€
        gameSpeed = Math.min(currentCarData.maxSpeed, gameSpeed + currentCarData.acceleration);
        playerSpeed = gameSpeed; // ê¸°ë³¸ì ìœ¼ë¡œ ê²Œì„ ìŠ¤í”¼ë“œì™€ ë™ì¼

        // ë¬´ì  ìƒíƒœ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
        if (isInvincible) {
            invincibleTimer -= (1000 / 60); // 1ì´ˆ = 1000ms, 60fps ê¸°ì¤€
            if (invincibleTimer <= 0) {
                isInvincible = false;
                playerSpeed = gameSpeed; // ì›ë˜ ì†ë„ë¡œ ëŒì•„ì˜´
                console.log('ë¬´ì  í•´ì œ!');
            }
        }

        // í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸
        player.update();

        // ì°¨ì„  ì—…ë°ì´íŠ¸
        spawnLaneMarkers();
        laneMarkers.forEach((marker, index) => {
            marker.speedY = gameSpeed; // ì°¨ì„  ì†ë„ëŠ” í•­ìƒ ê²Œì„ ì†ë„ì™€ ë™ì¼
            marker.update();
            if (marker.y > canvas.height) {
                laneMarkers.splice(index, 1);
            }
        });

        // ì êµ° ì—…ë°ì´íŠ¸
        spawnEnemy();
        enemies.forEach((enemy, index) => {
            enemy.speedY = enemy.originalSpeedY || gameSpeed + Math.random() * 2 - 1; // ìŠ¤í†±ì›Œì¹˜ ì¤‘ì—” ê³ ì •
            enemy.update();

            // ì¶©ëŒ ê°ì§€
            if (checkCollision(player, enemy)) {
                if (isInvincible) {
                    // ë¬´ì  ìƒíƒœì¼ ë•Œ ì ì„ í™”ë©´ ë°–ìœ¼ë¡œ ë‚ ë ¤ë²„ë¦¼
                    enemy.y = canvas.height + 100;
                    enemy.speedY = 0; // ë” ì´ìƒ ì›€ì§ì´ì§€ ì•Šë„ë¡
                    score += 50; // ë‚ ë ¤ë²„ë¦° ì ì— ëŒ€í•œ ì¶”ê°€ ì ìˆ˜
                } else {
                    lives--;
                    drawLives();
                    // ì¶©ëŒ í›„ ì ê¹ì˜ ë¬´ì  ì‹œê°„ (ê¹œë¹¡ì„ íš¨ê³¼)ì„ ì¤„ ìˆ˜ë„ ìˆìŒ
                    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ í•œ ë²ˆì˜ ì¶©ëŒì— í•œ ìƒëª… ì†Œëª¨
                    enemies.splice(index, 1); // ì¶©ëŒí•œ ì ì€ ì‚¬ë¼ì§
                    if (lives <= 0) {
                        gameOver();
                    }
                }
            }

            // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°„ ì  ì œê±°
            if (enemy.y > canvas.height) {
                enemies.splice(index, 1);
                // ì ì„ í”¼í•˜ë©´ ì ìˆ˜ íšë“ (ìƒì¡´ ì‹œê°„ ì ìˆ˜ì™€ ë³„ê°œ)
                score += 10;
            }
        });

        // ì•„ì´í…œ ì—…ë°ì´íŠ¸
        spawnItem();
        items.forEach((item, index) => {
            item.speedY = gameSpeed;
            item.update();

            // ì•„ì´í…œ íšë“ ê°ì§€
            if (checkCollision(player, item)) {
                if (item.id === 'stopwatch') {
                    activateStopwatch();
                }
                items.splice(index, 1); // íšë“í•œ ì•„ì´í…œì€ ì‚¬ë¼ì§
            }

            // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°„ ì•„ì´í…œ ì œê±°
            if (item.y > canvas.height) {
                items.splice(index, 1);
            }
        });

        // ì ìˆ˜ ì—…ë°ì´íŠ¸
        score += GAME_CONFIG.SCORE_PER_FRAME;
        scoreEl.textContent = score;

        // ìµœê³  ì ìˆ˜ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„)
        if (score > highScore) {
            highScore = score;
            highScoreEl.textContent = highScore;
        }

        // ë‚œì´ë„ ì—…ë°ì´íŠ¸ (ê²Œì„ ì†ë„ ì¦ê°€)
        // if (score % GAME_CONFIG.SPEED_INCREMENT_INTERVAL === 0 && score > 0) {
        //     gameSpeed += GAME_CONFIG.SPEED_INCREMENT_AMOUNT;
        //     if (gameSpeed > currentCarData.maxSpeed) {
        //         gameSpeed = currentCarData.maxSpeed;
        //     }
        // }
        // ê°€ì†ë„ ë¡œì§ìœ¼ë¡œ ë³€ê²½ë˜ì–´ ìœ„ ì½”ë“œëŠ” ì£¼ì„ ì²˜ë¦¬
    }

    function drawGameObjects() {
        // ìº”ë²„ìŠ¤ í´ë¦¬ì–´ (ë„ë¡œìƒ‰ìœ¼ë¡œ)
        ctx.fillStyle = '#6c757d'; // ì–´ë‘ìš´ íšŒìƒ‰ (ë„ë¡œ)
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ê°“ê¸¸ (ì”ë””)
        ctx.fillStyle = '#28A745'; // ì´ˆë¡ìƒ‰
        const shoulderWidth = canvas.width * GAME_CONFIG.ROAD_SHOULDER_RATIO;
        ctx.fillRect(0, 0, shoulderWidth, canvas.height);
        ctx.fillRect(canvas.width - shoulderWidth, 0, shoulderWidth, canvas.height);

        // ì°¨ì„  ê·¸ë¦¬ê¸°
        laneMarkers.forEach(marker => marker.draw());

        // ì êµ° ê·¸ë¦¬ê¸°
        enemies.forEach(enemy => enemy.draw());

        // ì•„ì´í…œ ê·¸ë¦¬ê¸°
        items.forEach(item => item.draw());

        // í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸°
        if (player) {
            if (isInvincible) {
                // ë¬´ì  ìƒíƒœì¼ ë•Œ í”Œë ˆì´ì–´ ê¹œë¹¡ì„ íš¨ê³¼
                if (Math.floor(invincibleTimer / 100) % 2 === 0) { // 0.1ì´ˆë§ˆë‹¤ ê¹œë¹¡
                    player.draw();
                }
            } else {
                player.draw();
            }
        }
    }

    // --- ë©”ì¸ ê²Œì„ ë£¨í”„ ---
    function gameLoop() {
        if (!isPlaying || isPaused) return;

        updateGameObjects();
        drawGameObjects();

        gameLoopId = requestAnimationFrame(gameLoop);
    }

    // --- ìë™ì°¨ ì„ íƒ UI ë Œë”ë§ ---
    function renderCarSelection() {
        carSelectionGrid.innerHTML = '';
        CAR_DATA.forEach(car => {
            const card = document.createElement('div');
            card.classList.add('car-card');
            card.dataset.carId = car.id;

            const isLocked = highScore < car.unlockedAt;
            if (isLocked) {
                card.classList.add('locked');
            } else {
                card.addEventListener('click', () => selectCar(car.id));
            }

            const img = document.createElement('img');
            img.src = IMAGE_ROOT + car.file;
            img.alt = car.name;
            card.appendChild(img);

            const name = document.createElement('p');
            name.classList.add('font-bold', 'text-sm', 'text-gray-800');
            name.textContent = car.name;
            card.appendChild(name);

            const stats = document.createElement('div');
            stats.classList.add('car-stats');
            stats.innerHTML = `
                    <p>ìƒëª…: ${'â¤ï¸'.repeat(car.lives)}</p>
                    <p>ìµœëŒ€ì†ë„: ${car.maxSpeed}</p>
                    <p>ê°€ì†: ${car.acceleration.toFixed(3)}</p>
                    ${isLocked ? `<p class="text-red-500 mt-1">ì ê¸ˆ í•´ì œ: ${car.unlockedAt}ì </p>` : ''}
                `;
            card.appendChild(stats);

            carSelectionGrid.appendChild(card);
        });
        // ì´ì „ì— ì„ íƒëœ ì°¨ê°€ ìˆë‹¤ë©´ ë‹¤ì‹œ ì„ íƒ í‘œì‹œ
        if (currentCarData) {
            const selected = document.querySelector(`.car-card[data-car-id="${currentCarData.id}"]`);
            if (selected) {
                selected.classList.add('selected');
            }
        } else {
            // ê¸°ë³¸ìœ¼ë¡œ ì²« ë²ˆì§¸ ì°¨ ì„ íƒ
            selectCar(CAR_DATA[0].id);
        }
    }

    function selectCar(carId) {
        const selectedCar = CAR_DATA.find(car => car.id === carId);
        if (!selectedCar || highScore < selectedCar.unlockedAt) {
            return; // ì ê¸´ ì°¨ëŠ” ì„ íƒ ë¶ˆê°€
        }

        currentCarData = selectedCar;

        // ëª¨ë“  ì¹´ë“œì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
        document.querySelectorAll('.car-card').forEach(card => {
            card.classList.remove('selected');
        });
        // ì„ íƒëœ ì¹´ë“œì— selected í´ë˜ìŠ¤ ì¶”ê°€
        document.querySelector(`.car-card[data-car-id="${carId}"]`).classList.add('selected');
        console.log(`ì°¨ëŸ‰ ì„ íƒ: ${currentCarData.name}`);
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

    // 1. ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì ˆ
    window.addEventListener('resize', resizeCanvas);

    // 2. í‚¤ë³´ë“œ ì…ë ¥
    window.addEventListener('keydown', (e) => {
        if (keys.hasOwnProperty(e.key)) {
            keys[e.key] = true;
        }
        if (e.key === 'Escape') {
            if (isPlaying && !gameOverMessage.classList.contains('hidden')) return; // ê²Œì„ ì˜¤ë²„ ìƒíƒœì—ì„œëŠ” ì¼ì‹œì •ì§€ ë¶ˆê°€
            if (isPlaying) { // ê²Œì„ ì¤‘ì¼ ë•Œë§Œ ì¼ì‹œì •ì§€
                togglePause();
            } else if (!startScreen.classList.contains('hidden')) { // ì‹œì‘ í™”ë©´ì—ì„œ Esc ëˆ„ë¥´ë©´ ì•„ë¬´ê²ƒë„ ì•ˆí•¨
                e.preventDefault();
            }
        }
    });

    window.addEventListener('keyup', (e) => {
        if (keys.hasOwnProperty(e.key)) {
            keys[e.key] = false;
        }
    });

    // 3. í„°ì¹˜ ì…ë ¥
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (isPlaying && isPaused) { // ì¼ì‹œì •ì§€ ìƒíƒœì—ì„œ í„°ì¹˜ ì‹œ ì¬ê°œ
            togglePause();
            return;
        }
        handleTouch(e.touches[0]);
    }, { passive: false });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        handleTouch(e.touches[0]);
    }, { passive: false });

    canvas.addEventListener('touchend', () => {
        touchSide = 'none';
    });

    function handleTouch(touch) {
        const touchX = touch.clientX - canvas.getBoundingClientRect().left;
        if (touchX < canvas.width / 2) {
            touchSide = 'left';
        } else {
            touchSide = 'right';
        }
    }

    // 4. ì‹œì‘ ë²„íŠ¼
    startButton.addEventListener('click', startGame);

    // --- ê²Œì„ ì‹œì‘ ì‹œ ì´ˆê¸°í™” ---
    // ëª¨ë“  ì´ë¯¸ì§€ê°€ ë¡œë“œëœ í›„ initializeGameì´ í˜¸ì¶œë©ë‹ˆë‹¤.
    // í˜„ì¬ëŠ” ì´ë¯¸ì§€ ë¡œë“œ ì—†ì´ë„ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì •.

    // ì´ë¯¸ì§€ ë¡œë“œê°€ ì™„ë£Œëœ í›„ ì´ˆê¸°í™”
    if (imagesLoadedCount === totalImagesToLoad) {
        initializeGame();
    }
</script>
</body>
</html>

