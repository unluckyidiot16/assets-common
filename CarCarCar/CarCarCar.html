<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>질주 본능! 🚗💨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Pretendard', sans-serif;
            overflow: hidden;
            background-color: #f0f0f0;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        canvas {
            outline: none;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .retro-font {
            font-family: 'Press-Start-2P', cursive;
        }
        .car-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .car-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .car-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .car-card.selected {
            border-color: #2563eb;
            background-color: #e0f2fe;
            box-shadow: 0 4px 12px rgba(37,99,235,0.2);
        }
        .car-card.locked {
            filter: grayscale(100%) brightness(50%);
            cursor: not-allowed;
        }
        .car-card.locked::after {
            content: '🔒';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            color: rgba(255,255,255,0.7);
            text-shadow: 0 0 5px black;
        }
        .car-card img {
            width: 80%;
            height: auto;
            margin: 0 auto 5px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        .car-stats {
            margin-top: 5px;
            font-size: 0.75em;
            color: #4a5568;
        }
        .car-stats p {
            margin: 2px 0;
            line-height: 1.2;
        }

        /* 부스터 게이지 */
        .booster-gauge-container {
            width: 100px;
            height: 12px;
            background-color: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #ccc;
        }
        .booster-gauge-fill {
            width: 0%;
            height: 100%;
            background-color: #2563eb;
            transition: width 0.1s linear;
            border-radius: 6px;
        }

        /* 터치 버튼 */
        .touch-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 25%; /* 화면 하단 25% 영역 */
            display: flex;
            z-index: 10;
        }
        .touch-btn {
            width: 33.33%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            margin: 10px;
            -webkit-tap-highlight-color: transparent;
        }
        .touch-btn.boost {
            font-size: 1.2rem;
            font-weight: bold;
            background-color: rgba(37, 99, 235, 0.3);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="w-full max-w-lg mx-auto p-4 bg-white rounded-xl shadow-lg relative">
    <h1 class="text-4xl retro-font text-center text-blue-700 mb-6">질주 본능!</h1>

    <!-- 점수 및 생명력 UI -->
    <div class="mb-4 p-3 bg-blue-50 rounded-lg shadow-sm space-y-2">
        <div class="flex justify-between items-center">
            <div>
                <span class="font-semibold text-gray-700">최고:</span>
                <span id="highScore" class="font-bold text-lg text-indigo-700 ml-1">0</span>
            </div>
            <div>
                <span class="font-semibold text-gray-700">점수:</span>
                <span id="score" class="font-bold text-lg text-gray-800 ml-1">0</span>
            </div>
            <div>
                <span class="font-semibold text-gray-700">생명:</span>
                <span id="lives" class="font-bold text-lg text-red-600 ml-1">❤️</span>
            </div>
        </div>
        <div class="flex justify-between items-center">
            <div>
                <span class="font-semibold text-gray-700">속도:</span>
                <span id="speedometer" class="font-bold text-lg text-gray-800 ml-1">0</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="font-semibold text-gray-700 text-sm">부스터:</span>
                <div class="booster-gauge-container">
                    <div id="boosterGaugeFill" class="booster-gauge-fill"></div>
                </div>
            </div>
        </div>
    </div>


    <!-- 게임 영역 -->
    <div class="relative w-full aspect-[9/16] bg-gray-700 rounded-lg shadow-inner overflow-hidden mx-auto" style="max-height: 75vh;">
        <canvas id="gameCanvas" class="w-full h-full"></canvas>

        <!-- 터치 컨트롤 버튼 (게임 중에만 표시) -->
        <div id="touchControlsContainer" class="touch-controls hidden">
            <div id="leftBtn" class="touch-btn">◀</div>
            <div id="boostBtn" class="touch-btn boost">BOOST</div>
            <div id="rightBtn" class="touch-btn">▶</div>
        </div>

        <!-- 시작 화면 -->
        <div id="startScreen" class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-80 text-white p-4 z-20">
            <h2 class="text-4xl retro-font text-yellow-400 mb-6">START GAME</h2>

            <h3 class="text-xl font-bold mb-4">내 차 선택하기</h3>
            <div id="carSelectionGrid" class="car-select-grid w-full max-w-sm mb-6">
                <!-- 자동차 선택 카드가 여기에 동적으로 생성됩니다 -->
            </div>

            <button id="startButton" class="px-8 py-4 bg-green-500 text-white retro-font rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-400 focus:ring-opacity-75 transition duration-200 text-xl">
                게임 시작
            </button>
            <p class="text-sm text-gray-300 mt-4">최고 점수: <span id="startScreenHighScore">0</span></p>
        </div>

        <!-- 게임 오버 메시지 -->
        <div id="gameOverMessage" class="absolute inset-0 flex-col items-center justify-center bg-black bg-opacity-70 text-white text-center p-4 hidden z-20">
            <h2 class="text-5xl retro-font text-red-500 mb-4">GAME OVER!</h2>
            <p class="text-2xl mt-2">최종 점수: <span id="finalScore" class="font-bold">0</span></p>
            <p class="text-xl">최고 점수: <span id="finalHighScore" class="font-bold">0</span></p>
            <p class="mt-6 text-lg">다시 시작하려면 '게임 시작' 버튼을 누르세요.</p>
        </div>

        <!-- 일시정지 메시지 -->
        <div id="pauseOverlay" class="absolute inset-0 flex-col items-center justify-center bg-black bg-opacity-70 text-white text-center hidden z-20">
            <h2 class="text-5xl retro-font text-purple-400 mb-4">PAUSED</h2>
            <p class="text-xl">계속하려면 Esc 키 또는 화면을 다시 탭하세요.</p>
        </div>
    </div>

    <!-- 조작 안내 -->
    <div class="text-center text-gray-600 mt-4 p-3 bg-blue-50 rounded-lg shadow-sm">
        <p class="font-semibold text-lg mb-1">조작 방법</p>
        <p class="text-md">
            <span class="font-mono font-bold text-gray-800">←</span> /
            <span class="font-mono font-bold text-gray-800">→</span> : 이동
            <span class="font-mono font-bold text-gray-800 ml-2">B</span> : 부스터
        </p>
        <p class="text-md">
            <span class="font-mono font-bold text-gray-800">Esc</span> : 일시정지 / 재개
        </p>
    </div>
</div>

<script>
    // --- DOM 요소 ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const highScoreEl = document.getElementById('highScore');
    const livesEl = document.getElementById('lives');
    const speedometerEl = document.getElementById('speedometer');
    const boosterGaugeFillEl = document.getElementById('boosterGaugeFill');

    const startButton = document.getElementById('startButton');
    const startScreen = document.getElementById('startScreen');
    const startScreenHighScoreEl = document.getElementById('startScreenHighScore');
    const gameOverMessage = document.getElementById('gameOverMessage');
    const finalScoreEl = document.getElementById('finalScore');
    const finalHighScoreEl = document.getElementById('finalHighScore');
    const carSelectionGrid = document.getElementById('carSelectionGrid');
    const pauseOverlay = document.getElementById('pauseOverlay');

    // 터치 컨트롤
    const touchControlsContainer = document.getElementById('touchControlsContainer');
    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');
    const boostBtn = document.getElementById('boostBtn');


    // --- 이미지 로드 ---
    const IMAGE_ROOT = 'https://unluckyidiot16.github.io/assets-common/CarCarCar/';
    const images = {};

    const imageFiles = [
        'car.png', 'taxi.png', 'jeep.png', 'van_1.png', // 플레이어용
        'van_0.png', 'hurdle.png', 'road-barrier.png', // 장애물/적
        'construction.png', 'roadblock.png', // 장애물/적
        'stopwatch.png' // 아이템
    ];

    let imagesLoadedCount = 0;
    let totalImagesToLoad = imageFiles.length;

    function loadImage(src, name) {
        const img = new Image();
        img.src = src;
        img.onload = () => {
            imagesLoadedCount++;
            console.log(`Loaded image: ${name}`);
            if (imagesLoadedCount === totalImagesToLoad) {
                console.log('All images loaded!');
                initializeGame();
            }
        };
        img.onerror = () => {
            console.error(`Failed to load image: ${src}`);
            imagesLoadedCount++;
            if (imagesLoadedCount === totalImagesToLoad) {
                console.log('All images (attempted) loaded!');
                initializeGame();
            }
        };
        images[name] = img;
    }

    imageFiles.forEach(file => {
        loadImage(IMAGE_ROOT + file, file.split('.')[0]);
    });

    // --- 게임 설정 (밸런스 수정) ---
    const GAME_CONFIG = {
        // 스케일 조정 (4차선, 작은 스프라이트)
        PLAYER_CAR_RATIO: 0.13,
        ENEMY_CAR_RATIO: 0.13,
        LANE_COUNT: 4, // 4차선으로 변경
        ROAD_SHOULDER_RATIO: 0.08,
        LANE_MARKER_WIDTH_RATIO: 0.008, // 차선 마커 너비 축소
        LANE_MARKER_HEIGHT_RATIO: 0.04,
        ITEM_RATIO: 0.07, // 아이템 크기 축소

        SCORE_PER_FRAME: 1,
        // 스폰 난이도 조정
        INITIAL_ENEMY_SPAWN_INTERVAL: 100, // 초기 스폰 간격
        MIN_ENEMY_SPAWN_INTERVAL: 25, // 최대 난이도 스폰 간격 (더 어렵게)

        INITIAL_ITEM_SPAWN_CHANCE: 0.005,
        MAX_ITEM_SPAWN_CHANCE: 0.02,
        ITEM_SPAWN_CHANCE_INCREMENT: 0.0001,

        // 부스터 설정 (시간 비례 충전)
        MAX_BOOSTER: 100,
        BOOSTER_CONSUMPTION: 0.5,
        BOOSTER_CHARGE_PER_FRAME: 0.1, // 프레임당 충전량 (시간 비례)
        BOOST_ACCELERATION_MULTIPLIER: 5,
        BOOST_MAX_SPEED_MULTIPLIER: 1.3,

        // 스톱워치 설정
        INVINCIBLE_DURATION: 3000,
        INVINCIBLE_SPEED_MULTIPLIER: 1.5,
    };

    // --- 자동차 데이터 (생명력 밸런스 수정) ---
    const CAR_DATA = [
        { id: 'car', name: '블루 세단', file: 'car.png', unlockedAt: 0,
            initialSpeed: 4, maxSpeed: 10, acceleration: 0.01, lives: 1 }, // 생명 1
        { id: 'taxi', name: '스피드 택시', file: 'taxi.png', unlockedAt: 1000,
            initialSpeed: 5, maxSpeed: 12, acceleration: 0.008, lives: 2 }, // 생명 2
        { id: 'jeep', name: '터프 지프', file: 'jeep.png', unlockedAt: 3000,
            initialSpeed: 6, maxSpeed: 14, acceleration: 0.007, lives: 2 }, // 생명 2
        { id: 'van_1', name: '캠핑 밴', file: 'van_1.png', unlockedAt: 5000,
            initialSpeed: 7, maxSpeed: 15, acceleration: 0.006, lives: 3 }  // 생명 3
    ];

    const ENEMY_OBSTACLE_FILES = [
        'van_0.png',
        'hurdle.png',
        'road-barrier.png',
        'construction.png',
        'roadblock.png'
    ];

    const ITEM_FILES = [{ id: 'stopwatch', file: 'stopwatch.png', duration: GAME_CONFIG.INVINCIBLE_DURATION }];

    // --- 게임 변수 ---
    let player;
    let enemies = [];
    let laneMarkers = [];
    let items = [];
    let score = 0;
    let highScore = localStorage.getItem('racingHighScore') ? parseInt(localStorage.getItem('racingHighScore')) : 0;
    let lives = 0;
    let currentCarData;
    let isPlaying = false;
    let isPaused = false;
    let gameSpeed = 0;
    let enemySpawnTimer = 0;
    let currentEnemySpawnInterval = GAME_CONFIG.INITIAL_ENEMY_SPAWN_INTERVAL;
    let laneMarkerSpawnTimer = 0;
    let itemSpawnTimer = 0;
    let currentItemSpawnChance = GAME_CONFIG.INITIAL_ITEM_SPAWN_CHANCE;
    let gameLoopId;

    let isInvincible = false;
    let invincibleTimer = 0;
    let isBoosting = false;
    let boosterGauge = 0;

    const keys = {
        ArrowLeft: false,
        ArrowRight: false,
        Escape: false,
        b: false,
        B: false,
    };

    let touchSide = 'none';

    // --- 유틸리티 ---
    function resizeCanvas() {
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;

        if (player) {
            const oldX = player.x / player.originalCanvasWidth;
            player.width = canvas.width * GAME_CONFIG.PLAYER_CAR_RATIO;

            const img = images[player.imageName];
            if (img && img.complete && img.width > 0) {
                player.height = player.width * (img.height / img.width);
            } else {
                player.height = player.width * 1.6;
            }

            player.x = oldX * canvas.width;
            player.y = canvas.height - player.height - 20;
            player.originalCanvasWidth = canvas.width;
            player.originalCanvasHeight = canvas.height;
        }
    }

    function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function drawLives() {
        livesEl.textContent = '❤️'.repeat(Math.max(0, lives));
    }

    // --- 게임 객체 클래스 ---
    class GameObject {
        constructor(imageName, widthRatio, x, y, speedY = 0) {
            this.imageName = imageName;
            this.image = images[imageName];

            this.width = canvas.width * widthRatio;

            if (this.image && this.image.complete && this.image.width > 0) {
                this.originalImageWidth = this.image.width;
                this.originalImageHeight = this.image.height;
                this.height = this.width * (this.originalImageHeight / this.originalImageWidth);
            } else {
                this.originalImageWidth = 1;
                this.originalImageHeight = 1.6;
                this.height = this.width * this.originalImageHeight;
            }

            this.x = x;
            this.y = y;
            this.speedY = speedY;
        }

        draw() {
            if (this.image && this.image.complete) {
                ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
            } else {
                ctx.fillStyle = 'purple';
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
        }

        update() {
            this.y += this.speedY;
        }

        getBounds() {
            const paddingX = this.width * 0.1;
            const paddingY = this.height * 0.1;
            return {
                x: this.x + paddingX,
                y: this.y + paddingY,
                width: this.width - paddingX * 2,
                height: this.height - paddingY * 2
            };
        }
    }

    class Player extends GameObject {
        constructor(carData) {
            super(carData.file.split('.')[0], GAME_CONFIG.PLAYER_CAR_RATIO, 0, 0);
            this.x = canvas.width / 2 - this.width / 2;
            this.y = canvas.height - this.height - 20;
            this.moveSpeed = 7;
            this.maxGameSpeed = carData.maxSpeed;
            this.initialGameSpeed = carData.initialSpeed;
            this.acceleration = carData.acceleration;

            this.originalCanvasWidth = canvas.width;
            this.originalCanvasHeight = canvas.height;
        }

        update() {
            if (keys.ArrowLeft || touchSide === 'left') {
                this.x -= this.moveSpeed;
            }
            if (keys.ArrowRight || touchSide === 'right') {
                this.x += this.moveSpeed;
            }

            const shoulderWidth = canvas.width * GAME_CONFIG.ROAD_SHOULDER_RATIO;
            if (this.x < shoulderWidth) this.x = shoulderWidth;
            if (this.x + this.width > canvas.width - shoulderWidth) {
                this.x = canvas.width - this.width - shoulderWidth;
            }
        }
    }

    // (수정) Enemy 생성자가 lane을 인자로 받도록 변경
    class Enemy extends GameObject {
        constructor(lane) { // 'lane' 인자 추가
            const enemyImageName = ENEMY_OBSTACLE_FILES[randomInt(0, ENEMY_OBSTACLE_FILES.length - 1)].split('.')[0];
            super(enemyImageName, GAME_CONFIG.ENEMY_CAR_RATIO, 0, 0);

            const roadWidth = canvas.width * (1 - GAME_CONFIG.ROAD_SHOULDER_RATIO * 2);
            const roadStartX = canvas.width * GAME_CONFIG.ROAD_SHOULDER_RATIO;
            const laneWidth = roadWidth / GAME_CONFIG.LANE_COUNT;

            // const lane = randomInt(0, GAME_CONFIG.LANE_COUNT - 1); // (삭제)
            this.x = roadStartX + lane * laneWidth + (laneWidth / 2) - (this.width / 2);

            this.y = -this.height;
            this.originalRelativeSpeed = Math.random() * 2 + 1;
            this.speedY = gameSpeed + this.originalRelativeSpeed;
        }

        update() {
            this.y += this.speedY;
        }
    }

    // (수정) LaneMarker도 4차선에 맞게 조정
    class LaneMarker {
        constructor() {
            this.width = canvas.width * GAME_CONFIG.LANE_MARKER_WIDTH_RATIO;
            this.height = canvas.width * GAME_CONFIG.LANE_MARKER_HEIGHT_RATIO;

            const roadWidth = canvas.width * (1 - GAME_CONFIG.ROAD_SHOULDER_RATIO * 2);
            const roadStartX = canvas.width * GAME_CONFIG.ROAD_SHOULDER_RATIO;
            const laneWidth = roadWidth / GAME_CONFIG.LANE_COUNT;

            // 4차선이므로 마커는 1, 2, 3 차선에 생성
            const markerLane = randomInt(1, GAME_CONFIG.LANE_COUNT - 1); // 1, 2, 3
            this.x = roadStartX + laneWidth * markerLane - (this.width / 2);
            this.y = -this.height;
            this.speedY = gameSpeed;
        }

        draw() {
            ctx.fillStyle = 'white';
            ctx.fillRect(this.x, this.y, this.width, this.height);
        }

        update() {
            this.speedY = gameSpeed;
            this.y += this.speedY;
        }
    }

    class Item extends GameObject {
        constructor(itemId) {
            const itemData = ITEM_FILES.find(item => item.id === itemId);
            super(itemData.file.split('.')[0], GAME_CONFIG.ITEM_RATIO, 0, 0);

            const roadWidth = canvas.width * (1 - GAME_CONFIG.ROAD_SHOULDER_RATIO * 2);
            const roadStartX = canvas.width * GAME_CONFIG.ROAD_SHOULDER_RATIO;
            const laneWidth = roadWidth / GAME_CONFIG.LANE_COUNT;

            // 4차선
            const lane = randomInt(0, GAME_CONFIG.LANE_COUNT - 1);
            this.x = roadStartX + lane * laneWidth + (laneWidth / 2) - (this.width / 2);

            this.y = -this.height;
            this.speedY = gameSpeed;
            this.id = itemId;
        }

        update() {
            this.speedY = gameSpeed;
            super.update();
        }
    }

    // --- 게임 로직 함수 ---
    function initializeGame() {
        resizeCanvas();
        highScoreEl.textContent = highScore;
        startScreenHighScoreEl.textContent = highScore;
        renderCarSelection();

        startScreen.classList.remove('hidden');
        gameOverMessage.classList.add('hidden');
        pauseOverlay.classList.add('hidden');
        canvas.style.display = 'none';
        touchControlsContainer.classList.add('hidden');
        startButton.textContent = '게임 시작';
    }

    function startGame() {
        if (isPlaying) return;

        if (!currentCarData) {
            alert('플레이할 자동차를 선택해주세요!');
            return;
        }

        isPlaying = true;
        isPaused = false;

        score = 0;
        lives = currentCarData.lives;
        gameSpeed = currentCarData.initialSpeed;
        enemies = [];
        laneMarkers = [];
        items = [];
        enemySpawnTimer = 0;
        currentEnemySpawnInterval = GAME_CONFIG.INITIAL_ENEMY_SPAWN_INTERVAL;
        laneMarkerSpawnTimer = 0;
        itemSpawnTimer = 0;
        currentItemSpawnChance = GAME_CONFIG.INITIAL_ITEM_SPAWN_CHANCE;
        isInvincible = false;
        invincibleTimer = 0;
        isBoosting = false;
        boosterGauge = 0;

        player = new Player(currentCarData);

        scoreEl.textContent = score;
        speedometerEl.textContent = Math.round(gameSpeed * 10);
        boosterGaugeFillEl.style.width = '0%';
        drawLives();
        startButton.textContent = '재시작';
        startButton.blur();
        gameOverMessage.classList.add('hidden');
        startScreen.classList.add('hidden');
        pauseOverlay.classList.add('hidden');
        canvas.style.display = 'block';
        touchControlsContainer.classList.remove('hidden');

        if (gameLoopId) {
            cancelAnimationFrame(gameLoopId);
        }

        gameLoop();
    }

    function togglePause() {
        if (!isPlaying) return;

        isPaused = !isPaused;
        if (isPaused) {
            cancelAnimationFrame(gameLoopId);
            pauseOverlay.classList.remove('hidden');
            touchControlsContainer.classList.add('hidden');
        } else {
            pauseOverlay.classList.add('hidden');
            touchControlsContainer.classList.remove('hidden');
            gameLoop();
        }
    }

    function gameOver() {
        isPlaying = false;
        cancelAnimationFrame(gameLoopId);

        if (score > highScore) {
            highScore = score;
            localStorage.setItem('racingHighScore', highScore);
        }
        highScoreEl.textContent = highScore;
        startScreenHighScoreEl.textContent = highScore;

        finalScoreEl.textContent = score;
        finalHighScoreEl.textContent = highScore;
        gameOverMessage.classList.remove('hidden');
        startButton.textContent = '게임 시작';
        touchControlsContainer.classList.add('hidden');

        renderCarSelection();

        setTimeout(() => {
            if (!isPlaying) {
                canvas.style.display = 'none';
                startScreen.classList.remove('hidden');
                gameOverMessage.classList.add('hidden');
            }
        }, 2000);
    }

    function checkCollision(obj1, obj2) {
        const b1 = obj1.getBounds();
        const b2 = obj2.getBounds();

        return (
            b1.x < b2.x + b2.width &&
            b1.x + b1.width > b2.x &&
            b1.y < b2.y + b2.height &&
            b1.y + b1.height > b2.y
        );
    }

    // (수정) 스폰 가드 로직 및 다중 스폰 로직 추가
    function spawnEnemy() {
        enemySpawnTimer++;
        if (enemySpawnTimer > currentEnemySpawnInterval) {

            let enemiesToSpawn = 1;
            if (score > 2000) enemiesToSpawn = randomInt(1, 2); // 1 또는 2
            if (score > 5000) enemiesToSpawn = randomInt(1, 3); // 1, 2, 또는 3

            // 스폰 가드: 최대 (차선-1)개 까지만 스폰
            enemiesToSpawn = Math.min(enemiesToSpawn, GAME_CONFIG.LANE_COUNT - 1);

            let occupiedLanes = new Set();

            for (let i = 0; i < enemiesToSpawn; i++) {
                let lane;
                let attempt = 0;
                // 겹치지 않는 빈 차선 찾기
                do {
                    lane = randomInt(0, GAME_CONFIG.LANE_COUNT - 1);
                    attempt++;
                } while (occupiedLanes.has(lane) && attempt < 10); // 10번 시도

                if (!occupiedLanes.has(lane)) {
                    occupiedLanes.add(lane);
                    enemies.push(new Enemy(lane)); // 선택된 차선에 생성
                }
            }

            enemySpawnTimer = 0;
        }
    }

    function spawnLaneMarkers() {
        laneMarkerSpawnTimer++;
        const markerSpawnRate = Math.max(10, 50 - gameSpeed * 2);
        if (laneMarkerSpawnTimer > markerSpawnRate) {
            laneMarkers.push(new LaneMarker());
            laneMarkerSpawnTimer = 0;
        }
    }

    function spawnItem() {
        itemSpawnTimer++;
        if (itemSpawnTimer > 300) {
            if (Math.random() < currentItemSpawnChance) {
                items.push(new Item('stopwatch'));
                itemSpawnTimer = 0;
                currentItemSpawnChance += GAME_CONFIG.ITEM_SPAWN_CHANCE_INCREMENT;
                if (currentItemSpawnChance > GAME_CONFIG.MAX_ITEM_SPAWN_CHANCE) {
                    currentItemSpawnChance = GAME_CONFIG.MAX_ITEM_SPAWN_CHANCE;
                }
            }
        }
    }

    function activateStopwatch() {
        isInvincible = true;
        invincibleTimer = GAME_CONFIG.INVINCIBLE_DURATION;
        console.log('스톱워치 발동!');
    }

    // (수정) 게임 로직 업데이트 (난이도, 부스터 충전)
    function updateGameObjects() {
        if (!isPlaying || isPaused) return;

        // --- 1. 속도 및 상태 결정 ---
        const boostKeyPressed = keys.b || keys.B;
        isBoosting = boostKeyPressed && boosterGauge > 0 && !isInvincible;

        if (isInvincible) {
            gameSpeed = currentCarData.maxSpeed * GAME_CONFIG.INVINCIBLE_SPEED_MULTIPLIER;
        } else if (isBoosting) {
            const boostMaxSpeed = currentCarData.maxSpeed * GAME_CONFIG.BOOST_MAX_SPEED_MULTIPLIER;
            const boostAcceleration = currentCarData.acceleration * GAME_CONFIG.BOOST_ACCELERATION_MULTIPLIER;
            gameSpeed = Math.min(boostMaxSpeed, gameSpeed + boostAcceleration);
            boosterGauge = Math.max(0, boosterGauge - GAME_CONFIG.BOOSTER_CONSUMPTION);
        } else { // 일반 주행
            gameSpeed = Math.min(currentCarData.maxSpeed, gameSpeed + currentCarData.acceleration);
        }

        // (수정) 부스터가 소모되지 않을 때 (부스터 미사용 + 스톱워치/충돌 무적 아님) 게이지 충전
        if (!isBoosting && !isInvincible) {
            boosterGauge = Math.min(GAME_CONFIG.MAX_BOOSTER, boosterGauge + GAME_CONFIG.BOOSTER_CHARGE_PER_FRAME);
        }

        // --- 2. 타이머 업데이트 ---
        if (isInvincible) {
            invincibleTimer -= (1000 / 60);
            if (invincibleTimer <= 0) {
                isInvincible = false;
                console.log('무적 해제!');
            }
        }

        // --- 3. 객체 업데이트 ---
        player.update();

        // (수정) 점수에 따라 스폰 간격 조절 (난이도 상승)
        currentEnemySpawnInterval = Math.max(
            GAME_CONFIG.MIN_ENEMY_SPAWN_INTERVAL,
            GAME_CONFIG.INITIAL_ENEMY_SPAWN_INTERVAL - Math.floor(score / 500) // 500점마다 1프레임씩 빨라짐
        );

        spawnLaneMarkers();
        laneMarkers.forEach((marker, index) => {
            marker.update();
            if (marker.y > canvas.height) {
                laneMarkers.splice(index, 1);
            }
        });

        spawnEnemy(); // (수정) 내부 로직이 다중 스폰/가드 로직으로 변경됨
        enemies.forEach((enemy, index) => {

            if (isInvincible) {
                // (수정) 스톱워치 무적: 적들이 플레이어보다 더 빨리 아래로 떨어짐 (속도감 UP)
                enemy.speedY = gameSpeed * 2 + enemy.originalRelativeSpeed;
            } else {
                enemy.speedY = gameSpeed + enemy.originalRelativeSpeed;
            }
            enemy.update();

            // 충돌 감지
            if (checkCollision(player, enemy)) {
                if (isInvincible || isBoosting) {
                    enemy.y = canvas.height + 100;
                    enemy.speedY = 0;
                    score += 50;
                } else {
                    lives--;
                    drawLives();
                    enemies.splice(index, 1);

                    if (lives <= 0) {
                        gameOver();
                    } else {
                        isInvincible = true;
                        invincibleTimer = 1000;
                        console.log('충돌! 1초간 무적');
                    }
                }
            }

            // 화면 밖으로 나간 적 처리
            if (enemy.y > canvas.height) {
                enemies.splice(index, 1);
                if (isPlaying) {
                    score += 10;
                    // (삭제) 아슬아슬하게 피하기 부스터 충전 로직 삭제
                }
            }
        });

        spawnItem();
        items.forEach((item, index) => {
            item.update();

            if (checkCollision(player, item)) {
                if (item.id === 'stopwatch') {
                    activateStopwatch();
                }
                items.splice(index, 1);
            }

            if (item.y > canvas.height) {
                items.splice(index, 1);
            }
        });

        // --- 4. UI 업데이트 ---
        score += GAME_CONFIG.SCORE_PER_FRAME;
        scoreEl.textContent = score;
        speedometerEl.textContent = Math.round(gameSpeed * 10);
        boosterGaugeFillEl.style.width = boosterGauge + '%';

        if (score > highScore) {
            highScore = score;
            highScoreEl.textContent = highScore;
        }
    }

    function drawGameObjects() {
        ctx.fillStyle = '#6c757d';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = '#28A745';
        const shoulderWidth = canvas.width * GAME_CONFIG.ROAD_SHOULDER_RATIO;
        ctx.fillRect(0, 0, shoulderWidth, canvas.height);
        ctx.fillRect(canvas.width - shoulderWidth, 0, shoulderWidth, canvas.height);

        laneMarkers.forEach(marker => marker.draw());

        enemies.forEach(enemy => enemy.draw());

        items.forEach(item => item.draw());

        if (player) {
            if (isInvincible || isBoosting) {
                if (Math.floor(Date.now() / 100) % 2 === 0) {
                    player.draw();
                }
            } else {
                player.draw();
            }
        }
    }

    // --- 메인 게임 루프 ---
    function gameLoop() {
        if (!isPlaying || isPaused) return;

        updateGameObjects();
        drawGameObjects();

        gameLoopId = requestAnimationFrame(gameLoop);
    }

    // --- 자동차 선택 UI 렌더링 ---
    function renderCarSelection() {
        carSelectionGrid.innerHTML = '';
        CAR_DATA.forEach(car => {
            const card = document.createElement('div');
            card.classList.add('car-card');
            card.dataset.carId = car.id;

            const isLocked = highScore < car.unlockedAt;
            if (isLocked) {
                card.classList.add('locked');
            } else {
                card.addEventListener('click', () => selectCar(car.id));
            }

            const imgEl = new Image();
            imgEl.src = IMAGE_ROOT + car.file;
            imgEl.alt = car.name;
            imgEl.style.width = '80%';
            imgEl.style.height = 'auto';
            imgEl.style.margin = '0 auto 5px';
            imgEl.style.imageRendering = 'pixelated';

            card.appendChild(imgEl);

            const name = document.createElement('p');
            name.classList.add('font-bold', 'text-sm', 'text-gray-800');
            name.textContent = car.name;
            card.appendChild(name);

            const stats = document.createElement('div');
            stats.classList.add('car-stats');
            stats.innerHTML = `
                    <p>생명: ${'❤️'.repeat(car.lives)}</p>
                    <p>최대속도: ${car.maxSpeed}</p>
                    <p>가속: ${car.acceleration.toFixed(3)}</p>
                    ${isLocked ? `<p class="text-red-500 mt-1">잠금 해제: ${car.unlockedAt}점</p>` : ''}
                `;
            card.appendChild(stats);

            carSelectionGrid.appendChild(card);
        });

        let defaultCarId = (currentCarData && highScore >= currentCarData.unlockedAt) ? currentCarData.id : CAR_DATA[0].id;
        selectCar(defaultCarId);
    }

    function selectCar(carId) {
        const selectedCar = CAR_DATA.find(car => car.id === carId);
        if (!selectedCar || highScore < selectedCar.unlockedAt) {
            console.log('잠긴 차량은 선택할 수 없습니다.');
            return;
        }

        currentCarData = selectedCar;

        document.querySelectorAll('.car-card').forEach(card => {
            card.classList.remove('selected');
        });

        const cardElement = document.querySelector(`.car-card[data-car-id="${carId}"]`);
        if (cardElement) {
            cardElement.classList.add('selected');
            console.log(`차량 선택: ${currentCarData.name}`);
        }
    }

    // --- 이벤트 리스너 ---

    window.addEventListener('resize', resizeCanvas);

    window.addEventListener('keydown', (e) => {
        if (keys.hasOwnProperty(e.key)) {
            e.preventDefault();
            keys[e.key] = true;
        }
        if (e.key === 'Escape') {
            if (isPlaying) {
                togglePause();
            }
        }
    });

    window.addEventListener('keyup', (e) => {
        if (keys.hasOwnProperty(e.key)) {
            e.preventDefault();
            keys[e.key] = false;
        }
    });

    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (isPlaying && isPaused) {
            togglePause();
            return;
        }
    }, { passive: false });

    function handleTouchStart(e) {
        e.preventDefault();
        if (e.currentTarget === leftBtn) keys.ArrowLeft = true;
        if (e.currentTarget === rightBtn) keys.ArrowRight = true;
        if (e.currentTarget === boostBtn) keys.B = true;
    }

    function handleTouchEnd(e) {
        e.preventDefault();
        if (e.currentTarget === leftBtn) keys.ArrowLeft = false;
        if (e.currentTarget === rightBtn) keys.ArrowRight = false;
        if (e.currentTarget === boostBtn) keys.B = false;
    }

    [leftBtn, rightBtn, boostBtn].forEach(btn => {
        btn.addEventListener('touchstart', handleTouchStart, { passive: false });
        btn.addEventListener('touchend', handleTouchEnd, { passive: false });
        btn.addEventListener('touchcancel', handleTouchEnd, { passive: false });

        btn.addEventListener('mousedown', handleTouchStart, { passive: false });
        btn.addEventListener('mouseup', handleTouchEnd, { passive: false });
        btn.addEventListener('mouseleave', handleTouchEnd, { passive: false });
    });

    startButton.addEventListener('click', startGame);

    // --- 초기화 ---
    if (imagesLoadedCount === totalImagesToLoad && totalImagesToLoad > 0) {
        initializeGame();
    } else if (totalImagesToLoad === 0) {
        console.log("No images to load, initializing immediately.");
        initializeGame();
    }

</script>
</body>
</html>

