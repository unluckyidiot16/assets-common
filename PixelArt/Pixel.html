<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>í”½ì…€ ì»¬ëŸ¬ë§ â€” 4ë¶„í• Â·í™•ëŒ€Â·ìˆœì°¨ ìŠ¤í…Œì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui; touch-action: manipulation; }
        .view { display: none; width: 100%; min-height: 100vh; }
        .view.active { display: flex; }

        /* ìº”ë²„ìŠ¤: ë°•ìŠ¤ì—¬ë°± ì œê±° + í”½ì…€ ìŠ¤ëƒ… */
        canvas {
            display: block;                /* inline gap ì œê±° */
            image-rendering: pixelated;
            cursor: pointer;
            background:#fff;
        }

        /* íŒ”ë ˆíŠ¸(ìƒ‰ìƒ) ë²„íŠ¼ */
        #paletteContainer { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-top:20px; max-width:800px; }
        .palette-button {
            width:50px; height:50px; border:2px solid #d1d5db; border-radius:8px; cursor:pointer;
            font-weight:700; display:flex; align-items:center; justify-content:center; color:#fff;
            text-shadow:0 0 2px #000;
            transition:transform .15s, box-shadow .15s, border-color .15s;
        }
        .palette-button.selected { border-color:#0ea5e9; transform:scale(1.08); box-shadow:0 0 15px rgba(14,165,233,.45); }
        .palette-button.locked { filter:grayscale(1); }

        /* ì¿¼ë“œ ì ê¸ˆ ì˜¤ë²„ë ˆì´ */
        .quad-wrap { position: relative; width: fit-content; height: fit-content; }
        .quad-lock {
            position:absolute; inset:0; background:rgba(0,0,0,.45); color:#fff; display:flex; flex-direction:column;
            align-items:center; justify-content:center; gap:10px; font-weight:700; border-radius:0;
            opacity:1; transition:opacity .2s; z-index:2;
        }
        .quad-lock.hidden { opacity:0; pointer-events:none; }

        /* í™•ëŒ€ ë ˆì´ì–´ */
        #zoomOverlay {
            position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center;
            z-index:1000;
        }
        #zoomCard {
            background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:16px;
            display:flex; flex-direction:column; align-items:center; gap:12px; max-width:95vw; max-height:90vh;
        }
        #zoomCanvas { image-rendering: pixelated; border:2px solid #0ea5e9; border-radius:8px; }

        /* ë¡œë¹„ ì¹´ë“œ */
        #stageGrid .stage-card { border:2px solid #e5e7eb; border-radius:8px; overflow:hidden; cursor:pointer; transition:.2s; background:#fff; }
        #stageGrid .stage-card:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.08); }
        #stageGrid .stage-card img { image-rendering:pixelated; width:100%; aspect-ratio:1/1; object-fit:contain; background:#f9fafb; }
        .locked-card { filter:grayscale(1); position:relative; }
        .locked-card::after {
            content:"ğŸ”’"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
            font-size:28px; color:#fff; text-shadow:0 0 5px #000;
            background:rgba(0,0,0,.35);
        }

        /* ëª¨ë‹¬ */
        .modal { display:none; position:fixed; z-index:1100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,.4); justify-content:center; align-items:center; }
        .modal-content { background:#fff; margin:auto; padding:24px; border-radius:12px; width:90%; max-width:480px; text-align:center; }
        .modal-button { background:#0ea5e9; color:#fff; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:700; }

        /* 4ë¶„í• ì„ í•œ ì¥ì²˜ëŸ¼: ì½˜í…ì¸  í¬ê¸°ë¡œ ì¤‘ì•™ ì •ë ¬ */
        .composite {
            display:flex;
            justify-content:center;
            overflow:auto;
            border:3px solid #374151;
            border-radius:14px;
        }
        .grid-2x2 {
            display:inline-grid;                         /* ì½˜í…ì¸  í­ë§Œí¼ë§Œ ì°¨ì§€ */
            grid-template-columns: max-content max-content; /* ìº”ë²„ìŠ¤ ê³ ìœ  í¬ê¸° ìœ ì§€ */
            grid-template-rows: max-content max-content;
            justify-items:start;
            align-items:start;
            gap:0;                                      /* ì¤‘ì•™ì— ë§ë¶™ê²Œ */
        }

        /* ì§€ì§„ íš¨ê³¼(ì˜¤ë‹µ ì§„ë™) */
        @keyframes shake { 0%,100%{transform:translate(0,0)} 25%{transform:translate(-3px,0)} 50%{transform:translate(3px,0)} 75%{transform:translate(-3px,0)} }
        .shake { animation:shake .25s; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- 1) íƒ€ì´í‹€ -->
<div id="titleScreen" class="view active flex-col items-center justify-center p-4">
    <h1 class="text-5xl md:text-7xl font-extrabold text-gray-800 mb-8 animate-pulse">í”½ì…€ ì»¬ëŸ¬ë§</h1>
    <button id="startButton" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg hover:scale-105">
        ì‹œì‘í•˜ê¸°
    </button>
</div>

<!-- 2) ë¡œë¹„ -->
<div id="lobbyScreen" class="view flex-col items-center p-4 md:p-8">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 my-6">ìŠ¤í…Œì´ì§€ ì„ íƒ</h1>
    <p class="text-sm text-gray-500 mb-4">â€» ìŠ¤í…Œì´ì§€ëŠ” 1ë²ˆë¶€í„° í´ë¦¬ì–´í•´ì•¼ ë‹¤ìŒ ë²ˆí˜¸ì— ì…ì¥í•  ìˆ˜ ìˆì–´ìš”.</p>
    <div id="stageGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4 w-full max-w-6xl"></div>
</div>

<!-- 3) ê²Œì„ -->
<div id="gameScreen" class="view flex-col items-center justify-start p-4">
    <div class="w-full max-w-5xl flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
        <div class="flex items-center gap-2">
            <button id="backButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow">
                &larr; ë¡œë¹„ë¡œ
            </button>
            <span class="text-sm text-gray-500">ë°ëª¨: ì§„í–‰ ì €ì¥ì€ ë¡œì»¬(ë¸Œë¼ìš°ì €)ë§Œ</span>
        </div>
        <h3 id="gameTitle" class="text-xl font-bold text-gray-800"></h3>
    </div>

    <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg w-full max-w-5xl flex flex-col items-center">
        <!-- ë¡œë”© -->
        <div id="loadingSpinner" class="text-center p-8">
            <svg class="animate-spin h-10 w-10 text-sky-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-3 text-gray-600">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</p>
        </div>

        <!-- 2Ã—2 ìº”ë²„ìŠ¤(í•œ ì¥ì˜ ê·¸ë¦¼ì²˜ëŸ¼) -->
        <div class="composite w-full">
            <!-- â†“ ì½˜í…ì¸  í¬ê¸°ë§Œí¼ë§Œ ì°¨ì§€í•˜ë„ë¡ w-full ì œê±° -->
            <div id="quadGrid" class="grid-2x2">
                <!-- JSì—ì„œ ì±„ì›€ -->
            </div>
        </div>

        <!-- íŒ”ë ˆíŠ¸(ë¬¼ê°) í•´ê¸ˆ í€´ì¦ˆ -->
        <div id="paintsGate" class="hidden w-full max-w-md mt-4 p-4 border rounded-lg bg-slate-50">
            <div class="flex items-center justify-between gap-2">
                <h4 class="font-bold text-gray-800">ë¬¼ê° ëª¨ìœ¼ê¸° í€´ì¦ˆ</h4>
                <button id="startPaintsQuizBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow">
                    ì‹œì‘
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-2">ì •ë‹µì„ ëª¨ë‘ ë§íˆë©´ íŒ”ë ˆíŠ¸ê°€ ì—´ë¦½ë‹ˆë‹¤.</p>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                <div id="paintsQuizBar" class="bg-emerald-500 h-2.5 rounded-full" style="width:0%; transition:width .3s;"></div>
            </div>
            <p id="paintsQuizText" class="text-xs text-gray-500 mt-1">0%</p>
        </div>

        <!-- ìƒ‰ìƒ íŒ”ë ˆíŠ¸ -->
        <div id="paletteContainer" class="hidden"></div>

        <!-- ì „ì²´ ì§„í–‰ë¥  -->
        <div id="progressContainer" class="w-full max-w-md mt-4 hidden">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progressBar" class="bg-sky-500 h-2.5 rounded-full" style="width:0%; transition:width .3s;"></div>
            </div>
            <p id="progressText" class="text-center text-sm text-gray-600 mt-1">0%</p>
        </div>
    </div>
</div>

<!-- í™•ëŒ€ ë ˆì´ì–´ -->
<div id="zoomOverlay">
    <div id="zoomCard">
        <canvas id="zoomCanvas"></canvas>
        <div class="flex items-center gap-2">
            <button id="zoomClose" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow">ë‹«ê¸°(Esc)</button>
            <span class="text-xs text-gray-500">íŒ: í™•ëŒ€ ìƒíƒœì—ì„œ ë°”ë¡œ ìƒ‰ì¹ í•  ìˆ˜ ìˆì–´ìš”.</span>
        </div>
    </div>
</div>

<!-- ì•ˆë‚´ ëª¨ë‹¬ -->
<div id="messageModal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle" class="text-xl font-bold mb-2"></h2>
        <p id="modalMessage" class="text-gray-700"></p>
        <button id="modalCloseButton" class="modal-button">í™•ì¸</button>
    </div>
</div>

<!-- í€´ì¦ˆ ëª¨ë‹¬ -->
<div id="quizModal" class="modal">
    <div class="modal-content">
        <h2 id="quizTitle" class="text-xl font-bold mb-3">í€´ì¦ˆ</h2>
        <p id="quizQuestion" class="text-gray-800 mb-4"></p>
        <div id="quizChoices" class="flex flex-col gap-2"></div>
        <button id="quizCancel" class="modal-button bg-gray-400 hover:bg-gray-500 mt-4">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    /* ---------------- ê¸°ë³¸ ì„¤ì • ---------------- */
    const CELL_SCALE = 15;                    // ìº”ë²„ìŠ¤ ì…€ í”½ì…€ í¬ê¸°
    const REQUIRED_PAINT_QUIZ = 5;

    const IMAGE_BASE_URL = 'https://unluckyidiot16.github.io/assets-common/PixelArt/PNG/';
    const IMAGE_FILES = Array.from({length: 50}, (_, i) => `${i+1}.png`);

    /* ---------------- DOM ---------------- */
    const allViews = document.querySelectorAll('.view');
    const titleScreen = document.getElementById('titleScreen');
    const lobbyScreen = document.getElementById('lobbyScreen');
    const gameScreen  = document.getElementById('gameScreen');
    const startButton = document.getElementById('startButton');
    const backButton  = document.getElementById('backButton');
    const stageGrid   = document.getElementById('stageGrid');

    const loadingSpinner   = document.getElementById('loadingSpinner');
    const quadGrid         = document.getElementById('quadGrid');
    const paletteContainer = document.getElementById('paletteContainer');
    const progressContainer= document.getElementById('progressContainer');
    const progressBar      = document.getElementById('progressBar');
    const progressText     = document.getElementById('progressText');
    const gameTitle        = document.getElementById('gameTitle');

    const paintsGate       = document.getElementById('paintsGate');
    const startPaintsQuizBtn = document.getElementById('startPaintsQuizBtn');
    const paintsQuizBar    = document.getElementById('paintsQuizBar');
    const paintsQuizText   = document.getElementById('paintsQuizText');

    const messageModal     = document.getElementById('messageModal');
    const modalTitle       = document.getElementById('modalTitle');
    const modalMessage     = document.getElementById('modalMessage');
    const modalCloseButton = document.getElementById('modalCloseButton');

    const quizModal        = document.getElementById('quizModal');
    const quizTitle        = document.getElementById('quizTitle');
    const quizQuestion     = document.getElementById('quizQuestion');
    const quizChoices      = document.getElementById('quizChoices');
    const quizCancel       = document.getElementById('quizCancel');

    const zoomOverlay      = document.getElementById('zoomOverlay');
    const zoomCanvas       = document.getElementById('zoomCanvas');
    const zoomClose        = document.getElementById('zoomClose');

    /* ---------------- ìƒíƒœ ---------------- */
    let imgWidth, imgHeight, sourceImage;
    let palette = {};
    let paletteMap = [null];     // 1-based ìƒ‰ ì¸ë±ìŠ¤ â†’ rgba
    let numberGrid = [];         // [y][x] â†’ ìƒ‰ ì¸ë±ìŠ¤
    let completedGrid = [];      // [y][x] â†’ boolean
    let totalCells = 0;
    let completedCells = 0;

    let selectedColorIndex = 0;
    let paletteUnlocked = false;

    const quadrants = [];        // {id, wrap, canvas, ctx, x, y, w, h, unlocked, lockEl}
    let nextQuadToUnlock = 0;    // 0..3
    let paintsQuizCount = 0;

    let currentStageFilename = null;
    let currentStageIndex = 1;

    let currentZoomQuad = null;
    let zoomCtx = zoomCanvas.getContext('2d');
    zoomCtx.imageSmoothingEnabled = false;

    /* ìˆœì°¨ ìŠ¤í…Œì´ì§€ í•´ê¸ˆ: ë¡œì»¬ ì €ì¥ì†Œ */
    const LS_MAX_UNLOCK = 'pixel.maxUnlockedStage';
    function getMaxUnlockedStage() { return parseInt(localStorage.getItem(LS_MAX_UNLOCK) || '1', 10); }
    function setMaxUnlockedStage(n) { localStorage.setItem(LS_MAX_UNLOCK, String(n)); }

    /* ---------------- í™”ë©´ ì „í™˜ ---------------- */
    function showView(id) {
        allViews.forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    /* ---------------- ë¡œë¹„ ---------------- */
    function populateLobby() {
        stageGrid.innerHTML = '';
        const maxUnlocked = getMaxUnlockedStage();
        IMAGE_FILES.forEach(filename => {
            const idx = parseInt(filename, 10); // "12.png" â†’ 12
            const card = document.createElement('div');
            card.className = 'stage-card';
            const locked = idx > maxUnlocked;
            if (locked) card.classList.add('locked-card');

            const img = document.createElement('img');
            img.src = IMAGE_BASE_URL + filename;
            img.alt = `Stage ${idx}`;
            img.loading = 'lazy';

            const title = document.createElement('p');
            title.className = 'text-center text-sm font-semibold text-gray-700 p-2';
            title.textContent = `Stage ${idx}`;

            card.appendChild(img);
            card.appendChild(title);

            card.addEventListener('click', () => {
                if (idx > getMaxUnlockedStage()) {
                    alert(`ìŠ¤í…Œì´ì§€ ${idx-1}ì„(ë¥¼) ë¨¼ì € í´ë¦¬ì–´í•´ì•¼ í•©ë‹ˆë‹¤.`);
                    return;
                }
                startGame(filename);
            });

            stageGrid.appendChild(card);
        });
    }

    /* ---------------- ê²Œì„ ì‹œì‘ ---------------- */
    function startGame(filename) {
        currentStageFilename = filename;
        currentStageIndex = parseInt(filename, 10) || 1;

        showView('gameScreen');
        gameTitle.textContent = `Stage ${currentStageIndex}`;

        // UI ì´ˆê¸°í™”
        loadingSpinner.style.display = 'block';
        paintsGate.classList.add('hidden');
        paletteContainer.classList.add('hidden');
        progressContainer.classList.add('hidden');
        paletteContainer.innerHTML = '';
        progressBar.style.width = '0%';
        progressText.textContent = '0%';

        // ìƒíƒœ ì´ˆê¸°í™”
        palette = {};
        paletteMap = [null];
        numberGrid = [];
        completedGrid = [];
        totalCells = 0;
        completedCells = 0;
        selectedColorIndex = 0;
        paletteUnlocked = false;

        quadrants.length = 0;
        nextQuadToUnlock = 0;
        paintsQuizCount = 0;
        paintsQuizBar.style.width = '0%';
        paintsQuizText.textContent = '0%';

        // 4ë¶„í•  ì»¨í…Œì´ë„ˆ ë¦¬ë¹Œë“œ
        quadGrid.innerHTML = '';
        for (let i=0;i<4;i++){
            const wrap = document.createElement('div');
            wrap.className = 'quad-wrap';
            const c = document.createElement('canvas');
            c.id = `canvasQ${i}`;
            wrap.appendChild(c);

            const lock = document.createElement('div');
            lock.className = 'quad-lock';
            lock.innerHTML = `
      <div class="text-2xl">ğŸ”’ ìº”ë²„ìŠ¤ ${i+1}</div>
      <button class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow">í€´ì¦ˆë¡œ í•´ê¸ˆ</button>
    `;
            lock.querySelector('button').addEventListener('click', ()=> {
                if (i===nextQuadToUnlock) openQuiz('quad', i);
                else showModal('ìˆœì„œ ì•ˆë‚´', `ìº”ë²„ìŠ¤ ${nextQuadToUnlock+1}ë¶€í„° ì°¨ë¡€ëŒ€ë¡œ í•´ê¸ˆí•˜ì„¸ìš”.`);
            });
            wrap.appendChild(lock);
            quadGrid.appendChild(wrap);

            const ctx = c.getContext('2d');
            ctx.imageSmoothingEnabled = false;
            quadrants.push({ id:i, wrap, canvas:c, ctx, x:0,y:0,w:0,h:0, unlocked:false, lockEl:lock });

            // ê¸°ë³¸ í´ë¦­(í•´ê¸ˆ ì „/í›„)ì€ ì•„ë˜ì—ì„œ ìƒíƒœì— ë§ê²Œ êµì²´
            c.onclick = ()=>{ if (!quadrants[i].unlocked) showModal('ì ê¸ˆ', `ìº”ë²„ìŠ¤ ${i+1}ì„(ë¥¼) ë¨¼ì € í€´ì¦ˆë¡œ í•´ê¸ˆí•˜ì„¸ìš”.`); else openZoom(i); };
        }

        loadImageAndProcess(filename);
    }

    /* ---------------- ëª¨ë‹¬/ì•Œë¦¼ ---------------- */
    modalCloseButton.onclick = () => messageModal.style.display = 'none';
    function showModal(title, msg) {
        modalTitle.textContent = title;
        modalMessage.textContent = msg;
        messageModal.style.display = 'flex';
    }

    /* ---------------- ì´ë¯¸ì§€ ë¶„ì„ ---------------- */
    async function loadImageAndProcess(filename){
        try{
            sourceImage = await new Promise((resolve,reject)=>{
                const im = new Image();
                im.crossOrigin = "Anonymous";
                im.src = IMAGE_BASE_URL + filename;
                im.onload = ()=>resolve(im);
                im.onerror = ()=>reject(new Error('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
            });
            imgWidth = sourceImage.width;
            imgHeight= sourceImage.height;

            // í”½ì…€ ìŠ¤ìº”
            const hc = document.createElement('canvas');
            hc.width = imgWidth; hc.height = imgHeight;
            const hctx = hc.getContext('2d');
            hctx.drawImage(sourceImage, 0, 0);
            const data = hctx.getImageData(0,0,imgWidth,imgHeight).data;

            let colorIndex = 1;
            for (let y=0;y<imgHeight;y++){
                numberGrid[y]=[];
                completedGrid[y]=[];
                for(let x=0;x<imgWidth;x++){
                    const i = (y*imgWidth+x)*4;
                    const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
                    if (a < 128) {
                        numberGrid[y][x] = 0;           // íˆ¬ëª…
                        completedGrid[y][x] = true;     // ì´ë¯¸ ì™„ë£Œ ì²˜ë¦¬(ì•ˆ ì¹ í•¨ ì˜ì—­)
                    } else {
                        const rgba = `rgba(${r},${g},${b},${a/255})`;
                        if (!palette[rgba]) {
                            palette[rgba] = colorIndex;
                            paletteMap[colorIndex] = rgba;
                            colorIndex++;
                        }
                        numberGrid[y][x] = palette[rgba];
                        completedGrid[y][x] = false;
                        totalCells++;
                    }
                }
            }

            // 4ë¶„í•  ì§€ì˜¤ë©”íŠ¸ë¦¬ (ìš°í•˜ë‹¨ wëŠ” imgWidth - halfW)
            const halfW = Math.floor(imgWidth/2);
            const halfH = Math.floor(imgHeight/2);
            const quadsGeom = [
                {x:0,      y:0,      w:halfW,            h:halfH},             // 0
                {x:halfW,  y:0,      w:imgWidth-halfW,   h:halfH},             // 1
                {x:0,      y:halfH,  w:halfW,            h:imgHeight-halfH},   // 2
                {x:halfW,  y:halfH,  w:imgWidth-halfW,   h:imgHeight-halfH},   // 3 âœ…
            ];
            quadsGeom.forEach((g,i)=>{
                const q = quadrants[i];
                q.x=g.x; q.y=g.y; q.w=g.w; q.h=g.h;

                q.canvas.width  = g.w * CELL_SCALE;
                q.canvas.height = g.h * CELL_SCALE;
                /* CSS í¬ê¸°ë¥¼ ì‹¤ì œ í”½ì…€ê³¼ ë™ì¼í•˜ê²Œ ê³ ì • â†’ ë ˆì´ì•„ì›ƒ ëŠ˜ì–´ë‚¨ ë°©ì§€ */
                q.canvas.style.width  = q.canvas.width  + 'px';
                q.canvas.style.height = q.canvas.height + 'px';
            });

            loadingSpinner.style.display = 'none';
            progressContainer.classList.remove('hidden');

            // ìµœì´ˆì—” 1ë²ˆë§Œ í•´ê¸ˆ ê°€ëŠ¥
            updateAllQuads(true);
            buildPaletteUI(true);  // íŒ”ë ˆíŠ¸ëŠ” ë¬¼ê° í€´ì¦ˆ ì´í›„ í•´ê¸ˆ
        } catch(err){
            console.error(err);
            showModal('ì˜¤ë¥˜', err.message + ' ë¡œë¹„ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
            showView('lobbyScreen');
        }
    }

    /* ---------------- íŒ”ë ˆíŠ¸ UI ---------------- */
    function buildPaletteUI(locked) {
        paletteContainer.innerHTML = '';
        const count = Math.max(1, paletteMap.length-1);
        for (let i=1;i<=count;i++){
            const color = paletteMap[i];
            const btn = document.createElement('button');
            btn.className = 'palette-button';
            btn.style.backgroundColor = color;
            btn.textContent = i;
            btn.dataset.colorIndex = i;
            if (locked) btn.classList.add('locked');

            btn.addEventListener('click', ()=>{
                if (!paletteUnlocked) { showModal('ë¬¼ê° ì ê¸ˆ', 'ì•„ì§ ë¬¼ê°ì´ ëª¨ì´ì§€ ì•Šì•˜ì–´ìš”. 4ê°œ ìº”ë²„ìŠ¤ë¥¼ ëª¨ë‘ í•´ê¸ˆí•œ ë’¤ "ë¬¼ê° ëª¨ìœ¼ê¸° í€´ì¦ˆ"ë¥¼ ì™„ë£Œí•˜ì„¸ìš”.'); return; }
                selectedColorIndex = parseInt(btn.dataset.colorIndex,10);
                document.querySelectorAll('.palette-button').forEach(b=>b.classList.remove('selected'));
                btn.classList.add('selected');
            });
            paletteContainer.appendChild(btn);
        }
    }

    /* ---------------- ê·¸ë¦¬ê¸° ---------------- */
    function drawQuad(q, showGridNumbers) {
        const ctx = q.ctx;
        drawQuadToContext(q, ctx, CELL_SCALE, showGridNumbers);
    }
    function drawQuadToContext(q, ctx, scale, showGridNumbers) {
        ctx.clearRect(0,0,q.w*scale,q.h*scale);
        if (showGridNumbers) {
            ctx.strokeStyle = '#e5e7eb';
            const fontSize = Math.max(6, Math.floor(scale * 0.5));
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
        }
        for (let y=q.y; y<q.y+q.h; y++){
            for (let x=q.x; x<q.x+q.w; x++){
                const cellX = (x - q.x) * scale;
                const cellY = (y - q.y) * scale;
                const idx = (numberGrid[y] && numberGrid[y][x] !== undefined) ? numberGrid[y][x] : 0; // ì•ˆì „ì¥ì¹˜

                if (completedGrid[y][x]) {
                    // ì±„ì›Œì§„ ì¹¸(ì™„ì„±ëœ ê·¸ë¦¼)
                    ctx.fillStyle = (idx === 0) ? '#f5f5f5' : paletteMap[idx];
                    ctx.fillRect(cellX, cellY, scale, scale);
                } else {
                    // ë¯¸ì™„ì„±ì¼ ë•Œë§Œ ê°€ì´ë“œ í‘œì‹œ
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(cellX, cellY, scale, scale);
                    if (showGridNumbers) {
                        ctx.strokeRect(cellX, cellY, scale, scale);
                        ctx.fillStyle = '#555';
                        ctx.fillText(idx, cellX + scale/2, cellY + scale/2 + 1);
                    }
                }
            }
        }
    }
    function updateAllQuads(showGridNumbers=true){ quadrants.forEach(q=>drawQuad(q, showGridNumbers)); }
    function drawCellOnQuad(q, gx, gy){
        const ctx = q.ctx;
        const cellX = (gx - q.x) * CELL_SCALE;
        const cellY = (gy - q.y) * CELL_SCALE;
        const idx = numberGrid[gy][gx];
        ctx.fillStyle = (idx===0)?'#f5f5f5':paletteMap[idx];
        ctx.fillRect(cellX, cellY, CELL_SCALE, CELL_SCALE);
    }

    /* ---------------- í™•ëŒ€(ë°˜ì‘í˜• ì •ìˆ˜ ë°°ìœ¨) ---------------- */
    function computeZoomScale(q){
        const maxW = Math.floor(window.innerWidth * 0.95);
        const maxH = Math.floor(window.innerHeight * 0.85);
        const baseW = q.w * CELL_SCALE;
        const baseH = q.h * CELL_SCALE;
        const s = Math.max(1, Math.min(Math.floor(maxW/baseW), Math.floor(maxH/baseH)));
        return s; // 1Ã—, 2Ã—, 3Ã— â€¦
    }
    function openZoom(quadIndex){
        const q = quadrants[quadIndex];
        if (!q.unlocked) { showModal('ì ê¸ˆ', `ìº”ë²„ìŠ¤ ${quadIndex+1}ì„(ë¥¼) ë¨¼ì € í€´ì¦ˆë¡œ í•´ê¸ˆí•˜ì„¸ìš”.`); return; }

        currentZoomQuad = q;
        const zoomScale = computeZoomScale(q);
        zoomCanvas.width  = q.w * CELL_SCALE * zoomScale;
        zoomCanvas.height = q.h * CELL_SCALE * zoomScale;
        zoomCtx.imageSmoothingEnabled = false;
        drawQuadToContext(q, zoomCtx, CELL_SCALE*zoomScale, true);
        zoomOverlay.style.display = 'flex';

        window.addEventListener('resize', onResizeZoom, { passive:true });
    }
    function onResizeZoom(){
        if (!currentZoomQuad || zoomOverlay.style.display==='none') return;
        const q = currentZoomQuad;
        const zoomScale = computeZoomScale(q);
        zoomCanvas.width  = q.w * CELL_SCALE * zoomScale;
        zoomCanvas.height = q.h * CELL_SCALE * zoomScale;
        drawQuadToContext(q, zoomCtx, CELL_SCALE*zoomScale, true);
    }
    function closeZoom(){
        zoomOverlay.style.display = 'none';
        window.removeEventListener('resize', onResizeZoom);
        currentZoomQuad = null;
    }
    zoomClose.addEventListener('click', closeZoom);
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeZoom(); });

    zoomCanvas.addEventListener('click', (e)=>{
        if (!currentZoomQuad) return;
        const q = currentZoomQuad;
        if (!paletteUnlocked) { showModal('ë¬¼ê°ì´ ì—†ì–´ìš”', 'ë¨¼ì € "ë¬¼ê° ëª¨ìœ¼ê¸° í€´ì¦ˆ"ë¥¼ ì™„ë£Œí•´ íŒ”ë ˆíŠ¸ë¥¼ ì—¬ì„¸ìš”.'); return; }
        if (selectedColorIndex===0) { showModal('ì•Œë¦¼', 'ë¨¼ì € ì•„ë˜ íŒ”ë ˆíŠ¸ì—ì„œ ìƒ‰ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

        const rect = zoomCanvas.getBoundingClientRect();
        const scaleX = zoomCanvas.width / rect.width;
        const scaleY = zoomCanvas.height/ rect.height;
        const lx = (e.clientX - rect.left) * scaleX;
        const ly = (e.clientY - rect.top)  * scaleY;

        const zoomScale = zoomCanvas.width / (q.w * CELL_SCALE); // í˜„ì¬ ì •ìˆ˜ ë°°ìœ¨
        const cellScaleZoom = CELL_SCALE * zoomScale;
        const gx = q.x + Math.floor(lx / cellScaleZoom);
        const gy = q.y + Math.floor(ly / cellScaleZoom);

        if (gx<q.x || gx>=q.x+q.w || gy<q.y || gy>=q.y+q.h) return;

        const idx = numberGrid[gy][gx];
        if (completedGrid[gy][gx] || idx===0) return;

        if (idx === selectedColorIndex) {
            completedGrid[gy][gx] = true;
            completedCells++;
            drawCellOnZoom(q, gx, gy, zoomScale);
            drawCellOnQuad(q, gx, gy);
            updateProgress();
            checkCompletion();
        } else {
            zoomCanvas.classList.add('shake'); setTimeout(()=>zoomCanvas.classList.remove('shake'),250);
        }
    });
    function drawCellOnZoom(q, gx, gy, zoomScale){
        const cellScale = CELL_SCALE * zoomScale;
        const cellX = (gx - q.x) * cellScale;
        const cellY = (gy - q.y) * cellScale;
        const idx = numberGrid[gy][gx];
        zoomCtx.fillStyle = (idx===0)?'#f5f5f5':paletteMap[idx];
        zoomCtx.fillRect(cellX, cellY, cellScale, cellScale);
    }

    /* ---------------- ì…ë ¥(ì› ë·°ì—ì„œ ì¹ í•˜ê¸°) ---------------- */
    function handleCanvasClickOnQuadPaint(e, q){
        const rect = q.canvas.getBoundingClientRect();
        const scaleX = q.canvas.width / rect.width;
        const scaleY = q.canvas.height/ rect.height;
        const lx = (e.clientX - rect.left) * scaleX;
        const ly = (e.clientY - rect.top)  * scaleY;
        const gx = q.x + Math.floor(lx / CELL_SCALE);
        const gy = q.y + Math.floor(ly / CELL_SCALE);

        if (gx<q.x || gx>=q.x+q.w || gy<q.y || gy>=q.y+q.h) return;

        const idx = numberGrid[gy][gx];
        if (completedGrid[gy][gx] || idx===0) return;
        if (selectedColorIndex===0) { showModal('ì•Œë¦¼', 'ë¨¼ì € ì•„ë˜ íŒ”ë ˆíŠ¸ì—ì„œ ìƒ‰ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

        if (idx === selectedColorIndex) {
            completedGrid[gy][gx] = true;
            completedCells++;
            drawCellOnQuad(q, gx, gy);
            updateProgress();
            checkCompletion();
        } else {
            q.canvas.classList.add('shake'); setTimeout(()=>q.canvas.classList.remove('shake'),250);
        }
    }

    /* ---------------- ì§„í–‰ë¥ /ì™„ì„± ì²˜ë¦¬ ---------------- */
    function updateProgress(){
        if (totalCells===0) return;
        const percent = Math.floor((completedCells/totalCells)*100);
        progressBar.style.width = `${percent}%`;
        progressText.textContent = `${percent}%`;
    }
    function checkCompletion(){
        if (completedCells !== totalCells) return;

        // ì™„ë£Œ: ê·¸ë¦¬ë“œ/ìˆ«ì ì œê±° â†’ ì™„ì„± ê·¸ë¦¼ìœ¼ë¡œ ë³€í™˜
        updateAllQuads(false); // showGridNumbers=false
        showModal('ì¶•í•˜í•©ë‹ˆë‹¤!', `ìŠ¤í…Œì´ì§€ ${currentStageIndex} ì™„ì„±!`);

        // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ í•´ê¸ˆ
        const nextIdx = currentStageIndex + 1;
        const prevMax = getMaxUnlockedStage();
        if (nextIdx > prevMax) setMaxUnlockedStage(nextIdx);
    }

    /* ---------------- í€´ì¦ˆ ---------------- */
    let currentQuiz = null; // {type:'quad'|'paints', quadIndex, correct}
    quizCancel.onclick = () => { quizModal.style.display='none'; currentQuiz=null; };

    function openQuiz(type, quadIndex=null){
        const q = generateMathQuestion();
        currentQuiz = { type, quadIndex, correct: q.correctIndex };
        quizTitle.textContent = (type==='quad') ? `ìº”ë²„ìŠ¤ ${quadIndex+1} í•´ê¸ˆ í€´ì¦ˆ` : 'ë¬¼ê° ëª¨ìœ¼ê¸° í€´ì¦ˆ';
        quizQuestion.textContent = q.question;
        quizChoices.innerHTML = '';
        q.choices.forEach((c, i)=>{
            const btn = document.createElement('button');
            btn.className = 'modal-button';
            btn.textContent = c;
            btn.addEventListener('click', ()=> submitQuiz(i));
            quizChoices.appendChild(btn);
        });
        quizModal.style.display = 'flex';
    }
    function submitQuiz(choiceIndex){
        const ok = (choiceIndex === currentQuiz.correct);
        const {type, quadIndex} = currentQuiz;
        quizModal.style.display = 'none';
        currentQuiz = null;

        if (!ok){ showModal('ì˜¤ë‹µ', 'ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!'); return; }

        if (type==='quad'){
            const q = quadrants[quadIndex];
            q.unlocked = true;
            q.lockEl.classList.add('hidden');

            // í•´ê¸ˆ í›„: ê¸°ë³¸ í´ë¦­ì€ ì¹ í•˜ê¸°, ë³´ì¡°í‚¤(Ctrl/âŒ˜/Shift)ë¡œ ë°”ë¡œ í™•ëŒ€
            q.canvas.onclick = (ev)=>{
                if (!q.unlocked) return;
                if (ev.ctrlKey || ev.metaKey || ev.shiftKey) { openZoom(quadIndex); return; }
                handleCanvasClickOnQuadPaint(ev, q);
            };

            drawQuad(q, true);
            nextQuadToUnlock++;
            if (nextQuadToUnlock>=4){
                paintsGate.classList.remove('hidden');
                showModal('í•´ê¸ˆ ì™„ë£Œ', '4ê°œ ìº”ë²„ìŠ¤ë¥¼ ëª¨ë‘ ì—´ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë¬¼ê° ëª¨ìœ¼ê¸° í€´ì¦ˆë¡œ íŒ”ë ˆíŠ¸ë¥¼ ì—¬ì„¸ìš”.');
            } else {
                showModal('í•´ê¸ˆ ì„±ê³µ', `ìº”ë²„ìŠ¤ ${quadIndex+1} í•´ê¸ˆ! ë‹¤ìŒì€ ${nextQuadToUnlock+1}ë²ˆ ìº”ë²„ìŠ¤ì…ë‹ˆë‹¤.`);
            }
        } else if (type==='paints'){
            paintsQuizCount++;
            const pct = Math.floor((paintsQuizCount / REQUIRED_PAINT_QUIZ)*100);
            paintsQuizBar.style.width = `${pct}%`;
            paintsQuizText.textContent = `${pct}%`;

            if (paintsQuizCount >= REQUIRED_PAINT_QUIZ){
                paletteUnlocked = true;
                paintsGate.classList.add('hidden');
                paletteContainer.classList.remove('hidden');
                buildPaletteUI(false);
                showModal('íŒ”ë ˆíŠ¸ ì˜¤í”ˆ', 'ëª¨ë“  ë¬¼ê°ì„ ëª¨ì•˜ìŠµë‹ˆë‹¤! ìƒ‰ì¹ ì„ ì‹œì‘í•˜ì„¸ìš”.');
            } else {
                showModal('ì •ë‹µ!', 'ì¢‹ì•„ìš”! ê³„ì† ì§„í–‰í•´ ë¬¼ê°ì„ ëª¨ë‘ ëª¨ì•„ë³´ì„¸ìš”.');
            }
        }
    }
    function generateMathQuestion(){
        const a = Math.floor(Math.random()*9)+2;
        const b = Math.floor(Math.random()*9)+2;
        const ops = ['+','-','Ã—'];
        const op = ops[Math.floor(Math.random()*ops.length)];
        let ans = 0;
        if (op==='+') ans = a+b;
        else if (op==='-') ans = a-b;
        else ans = a*b;

        const choices = new Set([ans]);
        while (choices.size<4){
            const delta = Math.floor(Math.random()*6)-3;
            const fake = ans + (delta===0?3:delta);
            choices.add(fake);
        }
        const arr = Array.from(choices);
        for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
        const correctIndex = arr.indexOf(ans);
        return { question:`${a} ${op} ${b} = ?`, choices:arr, correctIndex };
    }

    /* ---------------- ì´ë²¤íŠ¸ ---------------- */
    startButton.addEventListener('click', ()=>{
        if (!localStorage.getItem(LS_MAX_UNLOCK)) setMaxUnlockedStage(1);
        showView('lobbyScreen');
        populateLobby();
    });
    backButton.addEventListener('click', ()=> { showView('lobbyScreen'); populateLobby(); });

    startPaintsQuizBtn.addEventListener('click', ()=>{
        if (nextQuadToUnlock<4){ showModal('ì•ˆë‚´','ë¨¼ì € 4ê°œ ìº”ë²„ìŠ¤ë¥¼ ëª¨ë‘ í•´ê¸ˆí•˜ì„¸ìš”.'); return; }
        openQuiz('paints');
    });

    /* ---------------- ì‹œì‘ ---------------- */
    showView('titleScreen');
</script>
</body>
</html>
