<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>í”½ì…€ ì•„íŠ¸ ìŠ¤í…Œì´ì§€ ê²Œì„ â€” 4ë¶„í•  & í€´ì¦ˆ í™•ì¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
        .view { display: none; width: 100%; min-height: 100vh; }
        .view.active { display: flex; }
        canvas { image-rendering: pixelated; cursor: pointer; border: 2px solid #374151; background:#fff; }
        #paletteContainer { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-top:20px; max-width:800px; }
        .palette-button {
            width:50px; height:50px; border:2px solid #d1d5db; border-radius:8px; cursor:pointer;
            font-size:16px; font-weight:bold; display:flex; align-items:center; justify-content:center;
            transition: all .2s; color:#fff; text-shadow:0 0 2px #000,0 0 2px #000;
        }
        .palette-button.selected { border-color:#0ea5e9; transform:scale(1.1); box-shadow:0 0 15px rgba(14,165,233,.5); }
        .palette-button.locked { filter:grayscale(1); position:relative; }
        .palette-button.locked::after {
            content:"ğŸ”’"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
            font-size:20px; color:#fff; text-shadow:0 0 3px #000;
        }
        @keyframes shake { 0%{transform:translate(0,0)}25%{transform:translate(-3px,0)}50%{transform:translate(3px,0)}75%{transform:translate(-3px,0)}100%{transform:translate(0,0)} }
        .shake { animation:shake .3s; }
        .modal {
            display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%;
            background:rgba(0,0,0,.4); justify-content:center; align-items:center;
        }
        .modal-content {
            background:#fff; margin:auto; padding:24px; border:1px solid #888; border-radius:12px;
            width:90%; max-width:480px; text-align:center; box-shadow:0 4px 6px -1px rgb(0 0 0 / .1), 0 2px 4px -2px rgb(0 0 0 / .1);
        }
        .modal-button { background:#0ea5e9; color:#fff; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-size:16px; margin-top:16px; }
        #stageGrid .stage-card { border:2px solid #e5e7eb; border-radius:8px; overflow:hidden; cursor:pointer; transition:.2s; }
        #stageGrid .stage-card:hover { transform:scale(1.05); box-shadow:0 10px 15px -3px rgb(0 0 0 / .1), 0 4px 6px -4px rgb(0 0 0 / .1); }
        #stageGrid .stage-card img { image-rendering:pixelated; width:100%; height:auto; aspect-ratio:1/1; object-fit:contain; background:#f9fafb; }
        .quad-wrap { position:relative; }
        .quad-lock {
            position:absolute; inset:0; background:rgba(0,0,0,.45); color:#fff; display:flex; flex-direction:column;
            align-items:center; justify-content:center; gap:10px; font-weight:700; border-radius:6px;
            opacity:1; transition:opacity .2s;
        }
        .quad-lock.hidden { opacity:0; pointer-events:none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- 1) íƒ€ì´í‹€ -->
<div id="titleScreen" class="view active flex-col items-center justify-center p-4">
    <h1 class="text-5xl md:text-7xl font-bold text-gray-800 mb-8 animate-pulse">í”½ì…€ ì»¬ëŸ¬ë§</h1>
    <button id="startButton" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg hover:scale-105">
        ì‹œì‘í•˜ê¸°
    </button>
</div>

<!-- 2) ë¡œë¹„ -->
<div id="lobbyScreen" class="view flex-col items-center p-4 md:p-8">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 my-6">ìŠ¤í…Œì´ì§€ ì„ íƒ</h1>
    <div id="stageGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4 w-full max-w-6xl"></div>
</div>

<!-- 3) ê²Œì„ -->
<div id="gameScreen" class="view flex-col items-center justify-start p-4">
    <div class="w-full max-w-5xl flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
        <div class="flex items-center gap-2">
            <button id="backButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow">
                &larr; ë¡œë¹„ë¡œ
            </button>
            <span class="text-sm text-gray-500">ì§„í–‰ë¥ ì€ ìë™ ì €ì¥ ì—†ìŒ (ë°ëª¨)</span>
        </div>
        <h3 id="gameTitle" class="text-xl font-bold text-gray-800"></h3>
    </div>

    <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg w-full max-w-5xl flex flex-col items-center">
        <!-- ë¡œë”© -->
        <div id="loadingSpinner" class="text-center p-8">
            <svg class="animate-spin h-10 w-10 text-sky-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-3 text-gray-600">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</p>
        </div>

        <!-- 2Ã—2 ìº”ë²„ìŠ¤ -->
        <div id="quadGrid" class="hidden grid grid-cols-2 gap-2 w-full">
            <!-- ê° ì¹¸ì€ JSë¡œ ì±„ì›€ -->
        </div>

        <!-- íŒ”ë ˆíŠ¸ ê²Œì´íŠ¸ -->
        <div id="paintsGate" class="hidden w-full max-w-md mt-4 p-4 border rounded-lg bg-slate-50">
            <div class="flex items-center justify-between gap-2">
                <h4 class="font-bold text-gray-800">ë¬¼ê° ëª¨ìœ¼ê¸° í€´ì¦ˆ</h4>
                <button id="startPaintsQuizBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow">
                    ì‹œì‘
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-2">ì •ë‹µì„ ëª¨ë‘ ë§íˆë©´ íŒ”ë ˆíŠ¸ê°€ ì—´ë¦½ë‹ˆë‹¤.</p>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                <div id="paintsQuizBar" class="bg-emerald-500 h-2.5 rounded-full" style="width:0%; transition:width .3s;"></div>
            </div>
            <p id="paintsQuizText" class="text-xs text-gray-500 mt-1">0%</p>
        </div>

        <!-- íŒ”ë ˆíŠ¸ -->
        <div id="paletteContainer" class="hidden"></div>

        <!-- ì „ì²´ ì§„í–‰ë¥  -->
        <div id="progressContainer" class="w-full max-w-md mt-4 hidden">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progressBar" class="bg-sky-500 h-2.5 rounded-full" style="width:0%; transition:width .3s;"></div>
            </div>
            <p id="progressText" class="text-center text-sm text-gray-600 mt-1">0%</p>
        </div>
    </div>
</div>

<!-- ì•ˆë‚´ ëª¨ë‹¬ -->
<div id="messageModal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle" class="text-xl font-bold mb-2"></h2>
        <p id="modalMessage" class="text-gray-700"></p>
        <button id="modalCloseButton" class="modal-button">í™•ì¸</button>
    </div>
</div>

<!-- í€´ì¦ˆ ëª¨ë‹¬ -->
<div id="quizModal" class="modal">
    <div class="modal-content">
        <h2 id="quizTitle" class="text-xl font-bold mb-3">í€´ì¦ˆ</h2>
        <p id="quizQuestion" class="text-gray-800 mb-4"></p>
        <div id="quizChoices" class="flex flex-col gap-2"></div>
        <button id="quizCancel" class="modal-button bg-gray-400 hover:bg-gray-500 mt-4">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    /* ---------------- ê¸°ë³¸ ì„¤ì • ---------------- */
    const CELL_SCALE = 15;
    const IMAGE_BASE_URL = 'https://unluckyidiot16.github.io/assets-common/PixelArt/PNG/';
    const IMAGE_FILES = Array.from({length: 50}, (_, i) => `${i+1}.png`);

    const REQUIRED_PAINT_QUIZ = 5;   // ë¬¼ê° ëª¨ìœ¼ê¸° í€´ì¦ˆ ë¬¸í•­ ìˆ˜

    /* ---------------- DOM ---------------- */
    const allViews = document.querySelectorAll('.view');
    const titleScreen = document.getElementById('titleScreen');
    const lobbyScreen = document.getElementById('lobbyScreen');
    const gameScreen  = document.getElementById('gameScreen');
    const startButton = document.getElementById('startButton');
    const backButton  = document.getElementById('backButton');
    const stageGrid   = document.getElementById('stageGrid');

    const loadingSpinner   = document.getElementById('loadingSpinner');
    const quadGrid         = document.getElementById('quadGrid');
    const paletteContainer = document.getElementById('paletteContainer');
    const progressContainer= document.getElementById('progressContainer');
    const progressBar      = document.getElementById('progressBar');
    const progressText     = document.getElementById('progressText');
    const gameTitle        = document.getElementById('gameTitle');

    const paintsGate       = document.getElementById('paintsGate');
    const startPaintsQuizBtn = document.getElementById('startPaintsQuizBtn');
    const paintsQuizBar    = document.getElementById('paintsQuizBar');
    const paintsQuizText   = document.getElementById('paintsQuizText');

    const messageModal     = document.getElementById('messageModal');
    const modalTitle       = document.getElementById('modalTitle');
    const modalMessage     = document.getElementById('modalMessage');
    const modalCloseButton = document.getElementById('modalCloseButton');

    const quizModal        = document.getElementById('quizModal');
    const quizTitle        = document.getElementById('quizTitle');
    const quizQuestion     = document.getElementById('quizQuestion');
    const quizChoices      = document.getElementById('quizChoices');
    const quizCancel       = document.getElementById('quizCancel');

    /* ---------------- ìƒíƒœ ---------------- */
    let imgWidth, imgHeight;
    let palette = {};
    let paletteMap = [null];     // 1-based ìƒ‰ ì¸ë±ìŠ¤ â†’ rgba
    let numberGrid = [];         // [y][x] â†’ ìƒ‰ ì¸ë±ìŠ¤
    let completedGrid = [];      // [y][x] â†’ boolean
    let totalCells = 0;
    let completedCells = 0;

    let selectedColorIndex = 0;
    let paletteUnlocked = false;

    const quadrants = [];        // {id, canvas, ctx, x, y, w, h, unlocked}
    let nextQuadToUnlock = 0;    // 0..3

    let paintsQuizCount = 0;     // ë¬¼ê° í€´ì¦ˆ ì •ë‹µ ìˆ˜
    let currentQuiz = null;      // {type:'quad'|'paints', onResult:fn}

    /* ---------------- í™”ë©´ ì „í™˜ ---------------- */
    function showView(id) {
        allViews.forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    /* ---------------- ë¡œë¹„ ---------------- */
    function populateLobby() {
        stageGrid.innerHTML = '';
        IMAGE_FILES.forEach(filename => {
            const card = document.createElement('div');
            card.className = 'stage-card bg-white shadow rounded-lg';
            const img = document.createElement('img');
            img.src = IMAGE_BASE_URL + filename;
            img.alt = `Stage ${filename}`;
            img.loading = 'lazy';
            const title = document.createElement('p');
            title.className = 'text-center text-sm font-medium text-gray-700 p-2';
            title.textContent = `Stage ${filename.split('.')[0]}`;
            card.appendChild(img);
            card.appendChild(title);
            card.addEventListener('click', () => startGame(filename));
            stageGrid.appendChild(card);
        });
    }

    /* ---------------- ê²Œì„ ì‹œì‘ ---------------- */
    function startGame(filename) {
        showView('gameScreen');
        gameTitle.textContent = `Stage ${filename.split('.')[0]}`;

        // UI ì´ˆê¸°í™”
        loadingSpinner.style.display = 'block';
        quadGrid.classList.add('hidden');
        paintsGate.classList.add('hidden');
        paletteContainer.classList.add('hidden');
        progressContainer.classList.add('hidden');
        paletteContainer.innerHTML = '';
        progressBar.style.width = '0%';
        progressText.textContent = '0%';

        // ìƒíƒœ ì´ˆê¸°í™”
        palette = {};
        paletteMap = [null];
        numberGrid = [];
        completedGrid = [];
        totalCells = 0;
        completedCells = 0;
        selectedColorIndex = 0;
        paletteUnlocked = false;

        quadrants.length = 0;
        nextQuadToUnlock = 0;
        paintsQuizCount = 0;
        paintsQuizBar.style.width = '0%';
        paintsQuizText.textContent = '0%';

        // 4ë¶„í•  ë˜í¼ ë‹¤ì‹œ êµ¬ì„±
        quadGrid.innerHTML = '';
        for (let i=0;i<4;i++){
            const wrap = document.createElement('div');
            wrap.className = 'quad-wrap rounded-md overflow-hidden';
            const c = document.createElement('canvas');
            c.id = `canvasQ${i}`;
            wrap.appendChild(c);

            const lock = document.createElement('div');
            lock.className = 'quad-lock';
            lock.innerHTML = `
      <div class="text-2xl">ğŸ”’ ìº”ë²„ìŠ¤ ${i+1}</div>
      <button class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow">í€´ì¦ˆë¡œ í•´ê¸ˆ</button>
    `;
            lock.querySelector('button').addEventListener('click', ()=> {
                if (i===nextQuadToUnlock) {
                    openQuiz('quad', i);
                } else {
                    showModal('ìˆœì„œ ì•ˆë‚´', `ìº”ë²„ìŠ¤ ${nextQuadToUnlock+1}ë¶€í„° ì°¨ë¡€ëŒ€ë¡œ í•´ê¸ˆí•˜ì„¸ìš”.`);
                }
            });
            wrap.appendChild(lock);
            quadGrid.appendChild(wrap);

            quadrants.push({ id:i, wrap, canvas:c, ctx:c.getContext('2d'), x:0,y:0,w:0,h:0, unlocked:false, lockEl:lock });
        }

        loadImageAndProcess(filename);
    }

    /* ---------------- ëª¨ë‹¬/ì•Œë¦¼ ---------------- */
    modalCloseButton.onclick = () => messageModal.style.display = 'none';
    quizCancel.onclick = () => { quizModal.style.display='none'; currentQuiz=null; };

    function showModal(title, msg) {
        modalTitle.textContent = title;
        modalMessage.textContent = msg;
        messageModal.style.display = 'flex';
    }

    /* ---------------- ì´ë¯¸ì§€ ë¶„ì„ ---------------- */
    async function loadImageAndProcess(filename){
        try{
            const img = await new Promise((resolve,reject)=>{
                const im = new Image();
                im.crossOrigin = "Anonymous";
                im.src = IMAGE_BASE_URL + filename;
                im.onload = ()=>resolve(im);
                im.onerror = ()=>reject(new Error('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
            });
            imgWidth = img.width;
            imgHeight= img.height;

            const hc = document.createElement('canvas');
            hc.width = imgWidth; hc.height = imgHeight;
            const hctx = hc.getContext('2d');
            hctx.drawImage(img, 0, 0);
            const data = hctx.getImageData(0,0,imgWidth,imgHeight).data;

            let colorIndex = 1;
            for (let y=0;y<imgHeight;y++){
                numberGrid[y]=[];
                completedGrid[y]=[];
                for(let x=0;x<imgWidth;x++){
                    const i = (y*imgWidth+x)*4;
                    const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
                    if (a < 128) {
                        numberGrid[y][x] = 0;
                        completedGrid[y][x] = true;
                    } else {
                        const rgba = `rgba(${r},${g},${b},${a/255})`;
                        if (!palette[rgba]) {
                            palette[rgba] = colorIndex;
                            paletteMap[colorIndex] = rgba;
                            colorIndex++;
                        }
                        numberGrid[y][x] = palette[rgba];
                        completedGrid[y][x] = false;
                        totalCells++;
                    }
                }
            }

            // 4ë¶„í•  ì¢Œí‘œ ê³„ì‚°
            const halfW = Math.floor(imgWidth/2);
            const halfH = Math.floor(imgHeight/2);
            const quadsGeom = [
                {x:0,      y:0,      w:halfW,              h:halfH},
                {x:halfW,  y:0,      w:imgWidth-halfW,     h:halfH},
                {x:0,      y:halfH,  w:halfW,              h:imgHeight-halfH},
                {x:halfW,  y:halfH,  w:imgWidth-halfW,     h:imgHeight-halfH},
            ];
            quadsGeom.forEach((g,i)=>{
                const q = quadrants[i];
                q.x=g.x; q.y=g.y; q.w=g.w; q.h=g.h;
                q.canvas.width = g.w * CELL_SCALE;
                q.canvas.height= g.h * CELL_SCALE;
                q.ctx.imageSmoothingEnabled = false;

                // í´ë¦­ í•¸ë“¤ëŸ¬
                q.canvas.addEventListener('click', (e)=>{
                    if (!q.unlocked) {
                        showModal('ì ê¸ˆ', `ìº”ë²„ìŠ¤ ${i+1}ì€(ëŠ”) ì ê²¨ ìˆìŠµë‹ˆë‹¤. í€´ì¦ˆë¡œ í•´ê¸ˆí•˜ì„¸ìš”.`);
                        return;
                    }
                    if (!paletteUnlocked) {
                        showModal('ë¬¼ê°ì´ ì—†ì–´ìš”', 'ë¨¼ì € "ë¬¼ê° ëª¨ìœ¼ê¸° í€´ì¦ˆ"ë¥¼ ì™„ë£Œí•´ ëª¨ë“  ë¬¼ê°ì„ ëª¨ì•„ì•¼ ì¹ í•  ìˆ˜ ìˆì–´ìš”.');
                        return;
                    }
                    handleCanvasClickOnQuad(e, q);
                });
            });

            loadingSpinner.style.display = 'none';
            quadGrid.classList.remove('hidden');
            progressContainer.classList.remove('hidden');

            // ìµœì´ˆì—” 1ë²ˆ ìº”ë²„ìŠ¤ë§Œ í•´ê¸ˆ ê°€ëŠ¥
            updateAllQuads();

            // íŒ”ë ˆíŠ¸ëŠ” ë‚˜ì¤‘(ë¬¼ê° í€´ì¦ˆ ì™„ë£Œ) í‘œì‹œ
            buildPaletteUI(/*locked=*/true);
        } catch(err){
            console.error(err);
            showModal('ì˜¤ë¥˜', err.message + ' ë¡œë¹„ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
            showView('lobbyScreen');
        }
    }

    /* ---------------- íŒ”ë ˆíŠ¸ UI ---------------- */
    function buildPaletteUI(locked) {
        paletteContainer.innerHTML = '';
        const count = Math.max(1, paletteMap.length-1);
        for (let i=1;i<=count;i++){
            const color = paletteMap[i];
            const btn = document.createElement('button');
            btn.className = 'palette-button';
            btn.style.backgroundColor = color;
            btn.textContent = i;
            btn.dataset.colorIndex = i;

            if (locked) btn.classList.add('locked');

            btn.addEventListener('click', ()=>{
                if (!paletteUnlocked) {
                    showModal('ë¬¼ê° ì ê¸ˆ', 'ì•„ì§ ë¬¼ê°ì´ ëª¨ì´ì§€ ì•Šì•˜ì–´ìš”. 4ê°œ ìº”ë²„ìŠ¤ë¥¼ ëª¨ë‘ í•´ê¸ˆí•œ ë’¤ "ë¬¼ê° ëª¨ìœ¼ê¸° í€´ì¦ˆ"ë¥¼ ì™„ë£Œí•˜ì„¸ìš”.');
                    return;
                }
                selectedColorIndex = parseInt(btn.dataset.colorIndex,10);
                document.querySelectorAll('.palette-button').forEach(b=>b.classList.remove('selected'));
                btn.classList.add('selected');
            });

            paletteContainer.appendChild(btn);
        }
    }

    /* ---------------- ê·¸ë¦¬ê¸° ---------------- */
    function drawQuad(q){
        const ctx = q.ctx;
        ctx.clearRect(0,0,q.canvas.width,q.canvas.height);
        ctx.strokeStyle = '#eee';
        const fontSize = Math.max(6, Math.floor(CELL_SCALE * 0.5));
        ctx.font = `bold ${fontSize}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        for (let y=q.y; y<q.y+q.h; y++){
            for (let x=q.x; x<q.x+q.w; x++){
                const cellX = (x - q.x) * CELL_SCALE;
                const cellY = (y - q.y) * CELL_SCALE;
                const idx = numberGrid[y][x];

                if (completedGrid[y][x]) {
                    if (idx === 0) {
                        ctx.fillStyle = '#f0f0f0';
                    } else {
                        ctx.fillStyle = paletteMap[idx];
                    }
                    ctx.fillRect(cellX, cellY, CELL_SCALE, CELL_SCALE);
                } else {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(cellX, cellY, CELL_SCALE, CELL_SCALE);
                    ctx.strokeRect(cellX, cellY, CELL_SCALE, CELL_SCALE);
                    ctx.fillStyle = '#555';
                    ctx.fillText(idx, cellX + CELL_SCALE/2, cellY + CELL_SCALE/2 + 1);
                }
            }
        }
    }
    function updateAllQuads(){ quadrants.forEach(drawQuad); }
    function drawCellOnQuad(q, gx, gy){
        const ctx = q.ctx;
        const cellX = (gx - q.x) * CELL_SCALE;
        const cellY = (gy - q.y) * CELL_SCALE;
        const idx = numberGrid[gy][gx];
        ctx.fillStyle = (idx===0)?'#f0f0f0':paletteMap[idx];
        ctx.fillRect(cellX, cellY, CELL_SCALE, CELL_SCALE);
    }

    /* ---------------- ì…ë ¥ ì²˜ë¦¬ ---------------- */
    function handleCanvasClickOnQuad(e, q){
        const rect = q.canvas.getBoundingClientRect();
        const scaleX = q.canvas.width / rect.width;
        const scaleY = q.canvas.height/ rect.height;
        const lx = (e.clientX - rect.left) * scaleX;
        const ly = (e.clientY - rect.top)  * scaleY;
        const gx = q.x + Math.floor(lx / CELL_SCALE);
        const gy = q.y + Math.floor(ly / CELL_SCALE);

        if (gx<q.x || gx>=q.x+q.w || gy<q.y || gy>=q.y+q.h) return;

        const idx = numberGrid[gy][gx];
        if (completedGrid[gy][gx] || idx===0) return;

        if (selectedColorIndex===0) {
            showModal('ì•Œë¦¼', 'ë¨¼ì € ì•„ë˜ íŒ”ë ˆíŠ¸ì—ì„œ ìƒ‰ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        if (idx === selectedColorIndex) {
            completedGrid[gy][gx] = true;
            completedCells++;
            drawCellOnQuad(q, gx, gy);
            updateProgress();
            checkCompletion();
        } else {
            q.canvas.classList.add('shake'); setTimeout(()=>q.canvas.classList.remove('shake'),300);
            showModal('ì´ëŸ°!', 'ì„ íƒí•œ ìƒ‰ìƒì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
    }

    function updateProgress(){
        if (totalCells===0) return;
        const percent = Math.floor((completedCells/totalCells)*100);
        progressBar.style.width = `${percent}%`;
        progressText.textContent = `${percent}%`;
    }
    function checkCompletion(){
        if (completedCells === totalCells) {
            showModal('ì¶•í•˜í•©ë‹ˆë‹¤!', 'ëª¨ë“  í”½ì…€ì„ ì™„ë²½í•˜ê²Œ ìƒ‰ì¹ í–ˆìŠµë‹ˆë‹¤!');
            updateAllQuads();
        }
    }

    /* ---------------- í€´ì¦ˆ ---------------- */
    function openQuiz(type, quadIndex=null){
        // ê°„ë‹¨ ì‚°ìˆ˜ í€´ì¦ˆ ìƒì„±
        const q = generateMathQuestion();
        currentQuiz = {
            type,
            quadIndex,
            correct: q.correctIndex
        };

        quizTitle.textContent = (type==='quad') ? `ìº”ë²„ìŠ¤ ${quadIndex+1} í•´ê¸ˆ í€´ì¦ˆ` : 'ë¬¼ê° ëª¨ìœ¼ê¸° í€´ì¦ˆ';
        quizQuestion.textContent = q.question;
        quizChoices.innerHTML = '';
        q.choices.forEach((c, i)=>{
            const btn = document.createElement('button');
            btn.className = 'modal-button';
            btn.textContent = c;
            btn.addEventListener('click', ()=> submitQuiz(i));
            quizChoices.appendChild(btn);
        });
        quizModal.style.display = 'flex';
    }
    function submitQuiz(choiceIndex){
        const ok = (choiceIndex === currentQuiz.correct);
        const {type, quadIndex} = currentQuiz;
        quizModal.style.display = 'none';
        currentQuiz = null;

        if (!ok){
            showModal('ì˜¤ë‹µ', 'ì•„ì‰½ì§€ë§Œ ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!');
            return;
        }

        if (type==='quad'){
            // ì •ë‹µ â†’ í•´ë‹¹ ìº”ë²„ìŠ¤ í•´ê¸ˆ
            const q = quadrants[quadIndex];
            q.unlocked = true;
            q.lockEl.classList.add('hidden');

            // ë°”ë¡œ ìº”ë²„ìŠ¤ ë Œë”(ë²ˆí˜¸ ë³´ì´ê²Œ)
            drawQuad(q);

            nextQuadToUnlock++;
            if (nextQuadToUnlock>=4){
                // 4ê°œ ëª¨ë‘ í•´ê¸ˆ â†’ ë¬¼ê° í€´ì¦ˆ Gate í‘œì‹œ
                paintsGate.classList.remove('hidden');
                showModal('í•´ê¸ˆ ì™„ë£Œ', '4ê°œ ìº”ë²„ìŠ¤ë¥¼ ëª¨ë‘ ì—´ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë¬¼ê° ëª¨ìœ¼ê¸° í€´ì¦ˆë¥¼ ì™„ë£Œí•´ íŒ”ë ˆíŠ¸ë¥¼ ì—¬ì„¸ìš”.');
            } else {
                showModal('í•´ê¸ˆ ì„±ê³µ', `ìº”ë²„ìŠ¤ ${quadIndex+1}ì´(ê°€) ì—´ë ¸ìŠµë‹ˆë‹¤. ë‹¤ìŒì€ ìº”ë²„ìŠ¤ ${nextQuadToUnlock+1}!`);
            }
        } else if (type==='paints'){
            paintsQuizCount++;
            const pct = Math.floor((paintsQuizCount / REQUIRED_PAINT_QUIZ)*100);
            paintsQuizBar.style.width = `${pct}%`;
            paintsQuizText.textContent = `${pct}%`;

            if (paintsQuizCount >= REQUIRED_PAINT_QUIZ){
                paletteUnlocked = true;
                paintsGate.classList.add('hidden');
                paletteContainer.classList.remove('hidden');

                // íŒ”ë ˆíŠ¸ ì ê¸ˆ í•´ì œ ë°˜ì˜
                buildPaletteUI(false);
                showModal('íŒ”ë ˆíŠ¸ ì˜¤í”ˆ', 'ëª¨ë“  ë¬¼ê°ì„ ëª¨ì•˜ìŠµë‹ˆë‹¤! ì´ì œ ìƒ‰ì¹ ì„ ì‹œì‘í•˜ì„¸ìš”.');
            } else {
                showModal('ì •ë‹µ!', 'ì¢‹ì•„ìš”! ê³„ì† ì§„í–‰í•´ ë¬¼ê°ì„ ëª¨ë‘ ëª¨ì•„ë³´ì„¸ìš”.');
            }
        }
    }
    function generateMathQuestion(){
        // ì•„ì£¼ ê°„ë‹¨í•œ ì‚°ìˆ˜ (ë‚œë„ ë³´ì •)
        const a = Math.floor(Math.random()*9)+2;
        const b = Math.floor(Math.random()*9)+2;
        const ops = ['+','-','Ã—'];
        const op = ops[Math.floor(Math.random()*ops.length)];
        let ans = 0;
        if (op==='+') ans = a+b;
        else if (op==='-') ans = a-b;
        else ans = a*b;

        const choices = new Set([ans]);
        while (choices.size<4){
            const delta = Math.floor(Math.random()*6)-3;
            const fake = ans + delta + (delta===0?3:0);
            choices.add(fake);
        }
        const arr = Array.from(choices);
        // ì •ë‹µ ì„ê¸°
        for (let i=arr.length-1;i>0;i--){
            const j = Math.floor(Math.random()*(i+1));
            [arr[i],arr[j]]=[arr[j],arr[i]];
        }
        const correctIndex = arr.indexOf(ans);
        return { question:`${a} ${op} ${b} = ?`, choices:arr, correctIndex };
    }

    /* ---------------- ì´ë²¤íŠ¸ ---------------- */
    startButton.addEventListener('click', ()=> showView('lobbyScreen'));
    backButton.addEventListener('click', ()=> showView('lobbyScreen'));
    startPaintsQuizBtn.addEventListener('click', ()=>{
        if (nextQuadToUnlock<4){ showModal('ì•ˆë‚´','ë¨¼ì € 4ê°œ ìº”ë²„ìŠ¤ë¥¼ ëª¨ë‘ í•´ê¸ˆí•˜ì„¸ìš”.'); return; }
        openQuiz('paints');
    });

    /* ---------------- ì‹œì‘ ---------------- */
    populateLobby();
    showView('titleScreen');
</script>
</body>
</html>
