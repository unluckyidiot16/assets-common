<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문명 클리커 v14: 밸런스 조정</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; touch-action: manipulation; }
        .tab-btn.active { border-color: #4f46e5; background-color: #eef2ff; color: #4f46e5; }
        .tab-btn.dark.active { background-color: #3730a3; color: #e0e7ff; }
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-exit { animation: fadeOut 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .action-card, .upgrade-card { transition: transform 0.1s, box-shadow 0.1s; user-select: none; }
        .action-card.active, .upgrade-card:active { transform: scale(0.97); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card-image { image-rendering: -webkit-optimize-contrast; pointer-events: none; } /* For pixel art */
        .resource-icon { width: 1.125rem; height: 1.125rem; display: inline-block; vertical-align: middle; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center min-h-screen p-2">

<div class="w-full max-w-md mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-4 md:p-6 space-y-4">

    <div id="visual-container" class="bg-gray-200 dark:bg-gray-700 rounded-lg h-40 flex items-center justify-center overflow-hidden">
        <img id="era-image" src="" alt="Era Visual" class="w-auto h-full object-contain">
    </div>

    <div class="text-center">
        <h1 id="era-name" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400"></h1>
        <div class="mt-2 bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">
            <p id="resource-label" class="text-md font-semibold flex items-center justify-center"></p>
            <p id="resource-count" class="text-3xl font-bold"></p>
            <p id="rps-display" class="text-sm text-green-600 dark:text-green-400 font-medium">초당 +0</p>
        </div>
    </div>

    <div>
        <div class="flex justify-between mb-1"><span class="text-sm font-medium text-gray-700 dark:text-white">시대 발전</span><span id="progress-percentage" class="text-sm font-medium text-gray-700 dark:text-white">0%</span></div>
        <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-700"><div id="progress-bar" class="bg-indigo-600 h-3 rounded-full progress-bar-fill" style="width: 0%"></div></div>
    </div>

    <div id="great-person-container" class="h-14 bg-yellow-100 dark:bg-yellow-900 rounded-lg p-2 flex items-center space-x-2 overflow-x-auto">
        <span class="text-sm text-yellow-800 dark:text-yellow-200">영입된 위인 없음</span>
    </div>

    <div id="main-action-container"></div>

    <div class="flex border-b border-gray-200 dark:border-gray-700">
        <button id="tab-upgrades" class="tab-btn flex-1 p-2 font-semibold text-gray-500 border-b-2 border-transparent">강화</button>
        <button id="tab-buildings" class="tab-btn flex-1 p-2 font-semibold text-gray-500 border-b-2 border-transparent">건물</button>
    </div>

    <div id="cards-container" class="grid grid-cols-2 gap-3 max-h-48 overflow-y-auto p-1">
        <div id="upgrades-container" class="contents"></div>
        <div id="buildings-container" class="contents"></div>
    </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
    <div id="modal-content" class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 max-w-sm w-full text-center space-y-4">
        <div id="modal-image-container" class="hidden w-24 h-24 mx-auto rounded-full overflow-hidden border-4 border-yellow-400"><img id="modal-image" src="" class="w-full h-full object-cover"></div>
        <h2 id="modal-title" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400"></h2>
        <p id="modal-message" class="text-gray-600 dark:text-gray-300"></p>
        <button id="modal-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-green-300"></button>
    </div>
</div>

<script>
    const elements = {
        eraName: document.getElementById('era-name'), resourceLabel: document.getElementById('resource-label'), resourceCount: document.getElementById('resource-count'),
        rpsDisplay: document.getElementById('rps-display'), mainActionContainer: document.getElementById('main-action-container'),
        upgradesContainer: document.getElementById('upgrades-container'), buildingsContainer: document.getElementById('buildings-container'),
        progressBar: document.getElementById('progress-bar'), progressPercentage: document.getElementById('progress-percentage'),
        modal: document.getElementById('modal'), modalContent: document.getElementById('modal-content'), modalTitle: document.getElementById('modal-title'),
        modalMessage: document.getElementById('modal-message'), modalButton: document.getElementById('modal-button'),
        modalImageContainer: document.getElementById('modal-image-container'), modalImage: document.getElementById('modal-image'),
        eraImage: document.getElementById('era-image'), visualContainer: document.getElementById('visual-container'),
        greatPersonContainer: document.getElementById('great-person-container'), tabUpgrades: document.getElementById('tab-upgrades'),
        tabBuildings: document.getElementById('tab-buildings'), cardsContainer: document.getElementById('cards-container')
    };

    const eras = [
        {
            name: "석기 시대", eraImage: "https://unluckyidiot16.github.io/assets-common/CivilizationClicker/stoneage.png", resource: "식량", resourceImage: "https://unluckyidiot16.github.io/assets-common/CivilizationClicker/meat.png", goal: 500,
            clearMessage: "농경을 시작하며 식량을 안정적으로 확보했습니다. 이제 인류는 지식을 탐구하며 새로운 시대를 맞이합니다!",
            mainAction: { name: '수렵/채집', image: 'https://unluckyidiot16.github.io/assets-common/CivilizationClicker/hunt.png' },
            upgrades: [
                { id: 'stone_axe', name: "뗀석기", image: "https://unluckyidiot16.github.io/assets-common/CivilizationClicker/stoneaxe.png", cost: 30, effect: (s) => s.clickValue += 1, purchased: false },
                { id: 'fire', name: "불의 발견", image: "https://unluckyidiot16.github.io/assets-common/CivilizationClicker/fire.png", cost: 100, effect: (s) => s.clickValue += 3, purchased: false },
            ],
            buildings: [
                { id: 'hut', name: '움집', image: 'https://unluckyidiot16.github.io/assets-common/CivilizationClicker/hut.png', baseCost: 25, rps: 1, count: 0 },
                { id: 'tribe', name: '씨족 마을', image: 'https://unluckyidiot16.github.io/assets-common/CivilizationClicker/tribe.png', baseCost: 120, rps: 5, count: 0 }
            ],
            greatPeople: [
                { id: 'hunter', name: '위대한 사냥꾼', description: '클릭 가치가 영구적으로 +3 증가합니다.', image: 'https://unluckyidiot16.github.io/assets-common/CivilizationClicker/hunter.png', effect: (s) => s.clickValue += 3, acquired: false }
            ],
        },
        {
            name: "고대 농경 시대", eraImage: "https://unluckyidiot16.github.io/assets-common/CivilizationClicker/wait.png", resource: "지식", resourceImage: "https://unluckyidiot16.github.io/assets-common/CivilizationClicker/wait.png", goal: 2500,
            clearMessage: "문자와 법전은 문명을 비약적으로 발전시켰습니다. 이제 증기기관의 발명과 함께 산업의 시대가 열립니다!",
            mainAction: { name: '연구', image: 'https://unluckyidiot16.github.io/assets-common/CivilizationClicker/wait.png' },
            upgrades: [
                { id: 'writing', name: "문자 발명", image: 'https://unluckyidiot16.github.io/assets-common/CivilizationClicker/wait.png', cost: 200, effect: (s) => s.clickValue += 10, purchased: false },
                { id: 'irrigation', name: "관계 수로", image: 'https://unluckyidiot16.github.io/assets-common/CivilizationClicker/wait.png', cost: 800, effect: (s) => s.clickValue += 25, purchased: false },
            ],
            buildings: [
                { id: 'farm', name: '농장', image: 'https://unluckyidiot16.github.io/assets-common/CivilizationClicker/wait.png', baseCost: 150, rps: 12, count: 0 },
                { id: 'library', name: '도서관', image: 'https://unluckyidiot16.github.io/assets-common/CivilizationClicker/wait.png', baseCost: 1000, rps: 50, count: 0 }
            ],
            greatPeople: [ { id: 'archimedes', name: '아르키메데스', description: '모든 건물 생산량이 영구적으로 10% 증가합니다.', image: 'https://unluckyidiot16.github.io/assets-common/CivilizationClicker/wait.png', effect: (s) => s.globalMultiplier *= 1.10, acquired: false } ],
        },
    ];

    let gameState = {
        currentEraIndex: 0, resourceCount: 0, clickValue: 1, resourcesPerSecond: 0,
        globalMultiplier: 1.0, clickBonusFromRps: 0,
    };

    function updateUI() {
        const currentEra = eras[gameState.currentEraIndex];
        if (!currentEra) {
            document.body.innerHTML = `<div class="w-full max-w-md mx-auto text-center p-8"><h1 class="text-4xl font-bold text-indigo-500">문명 발전 완료!</h1></div>`;
            return;
        }

        elements.eraName.textContent = currentEra.name;
        elements.resourceLabel.innerHTML = `${currentEra.resource} <img src="${currentEra.resourceImage}" alt="${currentEra.resource}" class="resource-icon ml-1">`;
        elements.resourceCount.textContent = Math.floor(gameState.resourceCount).toLocaleString();
        elements.rpsDisplay.textContent = `초당 +${(gameState.resourcesPerSecond).toFixed(1)}`;
        elements.eraImage.src = currentEra.eraImage;

        const progress = Math.min((gameState.resourceCount / currentEra.goal) * 100, 100);
        elements.progressBar.style.width = `${progress}%`;
        elements.progressPercentage.textContent = `${Math.floor(progress)}%`;

        renderMainActionCard();
        renderCardList(elements.upgradesContainer, currentEra.upgrades, 'upgrade');
        renderCardList(elements.buildingsContainer, currentEra.buildings, 'building');
    }

    function renderMainActionCard() {
        const currentEra = eras[gameState.currentEraIndex];
        elements.mainActionContainer.innerHTML = `
                <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-lg flex items-center space-x-4 action-card">
                    <img src="${currentEra.mainAction.image}" class="w-16 h-16 rounded-md bg-indigo-500 p-1 card-image">
                    <div class="text-left">
                        <p class="text-xl font-bold">${currentEra.mainAction.name}</p>
                        <div class="text-lg flex items-center">+${gameState.clickValue.toLocaleString()} <img src="${currentEra.resourceImage}" class="resource-icon ml-1"></div>
                    </div>
                </button>
            `;
    }

    function renderCardList(container, items, type) {
        container.innerHTML = '';
        const currentEra = eras[gameState.currentEraIndex];
        items.forEach(item => {
            const isBuilding = type === 'building';
            const cost = isBuilding ? Math.floor(item.baseCost * Math.pow(1.15, item.count)) : item.cost;
            const isPurchased = !isBuilding && item.purchased;
            const canAfford = gameState.resourceCount >= cost;

            const card = document.createElement('div'); // Changed to div to handle events on the container
            card.className = `upgrade-card w-full p-2 rounded-lg flex flex-col justify-between h-36 ${
                isPurchased ? 'bg-green-100 dark:bg-green-900 ring-2 ring-green-400' :
                    canAfford ? 'bg-yellow-100 dark:bg-yellow-800' :
                        'bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400'
            }`;
            card.dataset.id = item.id;
            card.dataset.type = type;
            if (!isPurchased && canAfford) {
                card.classList.add('cursor-pointer', 'hover:bg-yellow-200', 'dark:hover:bg-yellow-700');
            } else {
                card.classList.add('cursor-not-allowed');
            }

            card.innerHTML = `
                    <div class="flex flex-col items-center flex-grow justify-center pt-2">
                        <img src="${item.image}" class="w-14 h-14 rounded-md card-image">
                        <p class="font-bold text-sm text-center mt-1">${item.name} ${isBuilding ? `<span class="font-normal">(Lv.${item.count})</span>` : ''}</p>
                    </div>
                    <div class="text-right">
                        ${isBuilding ? `<p class="text-xs text-green-700 dark:text-green-300 font-semibold">+${item.rps} RPS</p>` : ''}
                        <div class="font-bold text-md flex items-center justify-end">${cost.toLocaleString()} <img src="${currentEra.resourceImage}" class="resource-icon ml-1"></div>
                    </div>
                `;
            container.appendChild(card);
        });
    }

    function mainActionClick() {
        if (!eras[gameState.currentEraIndex]) return;
        gameState.resourceCount += gameState.clickValue;
        checkEraCompletion();
    }

    function buyUpgrade(upgrade) {
        if (gameState.resourceCount >= upgrade.cost && !upgrade.purchased) {
            gameState.resourceCount -= upgrade.cost;
            upgrade.effect(gameState);
            upgrade.purchased = true;
        }
    }

    function buyBuilding(building) {
        const cost = Math.floor(building.baseCost * Math.pow(1.15, building.count));
        if (gameState.resourceCount >= cost) {
            gameState.resourceCount -= cost;
            building.count++;
        }
    }

    function checkEraCompletion() {
        const currentEra = eras[gameState.currentEraIndex];
        if (currentEra && gameState.resourceCount >= currentEra.goal && !currentEra.completed) {
            currentEra.completed = true;
            showModal('era');
        }
    }

    function gameLoop() {
        let currentRPS = 0;
        const currentEra = eras[gameState.currentEraIndex];
        if (currentEra) {
            currentEra.buildings.forEach(building => {
                currentRPS += building.rps * building.count;
            });
            gameState.resourcesPerSecond = currentRPS * gameState.globalMultiplier;
            gameState.resourceCount += gameState.resourcesPerSecond / 10;
        } else {
            gameState.resourcesPerSecond = 0;
        }
        if (Math.random() < 1 / 600) spawnGreatPerson();
        checkEraCompletion();
        updateUI();
    }

    function init() {
        const performMainAction = (event) => {
            event.preventDefault();
            const actionCard = elements.mainActionContainer.querySelector('.action-card');
            if (actionCard) {
                mainActionClick();
                actionCard.classList.add('active');
                setTimeout(() => actionCard.classList.remove('active'), 100);
            }
        };

        elements.mainActionContainer.addEventListener('mousedown', performMainAction);
        elements.mainActionContainer.addEventListener('touchstart', performMainAction, { passive: false });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !e.repeat) {
                performMainAction(e);
            }
        });

        const handleCardPurchase = (e) => {
            const card = e.target.closest('.upgrade-card');
            if (card && !card.classList.contains('cursor-not-allowed')) {
                e.preventDefault();
                const cardId = card.dataset.id;
                const cardType = card.dataset.type;
                const currentEra = eras[gameState.currentEraIndex];

                if (cardType === 'upgrade') {
                    const upgrade = currentEra.upgrades.find(u => u.id === cardId);
                    if (upgrade) buyUpgrade(upgrade);
                } else if (cardType === 'building') {
                    const building = currentEra.buildings.find(b => b.id === cardId);
                    if (building) buyBuilding(building);
                }
            }
        };

        elements.cardsContainer.addEventListener('mousedown', handleCardPurchase);
        elements.cardsContainer.addEventListener('touchstart', handleCardPurchase, { passive: false });

        elements.tabUpgrades.addEventListener('click', () => {
            elements.tabUpgrades.classList.add('active');
            elements.tabBuildings.classList.remove('active');
            elements.upgradesContainer.style.display = 'contents';
            elements.buildingsContainer.style.display = 'none';
        });
        elements.tabBuildings.addEventListener('click', () => {
            elements.tabBuildings.classList.add('active');
            elements.tabUpgrades.classList.remove('active');
            elements.buildingsContainer.style.display = 'contents';
            elements.upgradesContainer.style.display = 'none';
        });

        elements.tabUpgrades.click();
        setInterval(gameLoop, 100);
        updateUI();
    }

    // --- Modal and Great Person Logic ---
    function showModal(type, data) {
        const currentEra = eras[gameState.currentEraIndex];
        elements.modalImageContainer.classList.add('hidden');
        if (type === 'era') {
            elements.modalTitle.textContent = "시대 발전!";
            elements.modalMessage.textContent = currentEra.clearMessage;
            elements.modalButton.textContent = "다음 시대로";
            elements.modalButton.onclick = () => advanceEra();
        } else if (type === 'greatPerson') {
            elements.modalTitle.textContent = "위인 등장!";
            elements.modalMessage.innerHTML = `<span class="font-bold">${data.name}</span> 합류!<br><small>"${data.description}"</small>`;
            elements.modalButton.textContent = "영입하기";
            elements.modalImageContainer.classList.remove('hidden');
            elements.modalImage.src = data.image;
            elements.modalButton.onclick = () => acquireGreatPerson(data);
        }
        elements.modal.classList.remove('hidden');
        elements.modalContent.classList.add('modal-enter');
    }
    function hideModal() {
        elements.modalContent.classList.add('modal-exit');
        elements.modalContent.addEventListener('animationend', () => {
            elements.modal.classList.add('hidden');
            elements.modalContent.classList.remove('modal-enter', 'modal-exit');
        }, { once: true });
    }
    function advanceEra() {
        hideModal();
        gameState.currentEraIndex++;
        const newEra = eras[gameState.currentEraIndex];
        if (newEra) {
            newEra.completed = false;
            gameState.resourceCount = 0;
            gameState.clickValue = 1;
        }
        updateUI();
    }
    function acquireGreatPerson(person) {
        person.effect(gameState);
        person.acquired = true;
        if (elements.greatPersonContainer.innerText.includes('없음')) elements.greatPersonContainer.innerHTML = '';
        const personIcon = document.createElement('img');
        personIcon.src = person.image;
        personIcon.className = 'w-10 h-10 rounded-full object-cover border-2 border-yellow-500';
        personIcon.title = `${person.name}: ${person.description}`;
        elements.greatPersonContainer.appendChild(personIcon);
        hideModal();
    }
    function spawnGreatPerson() {
        const currentEra = eras[gameState.currentEraIndex];
        if (!currentEra || !currentEra.greatPeople) return;
        const availablePeople = currentEra.greatPeople.filter(p => !p.acquired);
        if (availablePeople.length > 0) {
            const person = availablePeople[0];
            showModal('greatPerson', person);
        }
    }
    init();
</script>
</body>
</html>

